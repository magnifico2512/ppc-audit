<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon PPC Audit Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8f9fa;
            --bg-white: #ffffff;
            --bg-header: #c44e4e;
            --bg-header-dark: #a33d3d;
            --bg-subheader: #f3f4f6;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-white: #ffffff;
            --border-color: #e5e7eb;
            --border-dark: #d1d5db;
            --accent-green: #d4edda;
            --accent-green-text: #155724;
            --accent-red: #f8d7da;
            --accent-red-text: #721c24;
            --accent-orange: #fff3cd;
            --accent-orange-text: #856404;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            font-size: 13px;
        }

        .container { max-width: 1800px; margin: 0 auto; padding: 1.5rem; }

        .upload-section {
            background: var(--bg-white);
            border: 2px dashed var(--border-dark);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-section:hover { border-color: var(--bg-header); background: #fef2f2; }
        .upload-section.dragover { border-color: #22c55e; background: #f0fdf4; }
        .upload-section h2 { font-size: 1.1rem; margin-bottom: 0.5rem; }
        .upload-section p { color: var(--text-secondary); font-size: 0.875rem; }
        .file-input { display: none; }
        .upload-btn {
            background: var(--bg-header);
            color: white;
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }
        .upload-btn:hover { background: var(--bg-header-dark); }
        .file-info { display: none; background: #f0fdf4; border-radius: 6px; padding: 0.75rem 1rem; margin-top: 1rem; font-size: 0.875rem; color: #166534; }
        .file-info.visible { display: inline-block; }

        .input-section {
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .input-group { display: flex; align-items: center; gap: 0.75rem; }
        .input-group label { font-weight: 600; color: var(--bg-header); font-size: 0.8rem; white-space: nowrap; }
        .input-group input[type="text"] {
            background: var(--bg-subheader);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            width: 250px;
        }
        .input-group input[type="text"]:focus { outline: none; border-color: var(--bg-header); }
        .input-group small { color: var(--text-secondary); font-size: 0.7rem; }
        .input-group select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.8rem;
            background: var(--bg-white);
        }

        .tabs-container {
            display: flex;
            gap: 0.25rem;
            border-bottom: 2px solid var(--border-color);
            background: var(--bg-white);
            padding: 0.5rem 0.5rem 0;
            border-radius: 8px 8px 0 0;
            flex-wrap: wrap;
        }
        .tab-btn {
            background: var(--bg-subheader);
            border: 1px solid var(--border-color);
            border-bottom: none;
            color: var(--text-secondary);
            padding: 0.6rem 1.25rem;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.8rem;
            position: relative;
            top: 2px;
        }
        .tab-btn:hover { background: #e5e7eb; color: var(--text-primary); }
        .tab-btn.active {
            background: var(--bg-white);
            border-bottom: 2px solid var(--bg-white);
            color: var(--bg-header);
            font-weight: 600;
        }
        .tab-content {
            display: none;
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 1.5rem;
        }
        .tab-content.active { display: block; }

        .results-section { display: none; }
        .results-section.visible { display: block; }

        .section-title {
            background: var(--bg-header);
            color: var(--text-white);
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            font-size: 0.85rem;
            margin-top: 1.5rem;
            border-radius: 4px 4px 0 0;
        }
        .section-title:first-child { margin-top: 0; }

        .filter-bar {
            background: var(--bg-subheader);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 2rem;
            border: 1px solid var(--border-color);
            border-top: none;
            flex-wrap: wrap;
        }
        .filter-group { display: flex; align-items: center; gap: 0.5rem; }
        .filter-group label { font-weight: 600; color: var(--bg-header); font-size: 0.8rem; }
        .filter-group select { padding: 0.4rem 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.8rem; background: var(--bg-white); }
        .filter-group input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
        .filter-group input[type="number"] {
            width: 70px;
            padding: 0.4rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: 'JetBrains Mono', monospace;
        }
        .filter-group input[type="number"]:focus { outline: none; border-color: var(--bg-header); }
        .filter-group input[type="number"]::placeholder { color: #aaa; }
        .filter-group input[type="text"] {
            padding: 0.4rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .filter-group input[type="text"]:focus { outline: none; border-color: var(--bg-header); }
        .filter-group input[type="text"]::placeholder { color: #aaa; }

        .table-container {
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 4px 4px;
            overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        thead { background: var(--bg-subheader); }
        th {
            text-align: left;
            padding: 0.5rem 0.6rem;
            font-weight: 600;
            font-size: 0.7rem;
            white-space: nowrap;
            border-bottom: 1px solid var(--border-color);
        }
        td {
            padding: 0.4rem 0.6rem;
            border-bottom: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
        }
        td:first-child { font-family: 'Inter', sans-serif; font-weight: 500; }
        tr:hover { background: #fafafa; }
        tr.total-row { background: var(--bg-subheader); font-weight: 600; }
        tr.total-row td { border-top: 2px solid var(--border-dark); }

        th.header-group { background: var(--bg-header); color: white; text-align: center; font-size: 0.75rem; }
        th.header-sp { background: #3b82f6; color: white; }
        th.header-sb { background: #f59e0b; color: white; }
        th.header-total { background: #10b981; color: white; }

        .acos-good { background: var(--accent-green); color: var(--accent-green-text); padding: 0.1rem 0.3rem; border-radius: 2px; }
        .acos-warning { background: var(--accent-orange); color: var(--accent-orange-text); padding: 0.1rem 0.3rem; border-radius: 2px; }
        .acos-bad { background: var(--accent-red); color: var(--accent-red-text); padding: 0.1rem 0.3rem; border-radius: 2px; }
        .cell-green-1 { background: #c6efce; }
        .cell-green-2 { background: #a9e4b3; }
        .cell-green-3 { background: #85d492; }
        .cell-red-1 { background: #ffc7ce; }
        .cell-red-2 { background: #ff9999; }
        .cell-red-3 { background: #ff6666; color: white; }
        .cell-spend-high { background: #fff3cd; }
        .cell-spend-med { background: #d4edda; }
        .cpc-good { color: #166534; }
        .cpc-warning { color: #ca8a04; }
        .cpc-bad { color: #dc2626; }

        a.asin-link { color: #2563eb; text-decoration: none; font-size: 0.7rem; }
        a.asin-link:hover { text-decoration: underline; }

        .loading { display: none; text-align: center; padding: 2rem; }
        .loading.visible { display: block; }
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top-color: var(--bg-header);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 0.75rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-state { text-align: center; padding: 2rem; color: var(--text-secondary); background: var(--bg-white); border: 1px solid var(--border-color); border-top: none; }

        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .page-title { font-size: 1.5rem; font-weight: 700; }
        .page-subtitle { color: var(--text-secondary); font-size: 0.875rem; }

        .bracket-label { font-weight: 600; min-width: 25px; }
        .bracket-range { color: var(--text-secondary); }

        .search-term-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: 'Inter', sans-serif !important;
        }
        .search-term-cell:hover {
            white-space: normal;
            word-wrap: break-word;
        }

        .count-badge {
            background: #e5e7eb;
            color: #374151;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .expandable-cell {
            cursor: pointer;
            position: relative;
        }
        .expandable-cell:hover {
            background: #f0f0f0;
        }
        .expand-icon {
            font-size: 0.6rem;
            margin-left: 0.25rem;
            color: #666;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            left: 0;
            top: 100%;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 320px;
            max-width: 450px;
            max-height: 300px;
            overflow-y: auto;
            padding: 0.5rem;
            font-size: 0.7rem;
            white-space: normal;
        }
        .dropdown-content.show {
            display: block;
        }
        .dropdown-item {
            padding: 0.35rem 0.5rem;
            border-bottom: 1px solid #eee;
            font-family: 'Inter', sans-serif;
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        .dropdown-item-campaign {
            font-weight: 500;
            color: #1f2937;
        }
        .dropdown-item-target {
            color: #6b7280;
            font-size: 0.65rem;
            margin-top: 0.15rem;
        }
        .dropdown-header {
            font-weight: 600;
            color: var(--bg-header);
            padding: 0.25rem 0.5rem;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 0.25rem;
        }

        .coverage-cell {
            text-align: center;
            padding: 0.2rem !important;
            min-width: 32px;
            position: relative;
        }
        .coverage-yes {
            color: #22c55e;
            cursor: pointer;
        }
        .coverage-yes:hover {
            background: #dcfce7;
        }
        .coverage-no {
            color: #ef4444;
        }
        .coverage-icon {
            font-size: 0.85rem;
        }
        
        .expandable-cell {
            position: relative;
        }

        th.coverage-header {
            text-align: center;
            padding: 0.3rem 0.4rem !important;
            font-size: 0.65rem !important;
            min-width: 32px;
        }
        th.coverage-group {
            text-align: center;
            font-size: 0.7rem !important;
            padding: 0.3rem !important;
        }
        th.header-sp-cover { background: #3b82f6; color: white; }
        th.header-hsa-cover { background: #8b5cf6; color: white; }
        th.header-sbv-cover { background: #f59e0b; color: white; }

        .coverage-dropdown {
            position: absolute;
            left: 0;
            top: 100%;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 300px;
            max-height: 250px;
            overflow-y: auto;
            padding: 0.5rem;
            font-size: 0.7rem;
            text-align: left;
            white-space: normal;
        }
        
        /* Position dropdowns on right side of table to go left */
        td:nth-last-child(-n+5) .coverage-dropdown {
            left: auto;
            right: 0;
        }

        /* Placement Optimizer styles */
        .placement-header-tos { background: #3b82f6 !important; color: white !important; }
        .placement-header-pp { background: #8b5cf6 !important; color: white !important; }
        .placement-header-ros { background: #f59e0b !important; color: white !important; }
        
        .placement-cell {
            text-align: right;
            font-size: 0.68rem;
        }
        .placement-cell-tos { background: rgba(59, 130, 246, 0.05); }
        .placement-cell-pp { background: rgba(139, 92, 246, 0.05); }
        .placement-cell-ros { background: rgba(245, 158, 11, 0.05); }
        
        .bid-modifier {
            font-weight: 600;
            padding: 0.15rem 0.3rem;
            border-radius: 3px;
            font-size: 0.65rem;
        }
        .bid-modifier-positive { background: #dcfce7; color: #166534; }
        .bid-modifier-zero { background: #f3f4f6; color: #6b7280; }
        .bid-modifier-negative { background: #fee2e2; color: #991b1b; }
        
        .campaign-name-cell {
            max-width: 250px;
            min-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: 'Inter', sans-serif !important;
            font-size: 0.7rem;
        }
        .campaign-name-cell:hover {
            overflow: visible;
            white-space: normal;
            word-wrap: break-word;
            position: relative;
            z-index: 10;
            background: white;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
            padding: 4px;
            border-radius: 4px;
        }
        
        .bidding-strategy {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            white-space: nowrap;
        }
        .bidding-down { background: #dbeafe; color: #1e40af; }
        .bidding-up-down { background: #fef3c7; color: #92400e; }
        .bidding-fixed { background: #e5e7eb; color: #374151; }
        
        .spend-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin-top: 2px;
            overflow: hidden;
        }
        .spend-bar-fill {
            height: 100%;
            border-radius: 2px;
        }
        .spend-bar-fill-tos { background: #3b82f6; }
        .spend-bar-fill-pp { background: #8b5cf6; }
        .spend-bar-fill-ros { background: #f59e0b; }
        
        /* New Filter Dropdown Styles */
        .filter-dropdown {
            position: relative;
            display: inline-block;
        }
        .filter-trigger {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            min-width: 120px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }
        .filter-trigger:hover { border-color: #0ea5e9; }
        .filter-content {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 280px;
            max-height: 400px;
            overflow: hidden;
        }
        .filter-content.show { display: flex; flex-direction: column; }
        .filter-content-small { min-width: 160px; }
        .filter-search {
            margin: 0.75rem;
            padding: 0.6rem 0.75rem;
            border: 2px solid #0ea5e9;
            border-radius: 6px;
            font-size: 0.85rem;
            outline: none;
        }
        .filter-search:focus { border-color: #0284c7; }
        .filter-select-all {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .filter-select-all input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .filter-options {
            max-height: 250px;
            overflow-y: auto;
            padding: 0.5rem 0;
        }
        .filter-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.15s;
        }
        .filter-option:hover { background: #f1f5f9; }
        .filter-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .filter-option label {
            cursor: pointer;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .filter-option.hidden { display: none; }
        .filter-check {
            width: 20px;
            color: #0ea5e9;
            font-weight: bold;
        }
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
        }
        .filter-btn-clear {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .filter-btn-clear:hover { background: #f1f5f9; }
        .filter-btn-apply {
            flex: 1;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            background: #3b82f6;
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .filter-btn-apply:hover { background: #2563eb; }
        
        /* Targeting type badge */
        .targeting-badge {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            white-space: nowrap;
        }
        .targeting-kw { background: #dbeafe; color: #1e40af; }
        .targeting-asin { background: #f3e8ff; color: #7c3aed; }
        .targeting-auto { background: #dcfce7; color: #166534; }
        .targeting-mixed { background: #fef3c7; color: #92400e; }
        
        /* Portfolio cell */
        .portfolio-cell {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.7rem;
            color: #6b7280;
        }
        .portfolio-cell:hover {
            overflow: visible;
            white-space: normal;
        }

        .stats-summary {
            display: flex;
            gap: 1.5rem;
            padding: 0.75rem 1rem;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 4px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
        }
        .stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        .stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Collapsible Section Styles */
        .collapsible-section {
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }
        .collapsible-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        .collapsible-header:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46a1 100%);
        }
        .collapsible-icon {
            font-size: 0.75rem;
            transition: transform 0.2s;
        }
        .collapsible-icon.open {
            transform: rotate(90deg);
        }
        .collapsible-title {
            font-weight: 600;
            font-size: 0.85rem;
        }
        .collapsible-content {
            background: white;
        }
        .collapsible-content .table-container {
            border: none;
            border-radius: 0;
        }
        .match-type-badge {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            white-space: nowrap;
        }
        .match-auto { background: #dcfce7; color: #166534; }
        .match-category { background: #fef3c7; color: #92400e; }
        .match-asin { background: #f3e8ff; color: #7c3aed; }
        .match-exact { background: #dbeafe; color: #1e40af; }
        .match-phrase { background: #fce7f3; color: #9d174d; }
        .match-broad { background: #e0e7ff; color: #4338ca; }

        /* Actionable Insights Styles */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        @media (max-width: 1400px) {
            .insights-grid {
                grid-template-columns: 1fr;
            }
        }
        .insight-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        .insight-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        .insight-header h3 {
            font-size: 0.9rem;
            font-weight: 600;
            margin: 0;
        }
        .insight-filters {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .insight-filters label {
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            color: #cbd5e1;
        }
        .insight-filters input[type="number"] {
            width: 55px;
            padding: 0.25rem 0.4rem;
            border: 1px solid #475569;
            border-radius: 4px;
            font-size: 0.75rem;
            background: #1e293b;
            color: white;
            font-family: 'JetBrains Mono', monospace;
        }
        .insight-filters input[type="number"]:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .insight-apply-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        .insight-apply-btn:hover {
            background: #2563eb;
        }
        .insight-summary {
            background: #fef3c7;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            color: #92400e;
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .insight-summary.good {
            background: #dcfce7;
            color: #166534;
        }
        .insight-summary.bad {
            background: #fee2e2;
            color: #991b1b;
        }
        .insight-summary-item {
            display: flex;
            gap: 0.3rem;
        }
        .insight-summary-label {
            font-weight: 500;
        }
        .insight-summary-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        .insight-table-container {
            max-height: 350px;
            overflow-y: auto;
            overflow-x: auto;
        }
        .insight-table-container table {
            font-size: 0.7rem;
        }
        .insight-table-container th {
            position: sticky;
            top: 0;
            background: var(--bg-subheader);
            z-index: 1;
        }
        .insight-table-container td {
            padding: 0.35rem 0.5rem;
        }
        .insight-empty {
            padding: 1.5rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .insight-empty.good {
            background: #f0fdf4;
            color: #166534;
        }
        .search-term-text {
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: 'Inter', sans-serif !important;
        }
        .search-term-text:hover {
            white-space: normal;
            word-wrap: break-word;
        }
        .keyword-text {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: 'Inter', sans-serif !important;
        }
        .keyword-text:hover {
            white-space: normal;
            word-wrap: break-word;
        }
        
        /* Sortable column styles */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .sortable-header:hover {
            background: #e2e8f0;
        }
        .sort-icon {
            margin-left: 0.3rem;
            font-size: 0.65rem;
            color: #94a3b8;
        }
        .sort-icon.active {
            color: #3b82f6;
        }

        /* Impression Share Trends Styles */
        .is-upload-section {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            color: white;
            margin-bottom: 1.5rem;
        }
        .is-upload-section h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }
        .is-upload-section p {
            margin: 0 0 1rem 0;
            opacity: 0.8;
            font-size: 0.85rem;
        }
        .is-loading {
            text-align: center;
            padding: 3rem;
        }
        .is-summary-bar {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            font-size: 0.85rem;
        }
        .is-summary-item {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .is-summary-label {
            opacity: 0.7;
        }
        .is-summary-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        .is-filters {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .is-filters .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        .is-filters label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .is-filters input, .is-filters select {
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.75rem;
            min-width: 120px;
        }
        .filter-apply-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
        }
        .filter-apply-btn:hover {
            background: #2563eb;
        }
        .is-table-wrapper {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        .is-table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        .is-table-container table {
            font-size: 0.7rem;
            border-collapse: collapse;
            width: 100%;
        }
        .is-table-container th {
            position: sticky;
            top: 0;
            z-index: 2;
            white-space: nowrap;
        }
        .is-table-container td {
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .is-header-group {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            text-align: center;
            font-weight: 600;
            padding: 0.5rem;
            border-right: 2px solid #475569;
        }
        .is-header-date {
            background: var(--bg-subheader);
            font-size: 0.6rem;
            color: var(--text-secondary);
            text-align: center;
            padding: 0.3rem 0.4rem;
            white-space: nowrap;
        }
        .is-kpi-cell {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            padding: 0.3rem 0.4rem;
            white-space: nowrap;
        }
        .is-trend-cell {
            text-align: center;
            padding: 0.2rem;
        }
        .trend-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            font-size: 0.7rem;
        }
        .trend-badge.up {
            background: #dcfce7;
            color: #166534;
        }
        .trend-badge.down {
            background: #fee2e2;
            color: #991b1b;
        }
        .trend-badge.stable {
            background: #f3f4f6;
            color: #6b7280;
        }
        .is-search-term-cell {
            max-width: 180px;
            min-width: 120px;
        }
        .is-search-term-text {
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }
        .is-meta-text {
            font-size: 0.6rem;
            color: #6b7280;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
            margin-top: 2px;
        }
        .is-portfolio-text {
            color: #8b5cf6;
        }
        .trend-improving {
            color: #16a34a;
            font-weight: 600;
        }
        .trend-declining {
            color: #dc2626;
            font-weight: 600;
        }
        .trend-stable {
            color: #6b7280;
        }
        .mini-chart {
            display: flex;
            align-items: flex-end;
            gap: 1px;
            height: 20px;
            min-width: 45px;
        }
        .mini-bar {
            width: 3px;
            background: #3b82f6;
            border-radius: 1px 1px 0 0;
            min-height: 2px;
        }
        .mini-chart-container {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .mini-chart-container:hover {
            background: #f3f4f6;
        }
        .mini-chart-trend {
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        /* SQP Analysis Styles */
        .sqp-upload-section {
            background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 100%);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            color: white;
            margin-bottom: 1.5rem;
            border: 2px dashed transparent;
            transition: all 0.3s ease;
        }
        .sqp-upload-section.dragover {
            border-color: #a78bfa;
            background: linear-gradient(135deg, #5b21b6 0%, #8b5cf6 100%);
        }
        .sqp-upload-section h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }
        .sqp-upload-section p {
            margin: 0 0 1rem 0;
            opacity: 0.9;
            font-size: 0.85rem;
        }
        .sqp-loading {
            text-align: center;
            padding: 3rem;
        }
        .sqp-summary-bar {
            background: linear-gradient(135deg, #4c1d95 0%, #6d28d9 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            font-size: 0.85rem;
        }
        .sqp-filters {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .sqp-filters .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        .sqp-filters label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .sqp-filters input, .sqp-filters select {
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.75rem;
            min-width: 120px;
        }
        .sqp-table-wrapper {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        .sqp-table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        .sqp-table-container table {
            font-size: 0.7rem;
            border-collapse: collapse;
            width: 100%;
        }
        .sqp-table-container th {
            position: sticky;
            top: 0;
            z-index: 2;
            white-space: nowrap;
            padding: 0.4rem 0.5rem;
        }
        .sqp-table-container td {
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .sqp-header-group {
            background: linear-gradient(135deg, #4c1d95 0%, #6d28d9 100%) !important;
            color: white !important;
            text-align: center;
            font-weight: 600;
            padding: 0.5rem;
        }
        .sqp-table-container th.sqp-header-group {
            background: linear-gradient(135deg, #4c1d95 0%, #6d28d9 100%) !important;
        }
        .sqp-header-sp {
            background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%) !important;
            color: #ffffff !important;
            text-align: center;
            font-weight: 700;
            padding: 0.6rem;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            font-size: 0.85rem;
        }
        .sqp-table-container th.sqp-header-sp {
            background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%) !important;
        }
        .sqp-table-container th.sortable-header {
            background: var(--bg-subheader);
            cursor: pointer;
        }
        .sqp-table-container th.sortable-header:hover {
            background: #e5e7eb;
        }
        .sqp-search-term-cell {
            max-width: 200px;
            min-width: 150px;
        }
        .sqp-search-term-text {
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
        }
        .sqp-asin-text {
            font-size: 0.6rem;
            color: #7c3aed;
            font-family: 'JetBrains Mono', monospace;
        }
        .sqp-kpi-cell {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            padding: 0.3rem 0.4rem;
            white-space: nowrap;
        }
        .conv-delta-positive {
            background: #dcfce7;
            color: #166534;
            font-weight: 600;
        }
        .conv-delta-negative {
            background: #fee2e2;
            color: #991b1b;
            font-weight: 600;
        }
        .sqp-badge {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
        }
        .sqp-badge-matched {
            background: #dbeafe;
            color: #1e40af;
        }
        .sqp-badge-unmatched {
            background: #fef3c7;
            color: #92400e;
        }
        .sqp-sticky-col {
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
            border-right: 2px solid #e2e8f0;
        }
        .sqp-table-container thead .sqp-sticky-col {
            z-index: 3;
        }
        
        /* SQP Week Filter Styles */
        .sqp-week-filter-wrapper {
            position: relative;
            min-width: 180px;
        }
        .sqp-week-filter-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.75rem;
            background: white;
            cursor: pointer;
            user-select: none;
        }
        .sqp-week-filter-trigger:hover {
            border-color: #7c3aed;
        }
        .sqp-week-filter-arrow {
            font-size: 0.6rem;
            color: #666;
            transition: transform 0.2s;
        }
        .sqp-week-filter-wrapper.open .sqp-week-filter-arrow {
            transform: rotate(180deg);
        }
        .sqp-week-filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
            max-height: 350px;
            overflow: hidden;
            min-width: 280px;
        }
        .sqp-week-filter-wrapper.open .sqp-week-filter-dropdown {
            display: flex;
            flex-direction: column;
        }
        .sqp-week-filter-actions {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            background: #f8fafc;
            flex-shrink: 0;
        }
        .sqp-week-filter-actions button {
            flex: 1;
            padding: 0.3rem 0.5rem;
            font-size: 0.65rem;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sqp-week-filter-actions button:hover {
            background: #7c3aed;
            color: white;
            border-color: #7c3aed;
        }
        .sqp-week-filter-options {
            padding: 0.25rem 0;
            overflow-y: auto;
            max-height: 280px;
        }
        
        /* SQP ASIN Filter Styles */
        .sqp-asin-filter-wrapper {
            position: relative;
            min-width: 200px;
        }
        .sqp-asin-filter-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.75rem;
            background: white;
            cursor: pointer;
            user-select: none;
        }
        .sqp-asin-filter-trigger:hover {
            border-color: #7c3aed;
        }
        .sqp-asin-filter-arrow {
            font-size: 0.6rem;
            color: #666;
            transition: transform 0.2s;
        }
        .sqp-asin-filter-wrapper.open .sqp-asin-filter-arrow {
            transform: rotate(180deg);
        }
        .sqp-asin-filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
            max-height: 350px;
            overflow: hidden;
            min-width: 280px;
        }
        .sqp-asin-filter-wrapper.open .sqp-asin-filter-dropdown {
            display: flex;
            flex-direction: column;
        }
        .sqp-asin-filter-search {
            margin: 0.5rem;
            padding: 0.5rem 0.75rem;
            border: 2px solid #7c3aed;
            border-radius: 4px;
            font-size: 0.8rem;
            outline: none;
        }
        .sqp-asin-filter-search:focus {
            border-color: #6d28d9;
        }
        .sqp-asin-filter-actions {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            background: #f8fafc;
        }
        .sqp-asin-filter-actions button {
            flex: 1;
            padding: 0.3rem 0.5rem;
            font-size: 0.65rem;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sqp-asin-filter-actions button:hover {
            background: #7c3aed;
            color: white;
            border-color: #7c3aed;
        }
        .sqp-asin-filter-options {
            overflow-y: auto;
            max-height: 250px;
            padding: 0.25rem 0;
        }
        .sqp-asin-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
        }
        .sqp-asin-option:hover {
            background: #f3f4f6;
        }
        .sqp-asin-option.hidden {
            display: none;
        }
        .sqp-asin-option input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: #7c3aed;
        }
        .sqp-asin-link {
            color: #7c3aed;
            text-decoration: none;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
        }
        .sqp-asin-link:hover {
            text-decoration: underline;
            color: #6d28d9;
        }
        .sqp-sku-cell {
            font-size: 0.65rem;
            color: #059669;
            font-family: 'JetBrains Mono', monospace;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .sqp-week-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.75rem;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 0.8rem;
            border-bottom: 1px solid #f1f5f9;
        }
        .sqp-week-option:last-child {
            border-bottom: none;
        }
        .sqp-week-option:hover {
            background: #f3f4f6;
        }
        .sqp-week-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #7c3aed;
            flex-shrink: 0;
        }
        .sqp-week-option-label {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }
        .sqp-week-number {
            font-weight: 700;
            color: #7c3aed;
            font-size: 0.85rem;
            min-width: 40px;
        }
        .sqp-week-dates {
            font-size: 0.75rem;
            color: #374151;
            font-weight: 500;
        }
        
        .chart-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .chart-modal-overlay.show {
            display: flex;
        }
        .chart-modal {
            background: white;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            animation: modalSlideIn 0.2s ease-out;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .chart-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
        }
        .chart-modal-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .chart-modal-subtitle {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }
        .chart-modal-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .chart-modal-close:hover {
            background: rgba(255,255,255,0.2);
        }
        .chart-modal-body {
            padding: 1.5rem;
        }
        .chart-modal-stats {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .chart-modal-stat {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .chart-modal-stat-label {
            font-size: 0.7rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .chart-modal-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        .chart-modal-stat-trend {
            font-size: 0.75rem;
            font-weight: 600;
        }
        .chart-modal-stat-trend.up { color: #10b981; }
        .chart-modal-stat-trend.down { color: #ef4444; }
        .chart-modal-stat-trend.stable { color: #6b7280; }
        .sqp-rank-chart-cell {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.15s;
        }
        .sqp-rank-chart-cell:hover {
            background: rgba(8, 145, 178, 0.1);
        }
        .sqp-imp-share-cell {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.15s;
            cursor: pointer;
        }
        .sqp-imp-share-cell:hover {
            background: rgba(139, 92, 246, 0.1);
        }
        .chart-canvas-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .chart-canvas-container canvas {
            width: 100% !important;
            height: 100% !important;
        }
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1rem;
            font-size: 0.75rem;
        }
        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .chart-legend-color {
            width: 12px;
            height: 3px;
            border-radius: 2px;
        }
        
        .kpi-group-border {
            border-right: 2px solid #e2e8f0;
        }
        .is-sticky-col {
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
            border-right: 2px solid #e2e8f0;
        }
        .is-table-container thead .is-sticky-col {
            z-index: 3;
        }
        .value-change-positive {
            color: #16a34a;
        }
        .value-change-negative {
            color: #dc2626;
        }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .input-section { flex-direction: column; gap: 1rem; align-items: stretch; }
            .input-group { flex-direction: column; align-items: stretch; }
            .input-group input[type="text"] { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <div>
                <h1 class="page-title"> Amazon PPC Audit Tool</h1>
                <p class="page-subtitle">Upload your bulk file to generate a comprehensive ad performance report</p>
            </div>
        </div>

        <div class="upload-section" id="dropZone">
            <h2> Upload Amazon Bulk File</h2>
            <p>Drag and drop your XLSX bulk export file here, or click to browse</p>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
            <div class="file-info" id="fileInfo"></div>
        </div>

        <div class="input-section">
            <div class="input-group">
                <label> Own Brand Names</label>
                <input type="text" id="brandNames" placeholder="e.g., homerella, mybrand">
                <small>(comma-separated)</small>
            </div>
            <div class="input-group">
                <label> Own ASINs</label>
                <input type="text" id="ownAsins" placeholder="e.g., B0XXXXX, B0YYYYY">
                <small>(comma-separated)</small>
            </div>
            <div class="input-group">
                <label> Marketplace</label>
                <select id="marketplace">
                    <option value="de">Amazon.de</option>
                    <option value="com">Amazon.com</option>
                    <option value="co.uk">Amazon.co.uk</option>
                    <option value="fr">Amazon.fr</option>
                    <option value="it">Amazon.it</option>
                    <option value="es">Amazon.es</option>
                    <option value="nl">Amazon.nl</option>
                    <option value="ca">Amazon.ca</option>
                    <option value="com.mx">Amazon.com.mx</option>
                    <option value="co.jp">Amazon.co.jp</option>
                </select>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing your PPC data...</p>
        </div>

        <div class="results-section" id="results">
            <div class="tabs-container">
                <button class="tab-btn active" data-tab="ad-performance">Ad Performance</button>
                <button class="tab-btn" data-tab="search-terms-summary">SP Search Terms - Summary</button>
                <button class="tab-btn" data-tab="unique-search-terms">Unique Search Terms</button>
                <button class="tab-btn" data-tab="placement-optimizer">SP Placement Optimizer</button>
                <button class="tab-btn" data-tab="asin-performance">ASIN Level Performance</button>
                <button class="tab-btn" data-tab="actionable-insights"> Actionable Insights</button>
                <button class="tab-btn" data-tab="impression-share"> Impression Share Trends</button>
                <button class="tab-btn" data-tab="sqp-analysis"> SQP Analysis</button>
            </div>

            <div class="tab-content active" id="tab-ad-performance">
                <div class="section-title" style="margin-top: 0;">Ad Performance</div>
                <div class="table-container" id="overviewTable"></div>
                <div class="section-title">Performance by Match Type - Sponsored Products (SP)</div>
                <div class="table-container" id="spMatchTypeTable"></div>
                <div class="section-title">Performance by Match Type - Sponsored Brands (SB)</div>
                <div class="table-container" id="sbMatchTypeTable"></div>
                <div class="section-title">Branded / Non Branded</div>
                <div class="table-container" id="brandedTable"></div>
                <div class="section-title">AD Spend With 0 Sales</div>
                <div class="table-container" id="zeroSalesTable"></div>
            </div>

            <div class="tab-content" id="tab-search-terms-summary">
                <div class="section-title" style="margin-top: 0;">SP Search Terms - ACOS DISTRIBUTION</div>
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Type:</label>
                        <select id="stTypeFilter">
                            <option value="all">All</option>
                            <option value="keyword">Keyword</option>
                            <option value="asin">ASIN</option>
                            <option value="category">Category</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Exclude Branded:</label>
                        <input type="checkbox" id="stExcludeBranded">
                    </div>
                </div>
                <div class="table-container" id="acosDistributionTable"></div>
                <div class="section-title">SP Search Terms - CVR DISTRIBUTION</div>
                <div class="table-container" id="cvrDistributionTable"></div>
            </div>

            <div class="tab-content" id="tab-unique-search-terms">
                <div class="section-title" style="margin-top: 0;">SP Search Terms - Unique</div>
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Min Spend ():</label>
                        <input type="number" id="minSpendFilter" value="5" min="0" step="1">
                    </div>
                    <div class="filter-group">
                        <label>Min Clicks:</label>
                        <input type="number" id="minClicksFilter" value="0" min="0" step="1">
                    </div>
                    <div class="filter-group">
                        <label>Min ACOS (%):</label>
                        <input type="number" id="minAcosFilter" value="" min="0" max="1000" step="1" placeholder="0">
                    </div>
                    <div class="filter-group">
                        <label>Type:</label>
                        <select id="ustTypeFilter">
                            <option value="all">All</option>
                            <option value="keyword">Keyword</option>
                            <option value="asin">ASIN</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Exclude Branded:</label>
                        <input type="checkbox" id="ustExcludeBranded">
                    </div>
                    <div class="filter-group">
                        <label>Sales Filter:</label>
                        <select id="ustSalesFilter">
                            <option value="all">All</option>
                            <option value="with-sales">With Sales Only</option>
                            <option value="no-sales">No Sales Only</option>
                        </select>
                    </div>
                </div>
                <div id="uniqueSearchTermsStats" class="stats-summary" style="display: none;"></div>
                <div class="table-container" id="uniqueSearchTermsTable"></div>
            </div>

            <div class="tab-content" id="tab-placement-optimizer">
                <div class="section-title" style="margin-top: 0;">SP Placement Optimizer</div>
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Campaign:</label>
                        <div class="filter-dropdown" id="campaignFilterDropdown">
                            <div class="filter-trigger" id="campaignFilterTrigger">All Campaigns </div>
                            <div class="filter-content" id="campaignFilterContent">
                                <input type="text" class="filter-search" id="campaignFilterSearch" placeholder="Search...">
                                <div class="filter-select-all">
                                    <input type="checkbox" id="campaignSelectAll" onchange="toggleAllCampaigns(this.checked)">
                                    <label for="campaignSelectAll">Select All (<span id="campaignCount">0</span>)</label>
                                </div>
                                <div class="filter-options" id="campaignFilterOptions"></div>
                                <div class="filter-buttons">
                                    <button type="button" class="filter-btn-clear" onclick="clearCampaignFilter()">Clear</button>
                                    <button type="button" class="filter-btn-apply" onclick="applyCampaignFilter()">Apply</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Portfolio:</label>
                        <div class="filter-dropdown" id="portfolioFilterDropdown">
                            <div class="filter-trigger" id="portfolioFilterTrigger">All Portfolios </div>
                            <div class="filter-content" id="portfolioFilterContent">
                                <input type="text" class="filter-search" id="portfolioFilterSearch" placeholder="Search...">
                                <div class="filter-select-all">
                                    <input type="checkbox" id="portfolioSelectAll" onchange="toggleAllPortfolios(this.checked)">
                                    <label for="portfolioSelectAll">Select All (<span id="portfolioCount">0</span>)</label>
                                </div>
                                <div class="filter-options" id="portfolioFilterOptions"></div>
                                <div class="filter-buttons">
                                    <button type="button" class="filter-btn-clear" onclick="clearPortfolioFilter()">Clear</button>
                                    <button type="button" class="filter-btn-apply" onclick="applyPortfolioFilter()">Apply</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Targeting:</label>
                        <div class="filter-dropdown" id="targetingFilterDropdown">
                            <div class="filter-trigger" id="targetingFilterTrigger">All </div>
                            <div class="filter-content filter-content-small" id="targetingFilterContent">
                                <div class="filter-options">
                                    <div class="filter-option" onclick="selectTargetingFilter('all')">
                                        <span class="filter-check" id="targeting-check-all"></span> All
                                    </div>
                                    <div class="filter-option" onclick="selectTargetingFilter('kw')">
                                        <span class="filter-check" id="targeting-check-kw"></span> Keyword
                                    </div>
                                    <div class="filter-option" onclick="selectTargetingFilter('asin')">
                                        <span class="filter-check" id="targeting-check-asin"></span> ASIN/Product
                                    </div>
                                    <div class="filter-option" onclick="selectTargetingFilter('auto')">
                                        <span class="filter-check" id="targeting-check-auto"></span> Auto
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Bidding:</label>
                        <div class="filter-dropdown" id="biddingFilterDropdown">
                            <div class="filter-trigger" id="biddingFilterTrigger">All </div>
                            <div class="filter-content filter-content-small" id="biddingFilterContent">
                                <div class="filter-options">
                                    <div class="filter-option" onclick="selectBiddingFilter('all')">
                                        <span class="filter-check" id="bidding-check-all"></span> All
                                    </div>
                                    <div class="filter-option" onclick="selectBiddingFilter('dynamic-down')">
                                        <span class="filter-check" id="bidding-check-dynamic-down"></span> Dynamic - Down
                                    </div>
                                    <div class="filter-option" onclick="selectBiddingFilter('dynamic-up-down')">
                                        <span class="filter-check" id="bidding-check-dynamic-up-down"></span> Dynamic - Up/Down
                                    </div>
                                    <div class="filter-option" onclick="selectBiddingFilter('fixed')">
                                        <span class="filter-check" id="bidding-check-fixed"></span> Fixed
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Min Spend ():</label>
                        <input type="number" id="placementMinSpend" value="0" min="0" step="1">
                    </div>
                    <div class="filter-group">
                        <label>Col Width:</label>
                        <input type="range" id="campaignColWidth" min="150" max="600" value="250" style="width:80px;">
                        <span id="campaignColWidthValue" style="font-size:0.7rem;">250px</span>
                    </div>
                </div>
                <div id="placementStats" class="stats-summary" style="display: none;"></div>
                
                <!-- Collapsible Match Type Performance Section -->
                <div class="collapsible-section" id="matchTypeSection" style="display: none;">
                    <div class="collapsible-header" onclick="toggleMatchTypeSection()">
                        <span class="collapsible-icon" id="matchTypeIcon"></span>
                        <span class="collapsible-title">Performance by Match Type - Sponsored Products (SP)</span>
                    </div>
                    <div class="collapsible-content" id="matchTypeContent" style="display: none;">
                        <div class="table-container" id="matchTypeTable"></div>
                    </div>
                </div>
                
                <div class="table-container" id="placementOptimizerTable"></div>
            </div>

            <div class="tab-content" id="tab-asin-performance">
                <div class="section-title" style="margin-top: 0;">ASIN Level Performance</div>
                <div class="table-container" id="asinPerformanceTable"></div>
            </div>

            <div class="tab-content" id="tab-actionable-insights">
                <div class="insights-grid">
                    <!-- Search Terms with 0 Sales -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <h3> Search Terms with 0 Sales</h3>
                            <div class="insight-filters">
                                <label>Min Spend <input type="number" id="st0SalesMinSpend" value="10" min="0" step="1"></label>
                                <label>Max Orders<input type="number" id="st0SalesMaxOrders" value="0" min="0" step="1"></label>
                                <button class="insight-apply-btn" onclick="renderSearchTerms0Sales()">Apply</button>
                            </div>
                        </div>
                        <div class="insight-summary" id="st0SalesSummary"></div>
                        <div class="insight-table-container" id="st0SalesTable"></div>
                    </div>

                    <!-- Search Terms with High ACOS -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <h3> Search Terms with High ACOS</h3>
                            <div class="insight-filters">
                                <label>Min Spend <input type="number" id="stHighAcosMinSpend" value="10" min="0" step="1"></label>
                                <label>Min ACOS %<input type="number" id="stHighAcosMinAcos" value="50" min="0" step="1"></label>
                                <button class="insight-apply-btn" onclick="renderSearchTermsHighAcos()">Apply</button>
                            </div>
                        </div>
                        <div class="insight-summary" id="stHighAcosSummary"></div>
                        <div class="insight-table-container" id="stHighAcosTable"></div>
                    </div>

                    <!-- Performing Search Terms -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <h3> Performing Search Terms</h3>
                            <div class="insight-filters">
                                <label>Min CVR %<input type="number" id="stPerformingMinCvr" value="15" min="0" step="1"></label>
                                <label>Min Orders<input type="number" id="stPerformingMinOrders" value="5" min="0" step="1"></label>
                                <button class="insight-apply-btn" onclick="renderSearchTermsPerforming()">Apply</button>
                            </div>
                        </div>
                        <div class="insight-summary" id="stPerformingSummary"></div>
                        <div class="insight-table-container" id="stPerformingTable"></div>
                    </div>

                    <!-- Keywords with 0 Sales -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <h3> Keywords with 0 Sales</h3>
                            <div class="insight-filters">
                                <label>Min Spend <input type="number" id="kw0SalesMinSpend" value="10" min="0" step="1"></label>
                                <label>Max Orders<input type="number" id="kw0SalesMaxOrders" value="0" min="0" step="1"></label>
                                <button class="insight-apply-btn" onclick="renderKeywords0Sales()">Apply</button>
                            </div>
                        </div>
                        <div class="insight-summary" id="kw0SalesSummary"></div>
                        <div class="insight-table-container" id="kw0SalesTable"></div>
                    </div>

                    <!-- Keywords with High ACOS -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <h3> Keywords with High ACOS</h3>
                            <div class="insight-filters">
                                <label>Min Spend <input type="number" id="kwHighAcosMinSpend" value="10" min="0" step="1"></label>
                                <label>Min ACOS %<input type="number" id="kwHighAcosMinAcos" value="50" min="0" step="1"></label>
                                <button class="insight-apply-btn" onclick="renderKeywordsHighAcos()">Apply</button>
                            </div>
                        </div>
                        <div class="insight-summary" id="kwHighAcosSummary"></div>
                        <div class="insight-table-container" id="kwHighAcosTable"></div>
                    </div>

                    <!-- Performing Keywords -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <h3> Performing Keywords</h3>
                            <div class="insight-filters">
                                <label>Min CVR %<input type="number" id="kwPerformingMinCvr" value="15" min="0" step="1"></label>
                                <label>Min Orders<input type="number" id="kwPerformingMinOrders" value="5" min="0" step="1"></label>
                                <button class="insight-apply-btn" onclick="renderKeywordsPerforming()">Apply</button>
                            </div>
                        </div>
                        <div class="insight-summary" id="kwPerformingSummary"></div>
                        <div class="insight-table-container" id="kwPerformingTable"></div>
                    </div>

                    <!-- Campaigns with High ACOS -->
                    <div class="insight-card">
                        <div class="insight-header">
                            <h3> Campaigns with High ACOS</h3>
                            <div class="insight-filters">
                                <label>Min Spend <input type="number" id="campHighAcosMinSpend" value="150" min="0" step="1"></label>
                                <label>Min ACOS %<input type="number" id="campHighAcosMinAcos" value="80" min="0" step="1"></label>
                                <button class="insight-apply-btn" onclick="renderCampaignsHighAcos()">Apply</button>
                            </div>
                        </div>
                        <div class="insight-summary" id="campHighAcosSummary"></div>
                        <div class="insight-table-container" id="campHighAcosTable"></div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab-impression-share">
                <div class="section-title" style="margin-top: 0;"> Impression Share Trend Analysis</div>
                
                <div class="is-upload-section" id="isDropZone">
                    <h3> Upload Impression Share Report</h3>
                    <p>Upload your "Search term impression share report (daily)" CSV file</p>
                    <input type="file" id="isFileInput" class="file-input" accept=".csv">
                    <button class="upload-btn" onclick="document.getElementById('isFileInput').click()">Choose CSV File</button>
                    <div class="file-info" id="isFileInfo"></div>
                </div>

                <div class="is-loading" id="isLoading" style="display:none;">
                    <div class="spinner"></div>
                    <p>Analyzing impression share trends...</p>
                </div>

                <div class="is-results" id="isResults" style="display:none;">
                    <div class="is-summary-bar" id="isSummaryBar"></div>
                    
                    <div class="is-filters">
                        <div class="filter-group">
                            <label>Date From</label>
                            <input type="date" id="isDateFrom">
                        </div>
                        <div class="filter-group">
                            <label>Date To</label>
                            <input type="date" id="isDateTo">
                        </div>
                        <div class="filter-group">
                            <label>Min Total Spend </label>
                            <input type="number" id="isMinSpend" value="10" min="0" step="1">
                        </div>
                        <div class="filter-group">
                            <label>Portfolio</label>
                            <select id="isPortfolioFilter">
                                <option value="all">All Portfolios</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Campaign</label>
                            <select id="isCampaignFilter">
                                <option value="all">All Campaigns</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Trend Filter</label>
                            <select id="isTrendFilter">
                                <option value="all">All Trends</option>
                                <option value="improving"> Improving</option>
                                <option value="declining"> Declining</option>
                                <option value="stable"> Stable</option>
                            </select>
                        </div>
                        <button class="filter-apply-btn" onclick="renderImpressionShareTable()">Apply Filters</button>
                    </div>

                    <div class="is-table-wrapper">
                        <div class="is-table-container" id="isTableContainer"></div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab-sqp-analysis">
                <div class="section-title" style="margin-top: 0;"> Search Query Performance (SQP) Analysis</div>
                
                <div class="sqp-upload-section" id="sqpDropZone">
                    <h3> Upload SQP Report</h3>
                    <p>Upload your "Search Query Performance" CSV export from Brand Analytics</p>
                    <p style="font-size:0.75rem;opacity:0.7;margin-top:0.5rem;">Note: Bulk file must be uploaded first to map ASINs to search terms</p>
                    <input type="file" id="sqpFileInput" class="file-input" accept=".csv">
                    <button class="upload-btn" onclick="document.getElementById('sqpFileInput').click()">Choose CSV File</button>
                    <div class="file-info" id="sqpFileInfo"></div>
                </div>

                <div class="sqp-loading" id="sqpLoading" style="display:none;">
                    <div class="spinner"></div>
                    <p>Processing SQP data and matching with search terms...</p>
                </div>

                <div class="sqp-results" id="sqpResults" style="display:none;">
                    <div class="sqp-summary-bar" id="sqpSummaryBar"></div>
                    
                    <div class="sqp-filters">
                        <div class="filter-group">
                            <label>Weeks</label>
                            <div class="sqp-week-filter-wrapper">
                                <div class="sqp-week-filter-trigger" id="sqpWeekFilterTrigger">
                                    <span id="sqpWeekFilterLabel">All Weeks</span>
                                    <span class="sqp-week-filter-arrow"></span>
                                </div>
                                <div class="sqp-week-filter-dropdown" id="sqpWeekFilterDropdown">
                                    <div class="sqp-week-filter-actions">
                                        <button onclick="sqpSelectAllWeeks()">Select All</button>
                                        <button onclick="sqpDeselectAllWeeks()">Deselect All</button>
                                    </div>
                                    <div class="sqp-week-filter-options" id="sqpWeekFilterOptions"></div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label>ASIN</label>
                            <div class="sqp-asin-filter-wrapper" id="sqpAsinFilterWrapper">
                                <div class="sqp-asin-filter-trigger" id="sqpAsinFilterTrigger">
                                    <span id="sqpAsinFilterLabel">All ASINs</span>
                                    <span class="sqp-asin-filter-arrow"></span>
                                </div>
                                <div class="sqp-asin-filter-dropdown" id="sqpAsinFilterDropdown">
                                    <input type="text" class="sqp-asin-filter-search" id="sqpAsinFilterSearch" placeholder="Search ASINs...">
                                    <div class="sqp-asin-filter-actions">
                                        <button onclick="sqpSelectAllAsins()">Select All</button>
                                        <button onclick="sqpDeselectAllAsins()">Deselect All</button>
                                    </div>
                                    <div class="sqp-asin-filter-options" id="sqpAsinFilterOptions"></div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label>Min Query Volume</label>
                            <input type="number" id="sqpMinVolume" value="0" min="0" step="1">
                        </div>
                        <div class="filter-group">
                            <label>Min Spend </label>
                            <input type="number" id="sqpMinSpend" value="0" min="0" step="1">
                        </div>
                        <div class="filter-group">
                            <label>Conv Delta</label>
                            <select id="sqpConvDeltaFilter">
                                <option value="all">All</option>
                                <option value="positive"> Positive (Above Market)</option>
                                <option value="negative"> Negative (Below Market)</option>
                            </select>
                        </div>
                        <button class="filter-apply-btn" onclick="renderSqpTable()">Apply Filters</button>
                    </div>

                    <div class="sqp-table-wrapper">
                        <div class="sqp-table-container" id="sqpTableContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Detail Modal -->
    <div class="chart-modal-overlay" id="chartModal">
        <div class="chart-modal">
            <div class="chart-modal-header">
                <div>
                    <div class="chart-modal-title" id="chartModalTitle">Chart Details</div>
                    <div class="chart-modal-subtitle" id="chartModalSubtitle">Search Term Details</div>
                </div>
                <button class="chart-modal-close" onclick="closeChartModal()">&times;</button>
            </div>
            <div class="chart-modal-body">
                <div class="chart-modal-stats" id="chartModalStats"></div>
                <div class="chart-canvas-container">
                    <canvas id="chartModalCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let parsedData = { sp: [], sb: [], sd: [], searchTerms: [], placements: [], impressionShare: [] };
        let spRankMapping = new Map(); // SP rank mapping for SQP integration

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const brandNamesInput = document.getElementById('brandNames');
        const ownAsinsInput = document.getElementById('ownAsins');
        const marketplaceSelect = document.getElementById('marketplace');
        const stTypeFilter = document.getElementById('stTypeFilter');
        const stExcludeBranded = document.getElementById('stExcludeBranded');
        
        // Unique Search Terms filters
        const minSpendFilter = document.getElementById('minSpendFilter');
        const minClicksFilter = document.getElementById('minClicksFilter');
        const minAcosFilter = document.getElementById('minAcosFilter');
        const ustTypeFilter = document.getElementById('ustTypeFilter');
        const ustExcludeBranded = document.getElementById('ustExcludeBranded');
        const ustSalesFilter = document.getElementById('ustSalesFilter');
        
        // Placement Optimizer filters
        const placementMinSpend = document.getElementById('placementMinSpend');
        
        // Filter state
        let selectedCampaigns = new Set();
        let selectedPortfolios = new Set();
        let allCampaigns = [];
        let allPortfolios = [];
        let tempSelectedCampaigns = new Set();
        let tempSelectedPortfolios = new Set();
        let currentTargetingFilter = 'all';
        let currentBiddingFilter = 'all';
        
        // Filter dropdown elements
        const campaignFilterTrigger = document.getElementById('campaignFilterTrigger');
        const campaignFilterContent = document.getElementById('campaignFilterContent');
        const campaignFilterSearch = document.getElementById('campaignFilterSearch');
        const campaignFilterOptions = document.getElementById('campaignFilterOptions');
        
        const portfolioFilterTrigger = document.getElementById('portfolioFilterTrigger');
        const portfolioFilterContent = document.getElementById('portfolioFilterContent');
        const portfolioFilterSearch = document.getElementById('portfolioFilterSearch');
        const portfolioFilterOptions = document.getElementById('portfolioFilterOptions');
        
        const targetingFilterTrigger = document.getElementById('targetingFilterTrigger');
        const targetingFilterContent = document.getElementById('targetingFilterContent');
        
        const biddingFilterTrigger = document.getElementById('biddingFilterTrigger');
        const biddingFilterContent = document.getElementById('biddingFilterContent');

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', (e) => { if (e.target.files[0]) processFile(e.target.files[0]); });
        brandNamesInput.addEventListener('input', debounce(() => { if (parsedData.sp.length) renderAllTables(); }, 500));
        ownAsinsInput.addEventListener('input', debounce(() => { if (parsedData.sp.length) renderAllTables(); }, 500));
        marketplaceSelect.addEventListener('change', () => { if (parsedData.sp.length) renderAllTables(); });
        stTypeFilter.addEventListener('change', () => { if (parsedData.searchTerms.length) renderSearchTermsSummary(); });
        stExcludeBranded.addEventListener('change', () => { if (parsedData.searchTerms.length) renderSearchTermsSummary(); });
        
        // Unique Search Terms filter listeners
        minSpendFilter.addEventListener('input', debounce(() => { if (parsedData.searchTerms.length) renderUniqueSearchTerms(); }, 300));
        minClicksFilter.addEventListener('input', debounce(() => { if (parsedData.searchTerms.length) renderUniqueSearchTerms(); }, 300));
        minAcosFilter.addEventListener('input', debounce(() => { if (parsedData.searchTerms.length) renderUniqueSearchTerms(); }, 300));
        ustTypeFilter.addEventListener('change', () => { if (parsedData.searchTerms.length) renderUniqueSearchTerms(); });
        ustExcludeBranded.addEventListener('change', () => { if (parsedData.searchTerms.length) renderUniqueSearchTerms(); });
        ustSalesFilter.addEventListener('change', () => { if (parsedData.searchTerms.length) renderUniqueSearchTerms(); });
        
        // Placement Optimizer filter listeners
        placementMinSpend.addEventListener('input', debounce(() => { if (parsedData.sp.length) renderPlacementOptimizer(); }, 300));
        
        // Campaign filter dropdown
        campaignFilterTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            closeAllFilterDropdowns();
            tempSelectedCampaigns = new Set(selectedCampaigns);
            campaignFilterContent.classList.add('show');
            // Re-render options with current temp state
            document.querySelectorAll('#campaignFilterOptions input[type="checkbox"]').forEach(cb => {
                cb.checked = tempSelectedCampaigns.has(cb.value);
            });
            updateCampaignSelectAll();
        });
        
        campaignFilterSearch.addEventListener('input', () => {
            const searchVal = campaignFilterSearch.value.toLowerCase();
            document.querySelectorAll('#campaignFilterOptions .filter-option').forEach(opt => {
                const label = opt.querySelector('label').textContent.toLowerCase();
                opt.classList.toggle('hidden', !label.includes(searchVal));
            });
            // Update Select All checkbox to reflect visible items
            updateCampaignSelectAll();
        });
        
        // Portfolio filter dropdown
        portfolioFilterTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            closeAllFilterDropdowns();
            tempSelectedPortfolios = new Set(selectedPortfolios);
            portfolioFilterContent.classList.add('show');
            // Re-render options with current temp state
            document.querySelectorAll('#portfolioFilterOptions input[type="checkbox"]').forEach(cb => {
                cb.checked = tempSelectedPortfolios.has(cb.value);
            });
            updatePortfolioSelectAll();
        });
        
        portfolioFilterSearch.addEventListener('input', () => {
            const searchVal = portfolioFilterSearch.value.toLowerCase();
            document.querySelectorAll('#portfolioFilterOptions .filter-option').forEach(opt => {
                const label = opt.querySelector('label').textContent.toLowerCase();
                opt.classList.toggle('hidden', !label.includes(searchVal));
            });
            // Update Select All checkbox to reflect visible items
            updatePortfolioSelectAll();
        });
        
        // Targeting filter dropdown
        targetingFilterTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            closeAllFilterDropdowns();
            targetingFilterContent.classList.add('show');
        });
        
        // Bidding filter dropdown
        biddingFilterTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            closeAllFilterDropdowns();
            biddingFilterContent.classList.add('show');
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.filter-dropdown')) {
                closeAllFilterDropdowns();
            }
        });
        
        // Prevent closing when clicking inside dropdown content
        document.querySelectorAll('.filter-content').forEach(content => {
            content.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        });
        
        function closeAllFilterDropdowns() {
            document.querySelectorAll('.filter-content').forEach(el => el.classList.remove('show'));
        }
        
        // Campaign filter functions
        function toggleAllCampaigns(checked) {
            // Get only the visible (non-hidden) campaign options
            const visibleOptions = document.querySelectorAll('#campaignFilterOptions .filter-option:not(.hidden) input[type="checkbox"]');
            visibleOptions.forEach(cb => {
                if (checked) {
                    tempSelectedCampaigns.add(cb.value);
                } else {
                    tempSelectedCampaigns.delete(cb.value);
                }
            });
            updateCampaignCheckboxes();
        }
        
        function toggleCampaign(campaign, checked) {
            if (checked) {
                tempSelectedCampaigns.add(campaign);
            } else {
                tempSelectedCampaigns.delete(campaign);
            }
            updateCampaignSelectAll();
        }
        
        function updateCampaignCheckboxes() {
            document.querySelectorAll('#campaignFilterOptions input[type="checkbox"]').forEach(cb => {
                cb.checked = tempSelectedCampaigns.has(cb.value);
            });
            updateCampaignSelectAll();
        }
        
        function updateCampaignSelectAll() {
            const selectAll = document.getElementById('campaignSelectAll');
            const countSpan = document.getElementById('campaignCount');
            // Get only the visible (non-hidden) campaign options
            const visibleOptions = document.querySelectorAll('#campaignFilterOptions .filter-option:not(.hidden) input[type="checkbox"]');
            const visibleCampaigns = Array.from(visibleOptions).map(cb => cb.value);
            const selectedVisibleCount = visibleCampaigns.filter(c => tempSelectedCampaigns.has(c)).length;
            
            if (countSpan) {
                countSpan.textContent = visibleCampaigns.length;
            }
            
            if (selectAll) {
                selectAll.checked = selectedVisibleCount === visibleCampaigns.length && visibleCampaigns.length > 0;
                selectAll.indeterminate = selectedVisibleCount > 0 && selectedVisibleCount < visibleCampaigns.length;
            }
        }
        
        function clearCampaignFilter() {
            tempSelectedCampaigns.clear();
            updateCampaignCheckboxes();
        }
        
        function applyCampaignFilter() {
            selectedCampaigns = new Set(tempSelectedCampaigns);
            updateCampaignTriggerText();
            campaignFilterContent.classList.remove('show');
            renderPlacementOptimizer();
        }
        
        function updateCampaignTriggerText() {
            if (selectedCampaigns.size === 0 || selectedCampaigns.size === allCampaigns.length) {
                campaignFilterTrigger.textContent = 'All Campaigns ';
            } else if (selectedCampaigns.size === 1) {
                const name = [...selectedCampaigns][0];
                campaignFilterTrigger.textContent = (name.length > 20 ? name.substring(0, 20) + '...' : name) + ' ';
            } else {
                campaignFilterTrigger.textContent = selectedCampaigns.size + ' selected ';
            }
        }
        
        // Portfolio filter functions
        function toggleAllPortfolios(checked) {
            // Get only the visible (non-hidden) portfolio options
            const visibleOptions = document.querySelectorAll('#portfolioFilterOptions .filter-option:not(.hidden) input[type="checkbox"]');
            visibleOptions.forEach(cb => {
                if (checked) {
                    tempSelectedPortfolios.add(cb.value);
                } else {
                    tempSelectedPortfolios.delete(cb.value);
                }
            });
            updatePortfolioCheckboxes();
        }
        
        function togglePortfolio(portfolio, checked) {
            if (checked) {
                tempSelectedPortfolios.add(portfolio);
            } else {
                tempSelectedPortfolios.delete(portfolio);
            }
            updatePortfolioSelectAll();
        }
        
        function updatePortfolioCheckboxes() {
            document.querySelectorAll('#portfolioFilterOptions input[type="checkbox"]').forEach(cb => {
                cb.checked = tempSelectedPortfolios.has(cb.value);
            });
            updatePortfolioSelectAll();
        }
        
        function updatePortfolioSelectAll() {
            const selectAll = document.getElementById('portfolioSelectAll');
            const countSpan = document.getElementById('portfolioCount');
            // Get only the visible (non-hidden) portfolio options
            const visibleOptions = document.querySelectorAll('#portfolioFilterOptions .filter-option:not(.hidden) input[type="checkbox"]');
            const visiblePortfolios = Array.from(visibleOptions).map(cb => cb.value);
            const selectedVisibleCount = visiblePortfolios.filter(p => tempSelectedPortfolios.has(p)).length;
            
            if (countSpan) {
                countSpan.textContent = visiblePortfolios.length;
            }
            
            if (selectAll) {
                selectAll.checked = selectedVisibleCount === visiblePortfolios.length && visiblePortfolios.length > 0;
                selectAll.indeterminate = selectedVisibleCount > 0 && selectedVisibleCount < visiblePortfolios.length;
            }
        }
        
        function clearPortfolioFilter() {
            tempSelectedPortfolios.clear();
            updatePortfolioCheckboxes();
        }
        
        function applyPortfolioFilter() {
            selectedPortfolios = new Set(tempSelectedPortfolios);
            updatePortfolioTriggerText();
            portfolioFilterContent.classList.remove('show');
            renderPlacementOptimizer();
        }
        
        function updatePortfolioTriggerText() {
            if (selectedPortfolios.size === 0 || selectedPortfolios.size === allPortfolios.length) {
                portfolioFilterTrigger.textContent = 'All Portfolios ';
            } else if (selectedPortfolios.size === 1) {
                const name = [...selectedPortfolios][0];
                portfolioFilterTrigger.textContent = (name.length > 15 ? name.substring(0, 15) + '...' : name) + ' ';
            } else {
                portfolioFilterTrigger.textContent = selectedPortfolios.size + ' selected ';
            }
        }
        
        // Targeting filter
        function selectTargetingFilter(value) {
            currentTargetingFilter = value;
            document.querySelectorAll('[id^="targeting-check-"]').forEach(el => el.textContent = '');
            document.getElementById('targeting-check-' + value).textContent = '';
            const labels = { all: 'All', kw: 'Keyword', asin: 'ASIN/Product', auto: 'Auto' };
            targetingFilterTrigger.textContent = labels[value] + ' ';
            targetingFilterContent.classList.remove('show');
            renderPlacementOptimizer();
        }
        
        // Bidding filter
        function selectBiddingFilter(value) {
            currentBiddingFilter = value;
            document.querySelectorAll('[id^="bidding-check-"]').forEach(el => el.textContent = '');
            document.getElementById('bidding-check-' + value).textContent = '';
            const labels = { all: 'All', 'dynamic-down': 'Down Only', 'dynamic-up-down': 'Up/Down', fixed: 'Fixed' };
            biddingFilterTrigger.textContent = labels[value] + ' ';
            biddingFilterContent.classList.remove('show');
            renderPlacementOptimizer();
        }
        
        // Toggle Match Type Section
        function toggleMatchTypeSection() {
            const content = document.getElementById('matchTypeContent');
            const icon = document.getElementById('matchTypeIcon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.add('open');
            } else {
                content.style.display = 'none';
                icon.classList.remove('open');
            }
        }
        
        // Make functions global
        window.toggleAllCampaigns = toggleAllCampaigns;
        window.toggleCampaign = toggleCampaign;
        window.clearCampaignFilter = clearCampaignFilter;
        window.applyCampaignFilter = applyCampaignFilter;
        window.toggleAllPortfolios = toggleAllPortfolios;
        window.togglePortfolio = togglePortfolio;
        window.clearPortfolioFilter = clearPortfolioFilter;
        window.applyPortfolioFilter = applyPortfolioFilter;
        window.selectTargetingFilter = selectTargetingFilter;
        window.selectBiddingFilter = selectBiddingFilter;
        window.toggleMatchTypeSection = toggleMatchTypeSection;
        
        // Campaign column width slider
        const campaignColWidth = document.getElementById('campaignColWidth');
        const campaignColWidthValue = document.getElementById('campaignColWidthValue');
        campaignColWidth.addEventListener('input', () => {
            const width = campaignColWidth.value;
            campaignColWidthValue.textContent = width + 'px';
            document.querySelectorAll('.campaign-name-cell').forEach(cell => {
                cell.style.maxWidth = width + 'px';
                cell.style.minWidth = Math.min(150, parseInt(width)) + 'px';
            });
        });

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
            });
        });

        function debounce(func, wait) {
            let timeout;
            return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); };
        }

        function processFile(file) {
            if (!file.name.match(/\.xlsx?$/i)) { alert('Please upload an Excel file'); return; }
            fileInfo.textContent = ` ${file.name} (${formatFileSize(file.size)})`;
            fileInfo.classList.add('visible');
            loading.classList.add('visible');
            results.classList.remove('visible');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    parsedData.sp = parseSheet(workbook, 'Sponsored Products Campaigns');
                    parsedData.sb = parseSheet(workbook, 'Sponsored Brands campaigns');
                    parsedData.sd = parseSheet(workbook, 'Sponsored Display campaigns');
                    parsedData.searchTerms = parseSheet(workbook, 'SP Search Term Report');
                    parsedData.placements = parseSheet(workbook, 'SP Placement Report') || parseSheet(workbook, 'Placement Report') || [];
                    loading.classList.remove('visible');
                    results.classList.add('visible');
                    renderAllTables();
                    
                    // Build ASIN mapping for SQP Analysis
                    if (typeof buildAsinMapping === 'function') {
                        buildAsinMapping();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    loading.classList.remove('visible');
                    alert('Error parsing file.');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseSheet(workbook, sheetName) {
            const sheet = workbook.Sheets[sheetName];
            return sheet ? XLSX.utils.sheet_to_json(sheet, { defval: '' }) : [];
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function formatCurrency(v) { return '' + (parseFloat(v) || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
        function formatCurrencyDecimal(v) { return '' + (parseFloat(v) || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        function formatNumber(v) { return (parseFloat(v) || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
        function formatPercent(v, d = 0) { return ((parseFloat(v) || 0) * 100).toFixed(d) + '%'; }
        function formatCPC(v) { return '' + (parseFloat(v) || 0).toFixed(2); }
        function formatDecimal(v) { return (parseFloat(v) || 0).toFixed(2); }

        function getAcosClass(acos) {
            if (!acos || acos === 0) return '';
            if (acos < 0.15) return 'acos-good';
            if (acos < 0.25) return 'acos-warning';
            return 'acos-bad';
        }

        function getCpcClass(cpc) {
            if (!cpc || cpc === 0) return '';
            if (cpc < 0.5) return 'cpc-good';
            if (cpc < 1) return 'cpc-warning';
            return 'cpc-bad';
        }

        function getAcosColorClass(acos) {
            if (!acos || acos === 0) return '';
            if (acos <= 0.10) return 'cell-green-3';
            if (acos <= 0.20) return 'cell-green-2';
            if (acos <= 0.30) return 'cell-green-1';
            if (acos <= 0.40) return 'cell-red-1';
            if (acos <= 0.60) return 'cell-red-2';
            return 'cell-red-3';
        }

        function getSpendColorClass(p) {
            if (p >= 0.50) return 'cell-spend-high';
            if (p >= 0.10) return 'cell-spend-med';
            return '';
        }

        function getSalesColorClass(sales, total) {
            if (!total) return '';
            const p = sales / total;
            if (p >= 0.30) return 'cell-green-3';
            if (p >= 0.15) return 'cell-green-2';
            if (p >= 0.05) return 'cell-green-1';
            return '';
        }

        function getBrandNames() {
            const input = brandNamesInput.value.trim().toLowerCase();
            return input ? input.split(',').map(b => b.trim()).filter(b => b) : [];
        }

        function getOwnAsins() {
            const input = ownAsinsInput.value.trim().toUpperCase();
            return input ? input.split(',').map(a => a.trim()).filter(a => a) : [];
        }

        function isBranded(text, brandNames) {
            if (!text || !brandNames.length) return false;
            const lower = text.toLowerCase();
            return brandNames.some(b => lower.includes(b));
        }

        function isOwnAsin(row, ownAsins) {
            if (!ownAsins.length) return false;
            const asin = (row['ASIN (Informational only)'] || '').toUpperCase();
            const pt = (row['Product targeting expression'] || '').toUpperCase();
            return ownAsins.some(a => asin.includes(a) || pt.includes(a));
        }

        // Extract ASIN from Landing page URL (e.g., https://www.amazon.de/dp/B08L3WHZLY)
        function extractAsinFromUrl(url) {
            if (!url) return null;
            const match = url.match(/\/dp\/([A-Z0-9]{10})/i);
            return match ? match[1].toUpperCase() : null;
        }

        // Render Match Type Performance table with Placement breakdown
        function renderMatchTypePerformance(filteredCampaignList) {
            const matchTypeSection = document.getElementById('matchTypeSection');
            const matchTypeTable = document.getElementById('matchTypeTable');
            
            // Get the filtered campaign names
            const filteredCampaignNames = new Set(filteredCampaignList.map(c => c.name));
            
            // Initialize match type data with placement breakdown
            const matchTypeData = {
                'Auto': { 
                    spend: 0, sales: 0, clicks: 0, orders: 0, impressions: 0,
                    tos: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                    pp: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                    ros: { spend: 0, sales: 0, clicks: 0, orders: 0 }
                },
                'Category': { 
                    spend: 0, sales: 0, clicks: 0, orders: 0, impressions: 0,
                    tos: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                    pp: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                    ros: { spend: 0, sales: 0, clicks: 0, orders: 0 }
                },
                'ASIN': { 
                    spend: 0, sales: 0, clicks: 0, orders: 0, impressions: 0,
                    tos: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                    pp: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                    ros: { spend: 0, sales: 0, clicks: 0, orders: 0 }
                },
                'Exact': { 
                    spend: 0, sales: 0, clicks: 0, orders: 0, impressions: 0,
                    tos: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                    pp: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                    ros: { spend: 0, sales: 0, clicks: 0, orders: 0 }
                },
                'Phrase': { 
                    spend: 0, sales: 0, clicks: 0, orders: 0, impressions: 0,
                    tos: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                    pp: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                    ros: { spend: 0, sales: 0, clicks: 0, orders: 0 }
                },
                'Broad': { 
                    spend: 0, sales: 0, clicks: 0, orders: 0, impressions: 0,
                    tos: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                    pp: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                    ros: { spend: 0, sales: 0, clicks: 0, orders: 0 }
                }
            };
            
            // Build a map of campaign name -> targeting type (for distributing placement data)
            const campaignTargetingType = new Map();
            filteredCampaignList.forEach(c => {
                campaignTargetingType.set(c.name, c.targeting);
            });
            
            // Build a map of campaign name -> primary match type based on spend
            const campaignMatchTypeSpend = new Map();
            
            // Process Keywords (Exact, Phrase, Broad)
            const keywords = parsedData.sp.filter(r => {
                const entity = (r.Entity || '').toLowerCase();
                const campaignName = r['Campaign name (Informational only)'] || r['Campaign name'] || '';
                const matchType = (r['Match type'] || '').toLowerCase();
                return entity === 'keyword' && 
                       !matchType.includes('negative') && 
                       filteredCampaignNames.has(campaignName);
            });
            
            keywords.forEach(row => {
                const campaignName = row['Campaign name (Informational only)'] || row['Campaign name'] || '';
                const matchType = (row['Match type'] || '').toLowerCase();
                const spend = parseFloat(row.Spend) || 0;
                const sales = parseFloat(row.Sales) || 0;
                const clicks = parseFloat(row.Clicks) || 0;
                const orders = parseFloat(row.Orders) || 0;
                const impressions = parseFloat(row.Impressions) || 0;
                
                let typeKey = null;
                if (matchType === 'exact') typeKey = 'Exact';
                else if (matchType === 'phrase') typeKey = 'Phrase';
                else if (matchType === 'broad') typeKey = 'Broad';
                
                if (typeKey) {
                    matchTypeData[typeKey].spend += spend;
                    matchTypeData[typeKey].sales += sales;
                    matchTypeData[typeKey].clicks += clicks;
                    matchTypeData[typeKey].orders += orders;
                    matchTypeData[typeKey].impressions += impressions;
                    
                    // Track spend by campaign and match type for placement allocation
                    if (!campaignMatchTypeSpend.has(campaignName)) {
                        campaignMatchTypeSpend.set(campaignName, {});
                    }
                    const campSpend = campaignMatchTypeSpend.get(campaignName);
                    campSpend[typeKey] = (campSpend[typeKey] || 0) + spend;
                }
            });
            
            // Process Product Targeting (Category, ASIN)
            const productTargeting = parsedData.sp.filter(r => {
                const entity = (r.Entity || '').toLowerCase();
                const campaignName = r['Campaign name (Informational only)'] || r['Campaign name'] || '';
                return entity === 'product targeting' && filteredCampaignNames.has(campaignName);
            });
            
            productTargeting.forEach(row => {
                const campaignName = row['Campaign name (Informational only)'] || row['Campaign name'] || '';
                const expression = (row['Product targeting expression'] || '').toLowerCase();
                const spend = parseFloat(row.Spend) || 0;
                const sales = parseFloat(row.Sales) || 0;
                const clicks = parseFloat(row.Clicks) || 0;
                const orders = parseFloat(row.Orders) || 0;
                const impressions = parseFloat(row.Impressions) || 0;
                
                let typeKey = null;
                if (expression.includes('asin=') || expression.match(/^asin\s*=/i) || expression.match(/^"?asin/i)) {
                    typeKey = 'ASIN';
                } else if (expression.includes('category=') || expression.match(/^category/i)) {
                    typeKey = 'Category';
                } else {
                    typeKey = 'ASIN';
                }
                
                matchTypeData[typeKey].spend += spend;
                matchTypeData[typeKey].sales += sales;
                matchTypeData[typeKey].clicks += clicks;
                matchTypeData[typeKey].orders += orders;
                matchTypeData[typeKey].impressions += impressions;
                
                // Track spend by campaign and match type for placement allocation
                if (!campaignMatchTypeSpend.has(campaignName)) {
                    campaignMatchTypeSpend.set(campaignName, {});
                }
                const campSpend = campaignMatchTypeSpend.get(campaignName);
                campSpend[typeKey] = (campSpend[typeKey] || 0) + spend;
            });
            
            // Process Auto campaigns
            filteredCampaignList.forEach(campaign => {
                if (campaign.targeting === 'auto') {
                    matchTypeData['Auto'].spend += campaign.totalSpend;
                    matchTypeData['Auto'].sales += campaign.totalSales;
                    matchTypeData['Auto'].clicks += campaign.totalClicks;
                    matchTypeData['Auto'].orders += campaign.totalOrders;
                    matchTypeData['Auto'].impressions += campaign.totalImpressions;
                    
                    // Auto campaigns get their placement data directly
                    matchTypeData['Auto'].tos.spend += campaign.tos.spend;
                    matchTypeData['Auto'].tos.sales += campaign.tos.sales;
                    matchTypeData['Auto'].tos.clicks += campaign.tos.clicks;
                    matchTypeData['Auto'].tos.orders += campaign.tos.orders;
                    matchTypeData['Auto'].pp.spend += campaign.pp.spend;
                    matchTypeData['Auto'].pp.sales += campaign.pp.sales;
                    matchTypeData['Auto'].pp.clicks += campaign.pp.clicks;
                    matchTypeData['Auto'].pp.orders += campaign.pp.orders;
                    matchTypeData['Auto'].ros.spend += campaign.ros.spend;
                    matchTypeData['Auto'].ros.sales += campaign.ros.sales;
                    matchTypeData['Auto'].ros.clicks += campaign.ros.clicks;
                    matchTypeData['Auto'].ros.orders += campaign.ros.orders;
                    
                    // Track for allocation
                    if (!campaignMatchTypeSpend.has(campaign.name)) {
                        campaignMatchTypeSpend.set(campaign.name, {});
                    }
                    campaignMatchTypeSpend.get(campaign.name)['Auto'] = campaign.totalSpend;
                }
            });
            
            // Allocate placement data to match types for non-Auto campaigns
            // We proportionally allocate based on spend share within each campaign
            filteredCampaignList.forEach(campaign => {
                if (campaign.targeting === 'auto') return; // Already handled
                
                const campSpendByType = campaignMatchTypeSpend.get(campaign.name) || {};
                const totalCampSpend = Object.values(campSpendByType).reduce((a, b) => a + b, 0);
                
                if (totalCampSpend === 0) return;
                
                // Allocate placement data proportionally to each match type
                Object.keys(campSpendByType).forEach(typeKey => {
                    const proportion = campSpendByType[typeKey] / totalCampSpend;
                    
                    matchTypeData[typeKey].tos.spend += campaign.tos.spend * proportion;
                    matchTypeData[typeKey].tos.sales += campaign.tos.sales * proportion;
                    matchTypeData[typeKey].tos.clicks += campaign.tos.clicks * proportion;
                    matchTypeData[typeKey].tos.orders += campaign.tos.orders * proportion;
                    matchTypeData[typeKey].pp.spend += campaign.pp.spend * proportion;
                    matchTypeData[typeKey].pp.sales += campaign.pp.sales * proportion;
                    matchTypeData[typeKey].pp.clicks += campaign.pp.clicks * proportion;
                    matchTypeData[typeKey].pp.orders += campaign.pp.orders * proportion;
                    matchTypeData[typeKey].ros.spend += campaign.ros.spend * proportion;
                    matchTypeData[typeKey].ros.sales += campaign.ros.sales * proportion;
                    matchTypeData[typeKey].ros.clicks += campaign.ros.clicks * proportion;
                    matchTypeData[typeKey].ros.orders += campaign.ros.orders * proportion;
                });
            });
            
            // Calculate totals
            const totalSpend = Object.values(matchTypeData).reduce((sum, d) => sum + d.spend, 0);
            const totalSales = Object.values(matchTypeData).reduce((sum, d) => sum + d.sales, 0);
            const totalClicks = Object.values(matchTypeData).reduce((sum, d) => sum + d.clicks, 0);
            const totalOrders = Object.values(matchTypeData).reduce((sum, d) => sum + d.orders, 0);
            
            const totalTos = { spend: 0, sales: 0, clicks: 0, orders: 0 };
            const totalPp = { spend: 0, sales: 0, clicks: 0, orders: 0 };
            const totalRos = { spend: 0, sales: 0, clicks: 0, orders: 0 };
            
            Object.values(matchTypeData).forEach(d => {
                totalTos.spend += d.tos.spend;
                totalTos.sales += d.tos.sales;
                totalTos.clicks += d.tos.clicks;
                totalTos.orders += d.tos.orders;
                totalPp.spend += d.pp.spend;
                totalPp.sales += d.pp.sales;
                totalPp.clicks += d.pp.clicks;
                totalPp.orders += d.pp.orders;
                totalRos.spend += d.ros.spend;
                totalRos.sales += d.ros.sales;
                totalRos.clicks += d.ros.clicks;
                totalRos.orders += d.ros.orders;
            });
            
            // Check if we have placement data
            const hasPlacementData = totalTos.spend > 0 || totalPp.spend > 0 || totalRos.spend > 0;
            
            // Check if we have any data
            if (totalSpend === 0) {
                matchTypeSection.style.display = 'none';
                return;
            }
            
            matchTypeSection.style.display = 'block';
            
            // Define the order of match types
            const matchTypeOrder = ['Auto', 'Category', 'ASIN', 'Exact', 'Phrase', 'Broad'];
            const matchTypeBadgeClass = {
                'Auto': 'match-auto',
                'Category': 'match-category',
                'ASIN': 'match-asin',
                'Exact': 'match-exact',
                'Phrase': 'match-phrase',
                'Broad': 'match-broad'
            };
            
            // Helper to render placement metrics
            const renderPlacementCell = (data, totalTypeSpend) => {
                if (!hasPlacementData || data.spend === 0) return '-';
                const pct = totalTypeSpend > 0 ? (data.spend / totalTypeSpend * 100).toFixed(0) + '%' : '-';
                return pct;
            };
            
            const renderPlacementAcos = (data) => {
                if (!hasPlacementData || data.spend === 0) return '-';
                const acos = data.sales > 0 ? data.spend / data.sales : (data.spend > 0 ? Infinity : 0);
                if (acos === Infinity) return '';
                return formatPercent(acos, 0);
            };
            
            const getPlacementAcosClass = (data) => {
                if (!hasPlacementData || data.spend === 0) return '';
                const acos = data.sales > 0 ? data.spend / data.sales : 0;
                return getAcosColorClass(acos);
            };
            
            // Generate table HTML
            matchTypeTable.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2">Match Type</th>
                            <th rowspan="2">Ad Spend</th>
                            <th rowspan="2">Ad Sales</th>
                            <th rowspan="2">Clicks</th>
                            <th rowspan="2">Orders</th>
                            <th rowspan="2">CPC</th>
                            <th rowspan="2">CVR</th>
                            <th rowspan="2">ACOS</th>
                            <th rowspan="2">% Spend</th>
                            <th colspan="3" class="header-group" style="background:#6366f1;color:white;">Spend %</th>
                            <th colspan="3" class="header-group" style="background:#dc2626;color:white;">ACOS</th>
                            <th colspan="3" class="header-group" style="background:#16a34a;color:white;">CVR</th>
                        </tr>
                        <tr>
                            <th class="coverage-header">TOS</th>
                            <th class="coverage-header">PP</th>
                            <th class="coverage-header">ROS</th>
                            <th class="coverage-header">TOS</th>
                            <th class="coverage-header">PP</th>
                            <th class="coverage-header">ROS</th>
                            <th class="coverage-header">TOS</th>
                            <th class="coverage-header">PP</th>
                            <th class="coverage-header">ROS</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${matchTypeOrder.map(type => {
                            const data = matchTypeData[type];
                            if (data.spend === 0 && data.clicks === 0) return '';
                            
                            const cpc = data.clicks > 0 ? data.spend / data.clicks : 0;
                            const cvr = data.clicks > 0 ? data.orders / data.clicks : 0;
                            const acos = data.sales > 0 ? data.spend / data.sales : 0;
                            const spendPct = totalSpend > 0 ? data.spend / totalSpend : 0;
                            
                            const placementTotal = data.tos.spend + data.pp.spend + data.ros.spend;
                            
                            const tosCvr = data.tos.clicks > 0 ? data.tos.orders / data.tos.clicks : 0;
                            const ppCvr = data.pp.clicks > 0 ? data.pp.orders / data.pp.clicks : 0;
                            const rosCvr = data.ros.clicks > 0 ? data.ros.orders / data.ros.clicks : 0;
                            
                            return `<tr>
                                <td><span class="match-type-badge ${matchTypeBadgeClass[type]}">${type}</span></td>
                                <td>${formatCurrencyDecimal(data.spend)}</td>
                                <td>${formatCurrencyDecimal(data.sales)}</td>
                                <td>${formatNumber(data.clicks)}</td>
                                <td>${formatNumber(data.orders)}</td>
                                <td>${data.clicks > 0 ? formatCPC(cpc) : '-'}</td>
                                <td>${data.clicks > 0 ? formatPercent(cvr, 1) : '-'}</td>
                                <td class="${getAcosColorClass(acos)}">${data.sales > 0 ? formatPercent(acos, 1) : (data.spend > 0 ? '' : '-')}</td>
                                <td class="${getSpendColorClass(spendPct)}">${formatPercent(spendPct, 1)}</td>
                                <td class="placement-cell">${renderPlacementCell(data.tos, placementTotal)}</td>
                                <td class="placement-cell">${renderPlacementCell(data.pp, placementTotal)}</td>
                                <td class="placement-cell">${renderPlacementCell(data.ros, placementTotal)}</td>
                                <td class="placement-cell ${getPlacementAcosClass(data.tos)}">${renderPlacementAcos(data.tos)}</td>
                                <td class="placement-cell ${getPlacementAcosClass(data.pp)}">${renderPlacementAcos(data.pp)}</td>
                                <td class="placement-cell ${getPlacementAcosClass(data.ros)}">${renderPlacementAcos(data.ros)}</td>
                                <td class="placement-cell ${getCvrClass(tosCvr)}">${data.tos.clicks > 0 ? formatPercent(tosCvr, 0) : '-'}</td>
                                <td class="placement-cell ${getCvrClass(ppCvr)}">${data.pp.clicks > 0 ? formatPercent(ppCvr, 0) : '-'}</td>
                                <td class="placement-cell ${getCvrClass(rosCvr)}">${data.ros.clicks > 0 ? formatPercent(rosCvr, 0) : '-'}</td>
                            </tr>`;
                        }).filter(row => row !== '').join('')}
                        <tr class="total-row">
                            <td><strong>Total</strong></td>
                            <td><strong>${formatCurrencyDecimal(totalSpend)}</strong></td>
                            <td><strong>${formatCurrencyDecimal(totalSales)}</strong></td>
                            <td><strong>${formatNumber(totalClicks)}</strong></td>
                            <td><strong>${formatNumber(totalOrders)}</strong></td>
                            <td><strong>${totalClicks > 0 ? formatCPC(totalSpend / totalClicks) : '-'}</strong></td>
                            <td><strong>${totalClicks > 0 ? formatPercent(totalOrders / totalClicks, 1) : '-'}</strong></td>
                            <td class="${getAcosColorClass(totalSales > 0 ? totalSpend / totalSales : 0)}"><strong>${totalSales > 0 ? formatPercent(totalSpend / totalSales, 1) : '-'}</strong></td>
                            <td><strong>100.0%</strong></td>
                            <td class="placement-cell"><strong>${hasPlacementData && (totalTos.spend + totalPp.spend + totalRos.spend) > 0 ? formatPercent(totalTos.spend / (totalTos.spend + totalPp.spend + totalRos.spend), 0) : '-'}</strong></td>
                            <td class="placement-cell"><strong>${hasPlacementData && (totalTos.spend + totalPp.spend + totalRos.spend) > 0 ? formatPercent(totalPp.spend / (totalTos.spend + totalPp.spend + totalRos.spend), 0) : '-'}</strong></td>
                            <td class="placement-cell"><strong>${hasPlacementData && (totalTos.spend + totalPp.spend + totalRos.spend) > 0 ? formatPercent(totalRos.spend / (totalTos.spend + totalPp.spend + totalRos.spend), 0) : '-'}</strong></td>
                            <td class="placement-cell ${getAcosColorClass(totalTos.sales > 0 ? totalTos.spend / totalTos.sales : 0)}"><strong>${totalTos.sales > 0 ? formatPercent(totalTos.spend / totalTos.sales, 0) : '-'}</strong></td>
                            <td class="placement-cell ${getAcosColorClass(totalPp.sales > 0 ? totalPp.spend / totalPp.sales : 0)}"><strong>${totalPp.sales > 0 ? formatPercent(totalPp.spend / totalPp.sales, 0) : '-'}</strong></td>
                            <td class="placement-cell ${getAcosColorClass(totalRos.sales > 0 ? totalRos.spend / totalRos.sales : 0)}"><strong>${totalRos.sales > 0 ? formatPercent(totalRos.spend / totalRos.sales, 0) : '-'}</strong></td>
                            <td class="placement-cell ${getCvrClass(totalTos.clicks > 0 ? totalTos.orders / totalTos.clicks : 0)}"><strong>${totalTos.clicks > 0 ? formatPercent(totalTos.orders / totalTos.clicks, 0) : '-'}</strong></td>
                            <td class="placement-cell ${getCvrClass(totalPp.clicks > 0 ? totalPp.orders / totalPp.clicks : 0)}"><strong>${totalPp.clicks > 0 ? formatPercent(totalPp.orders / totalPp.clicks, 0) : '-'}</strong></td>
                            <td class="placement-cell ${getCvrClass(totalRos.clicks > 0 ? totalRos.orders / totalRos.clicks : 0)}"><strong>${totalRos.clicks > 0 ? formatPercent(totalRos.orders / totalRos.clicks, 0) : '-'}</strong></td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        function aggregateData(data, filterFn = () => true) {
            const filtered = data.filter(filterFn);
            return {
                count: filtered.length,
                spend: filtered.reduce((s, r) => s + (parseFloat(r.Spend) || 0), 0),
                sales: filtered.reduce((s, r) => s + (parseFloat(r.Sales) || 0), 0),
                clicks: filtered.reduce((s, r) => s + (parseFloat(r.Clicks) || 0), 0),
                orders: filtered.reduce((s, r) => s + (parseFloat(r.Orders) || 0), 0),
                impressions: filtered.reduce((s, r) => s + (parseFloat(r.Impressions) || 0), 0)
            };
        }

        function calcMetrics(agg) {
            return {
                ...agg,
                cpc: agg.clicks > 0 ? agg.spend / agg.clicks : 0,
                cvr: agg.clicks > 0 ? agg.orders / agg.clicks : 0,
                acos: agg.sales > 0 ? agg.spend / agg.sales : 0
            };
        }

        function renderAllTables() {
            renderOverviewTable();
            renderSPMatchTypeTable();
            renderSBMatchTypeTable();
            renderBrandedTable();
            renderZeroSalesTable();
            renderSearchTermsSummary();
            renderUniqueSearchTerms();
            renderPlacementOptimizer();
            renderAsinPerformanceTable();
            renderActionableInsights();
        }
        
        function renderActionableInsights() {
            renderSearchTerms0Sales();
            renderSearchTermsHighAcos();
            renderSearchTermsPerforming();
            renderKeywords0Sales();
            renderKeywordsHighAcos();
            renderKeywordsPerforming();
            renderCampaignsHighAcos();
        }

        function renderOverviewTable() {
            const spCampaigns = parsedData.sp.filter(r => r.Entity === 'Campaign');
            const sbCampaigns = parsedData.sb.filter(r => r.Entity === 'Campaign');
            const sdCampaigns = parsedData.sd.filter(r => r.Entity === 'Campaign');

            const spData = calcMetrics(aggregateData(spCampaigns));
            const sbHsaData = calcMetrics(aggregateData(sbCampaigns.filter(r => {
                const f = (r['Ad format'] || r['Ad format (Informational only)'] || '').toLowerCase();
                return !f.includes('video');
            })));
            const sbVideoData = calcMetrics(aggregateData(sbCampaigns.filter(r => {
                const f = (r['Ad format'] || r['Ad format (Informational only)'] || '').toLowerCase();
                return f.includes('video');
            })));
            const sdData = calcMetrics(aggregateData(sdCampaigns));

            let rows = [
                { name: 'SP', data: spData },
                { name: 'SB HSA', data: sbHsaData },
                { name: 'SB Video', data: sbVideoData },
                { name: 'SD', data: sdData }
            ].sort((a, b) => b.data.spend - a.data.spend);

            const total = {
                count: rows.reduce((s, r) => s + r.data.count, 0),
                spend: rows.reduce((s, r) => s + r.data.spend, 0),
                sales: rows.reduce((s, r) => s + r.data.sales, 0),
                clicks: rows.reduce((s, r) => s + r.data.clicks, 0),
                orders: rows.reduce((s, r) => s + r.data.orders, 0)
            };
            total.cpc = total.clicks > 0 ? total.spend / total.clicks : 0;
            total.cvr = total.clicks > 0 ? total.orders / total.clicks : 0;
            total.acos = total.sales > 0 ? total.spend / total.sales : 0;

            document.getElementById('overviewTable').innerHTML = `
                <table>
                    <thead><tr>
                        <th>Campaign Type</th><th># Campaigns</th><th>Ad Sales</th><th>Ad Spend</th><th>Ad Clicks</th><th>Ad Orders</th><th>CPC</th><th>CVR</th><th>ACOS</th><th>% Sales</th><th>% Spend</th>
                    </tr></thead>
                    <tbody>
                        ${rows.map(r => `<tr>
                            <td>${r.name}</td><td>${r.data.count}</td><td>${formatCurrency(r.data.sales)}</td><td>${formatCurrency(r.data.spend)}</td><td>${formatNumber(r.data.clicks)}</td><td>${formatNumber(r.data.orders)}</td>
                            <td class="${getCpcClass(r.data.cpc)}">${r.data.clicks > 0 ? formatCPC(r.data.cpc) : ''}</td><td>${r.data.clicks > 0 ? formatPercent(r.data.cvr) : ''}</td>
                            <td><span class="${getAcosClass(r.data.acos)}">${r.data.sales > 0 ? formatPercent(r.data.acos) : ''}</span></td>
                            <td>${total.sales > 0 ? (r.data.sales / total.sales * 100).toFixed(1) + '%' : '0.0%'}</td>
                            <td>${total.spend > 0 ? (r.data.spend / total.spend * 100).toFixed(1) + '%' : '0.0%'}</td>
                        </tr>`).join('')}
                        <tr class="total-row">
                            <td>Total</td><td>${total.count}</td><td>${formatCurrency(total.sales)}</td><td>${formatCurrency(total.spend)}</td><td>${formatNumber(total.clicks)}</td><td>${formatNumber(total.orders)}</td>
                            <td class="${getCpcClass(total.cpc)}">${formatCPC(total.cpc)}</td><td>${formatPercent(total.cvr)}</td>
                            <td><span class="${getAcosClass(total.acos)}">${formatPercent(total.acos)}</span></td><td>100.0%</td><td>100.0%</td>
                        </tr>
                    </tbody>
                </table>`;
        }

        function renderSPMatchTypeTable() {
            const spKw = parsedData.sp.filter(r => r.Entity === 'Keyword' && r['Match type'] && !r['Match type'].includes('Negative'));
            const spPT = parsedData.sp.filter(r => r.Entity === 'Product targeting');

            let rows = [
                { name: 'Auto', data: calcMetrics(aggregateData(spPT.filter(r => ['close-match', 'loose-match', 'substitutes', 'complements'].includes(r['Product targeting expression'])))) },
                { name: 'Category', data: calcMetrics(aggregateData(spPT.filter(r => (r['Product targeting expression'] || '').includes('category=')))) },
                { name: 'ASIN', data: calcMetrics(aggregateData(spPT.filter(r => (r['Product targeting expression'] || '').includes('asin=')))) },
                { name: 'Exact', data: calcMetrics(aggregateData(spKw.filter(r => r['Match type'] === 'Exact'))) },
                { name: 'Phrase', data: calcMetrics(aggregateData(spKw.filter(r => r['Match type'] === 'Phrase'))) },
                { name: 'Broad', data: calcMetrics(aggregateData(spKw.filter(r => r['Match type'] === 'Broad'))) },
                { name: 'Other', data: calcMetrics({ count: 0, spend: 0, sales: 0, clicks: 0, orders: 0, impressions: 0 }) }
            ].sort((a, b) => b.data.spend - a.data.spend);

            const total = rows.reduce((acc, r) => ({ count: acc.count + r.data.count, spend: acc.spend + r.data.spend, sales: acc.sales + r.data.sales, clicks: acc.clicks + r.data.clicks, orders: acc.orders + r.data.orders }), { count: 0, spend: 0, sales: 0, clicks: 0, orders: 0 });
            total.cpc = total.clicks > 0 ? total.spend / total.clicks : 0;
            total.cvr = total.clicks > 0 ? total.orders / total.clicks : 0;
            total.acos = total.sales > 0 ? total.spend / total.sales : 0;

            document.getElementById('spMatchTypeTable').innerHTML = renderMatchTable(rows, total);
        }

        function renderSBMatchTypeTable() {
            const sbKw = parsedData.sb.filter(r => r.Entity === 'Keyword');
            let rows = [
                { name: 'Category', data: calcMetrics(aggregateData(sbKw, r => r['Match type'] === 'Category')) },
                { name: 'ASIN', data: calcMetrics(aggregateData(sbKw, r => r['Match type'] === 'ASIN')) },
                { name: 'Exact', data: calcMetrics(aggregateData(sbKw, r => r['Match type'] === 'Exact')) },
                { name: 'Phrase', data: calcMetrics(aggregateData(sbKw, r => r['Match type'] === 'Phrase')) },
                { name: 'Broad', data: calcMetrics(aggregateData(sbKw, r => r['Match type'] === 'Broad')) },
                { name: 'Other', data: calcMetrics({ count: 0, spend: 0, sales: 0, clicks: 0, orders: 0, impressions: 0 }) }
            ].sort((a, b) => b.data.spend - a.data.spend);

            const total = rows.reduce((acc, r) => ({ count: acc.count + r.data.count, spend: acc.spend + r.data.spend, sales: acc.sales + r.data.sales, clicks: acc.clicks + r.data.clicks, orders: acc.orders + r.data.orders }), { count: 0, spend: 0, sales: 0, clicks: 0, orders: 0 });
            total.cpc = total.clicks > 0 ? total.spend / total.clicks : 0;
            total.cvr = total.clicks > 0 ? total.orders / total.clicks : 0;
            total.acos = total.sales > 0 ? total.spend / total.sales : 0;

            document.getElementById('sbMatchTypeTable').innerHTML = renderMatchTable(rows, total);
        }

        function renderMatchTable(rows, total) {
            return `<table>
                <thead><tr><th>Match Type</th><th># Targets</th><th>Ad Sales</th><th>Ad Spend</th><th>Ad Clicks</th><th>Ad Orders</th><th>CPC</th><th>CVR</th><th>ACOS</th><th>% Sales</th><th>% Spend</th></tr></thead>
                <tbody>
                    ${rows.map(r => `<tr>
                        <td>${r.name}</td><td>${r.data.count}</td><td>${formatCurrency(r.data.sales)}</td><td>${formatCurrency(r.data.spend)}</td><td>${formatNumber(r.data.clicks)}</td><td>${formatNumber(r.data.orders)}</td>
                        <td class="${getCpcClass(r.data.cpc)}">${r.data.clicks > 0 ? formatCPC(r.data.cpc) : ''}</td><td>${r.data.clicks > 0 ? formatPercent(r.data.cvr) : ''}</td>
                        <td><span class="${getAcosClass(r.data.acos)}">${r.data.sales > 0 ? formatPercent(r.data.acos) : ''}</span></td>
                        <td>${total.sales > 0 ? (r.data.sales / total.sales * 100).toFixed(1) + '%' : '0.0%'}</td>
                        <td>${total.spend > 0 ? (r.data.spend / total.spend * 100).toFixed(1) + '%' : '0.0%'}</td>
                    </tr>`).join('')}
                    <tr class="total-row">
                        <td>Total</td><td>${total.count}</td><td>${formatCurrency(total.sales)}</td><td>${formatCurrency(total.spend)}</td><td>${formatNumber(total.clicks)}</td><td>${formatNumber(total.orders)}</td>
                        <td class="${getCpcClass(total.cpc)}">${formatCPC(total.cpc)}</td><td>${formatPercent(total.cvr)}</td>
                        <td><span class="${getAcosClass(total.acos)}">${formatPercent(total.acos)}</span></td><td>100.0%</td><td>100.0%</td>
                    </tr>
                </tbody>
            </table>`;
        }

        function renderBrandedTable() {
            const brandNames = getBrandNames();
            const ownAsins = getOwnAsins();
            const spKw = parsedData.sp.filter(r => r.Entity === 'Keyword' && r['Match type'] && !r['Match type'].includes('Negative'));
            const spPT = parsedData.sp.filter(r => r.Entity === 'Product targeting' && (r['Product targeting expression'] || '').includes('asin='));
            const spCatPT = parsedData.sp.filter(r => r.Entity === 'Product targeting' && (r['Product targeting expression'] || '').includes('category='));

            const brandedASIN = calcMetrics(aggregateData(spPT, r => isOwnAsin(r, ownAsins)));
            const nonBrandedASIN = calcMetrics(aggregateData(spPT, r => !isOwnAsin(r, ownAsins)));
            const brandedKW = calcMetrics(aggregateData(spKw, r => isBranded(r['Keyword text'] || '', brandNames)));
            const nonBrandedKW = calcMetrics(aggregateData(spKw, r => !isBranded(r['Keyword text'] || '', brandNames)));
            const brandedCat = calcMetrics(aggregateData(spCatPT, r => isBranded(r['Product targeting expression'] || '', brandNames)));

            let rows = [
                { name: 'Branded ASIN', data: brandedASIN },
                { name: 'Non Branded ASIN', data: nonBrandedASIN },
                { name: 'Branded KW', data: brandedKW },
                { name: 'Non Branded KW', data: nonBrandedKW },
                { name: 'Branded Category', data: brandedCat }
            ].sort((a, b) => b.data.spend - a.data.spend);

            const totalBranded = {
                count: brandedASIN.count + brandedKW.count + brandedCat.count,
                spend: brandedASIN.spend + brandedKW.spend + brandedCat.spend,
                sales: brandedASIN.sales + brandedKW.sales + brandedCat.sales,
                clicks: brandedASIN.clicks + brandedKW.clicks + brandedCat.clicks,
                orders: brandedASIN.orders + brandedKW.orders + brandedCat.orders
            };
            totalBranded.cpc = totalBranded.clicks > 0 ? totalBranded.spend / totalBranded.clicks : 0;
            totalBranded.cvr = totalBranded.clicks > 0 ? totalBranded.orders / totalBranded.clicks : 0;
            totalBranded.acos = totalBranded.sales > 0 ? totalBranded.spend / totalBranded.sales : 0;

            const grandTotal = rows.reduce((acc, r) => ({ spend: acc.spend + r.data.spend, sales: acc.sales + r.data.sales }), { spend: 0, sales: 0 });

            if (!brandNames.length && !ownAsins.length) {
                document.getElementById('brandedTable').innerHTML = `<div class="empty-state"> Enter your brand names and/or own ASINs above to see branded vs non-branded analysis</div>`;
                return;
            }

            document.getElementById('brandedTable').innerHTML = `<table>
                <thead><tr><th>SP KW (no asin targeting)</th><th># Targets</th><th>Ad Sales</th><th>Ad Spend</th><th>Ad Clicks</th><th>Ad Orders</th><th>CPC</th><th>CVR</th><th>ACOS</th><th>% Sales</th><th>% Spend</th></tr></thead>
                <tbody>
                    ${rows.map(r => `<tr>
                        <td>${r.name}</td><td>${r.data.count}</td><td>${formatCurrency(r.data.sales)}</td><td>${formatCurrency(r.data.spend)}</td><td>${formatNumber(r.data.clicks)}</td><td>${formatNumber(r.data.orders)}</td>
                        <td class="${getCpcClass(r.data.cpc)}">${r.data.clicks > 0 ? formatCPC(r.data.cpc) : ''}</td><td>${r.data.clicks > 0 ? formatPercent(r.data.cvr) : ''}</td>
                        <td><span class="${getAcosClass(r.data.acos)}">${r.data.sales > 0 ? formatPercent(r.data.acos) : ''}</span></td>
                        <td>${grandTotal.sales > 0 ? (r.data.sales / grandTotal.sales * 100).toFixed(1) + '%' : '0.0%'}</td>
                        <td>${grandTotal.spend > 0 ? (r.data.spend / grandTotal.spend * 100).toFixed(1) + '%' : '0.0%'}</td>
                    </tr>`).join('')}
                    <tr class="total-row">
                        <td>Total Branded</td><td>${totalBranded.count}</td><td>${formatCurrency(totalBranded.sales)}</td><td>${formatCurrency(totalBranded.spend)}</td><td>${formatNumber(totalBranded.clicks)}</td><td>${formatNumber(totalBranded.orders)}</td>
                        <td class="${getCpcClass(totalBranded.cpc)}">${formatCPC(totalBranded.cpc)}</td><td>${formatPercent(totalBranded.cvr)}</td>
                        <td><span class="${getAcosClass(totalBranded.acos)}">${formatPercent(totalBranded.acos)}</span></td>
                        <td>${grandTotal.sales > 0 ? (totalBranded.sales / grandTotal.sales * 100).toFixed(1) + '%' : '0.0%'}</td>
                        <td>${grandTotal.spend > 0 ? (totalBranded.spend / grandTotal.spend * 100).toFixed(1) + '%' : '0.0%'}</td>
                    </tr>
                </tbody>
            </table>`;
        }

        function renderZeroSalesTable() {
            const spC = parsedData.sp.filter(r => r.Entity === 'Campaign' && parseFloat(r.Spend) > 0 && (!r.Sales || parseFloat(r.Sales) === 0));
            const sbC = parsedData.sb.filter(r => r.Entity === 'Campaign' && parseFloat(r.Spend) > 0 && (!r.Sales || parseFloat(r.Sales) === 0));
            const sdC = parsedData.sd.filter(r => r.Entity === 'Campaign' && parseFloat(r.Spend) > 0 && (!r.Sales || parseFloat(r.Sales) === 0));

            const spData = calcMetrics(aggregateData(spC));
            const sbData = calcMetrics(aggregateData(sbC));
            const sdData = calcMetrics(aggregateData(sdC));

            let rows = [{ name: 'SP', data: spData }, { name: 'SB', data: sbData }, { name: 'SD', data: sdData }].sort((a, b) => b.data.spend - a.data.spend);
            const total = { count: spData.count + sbData.count + sdData.count, spend: spData.spend + sbData.spend + sdData.spend, clicks: spData.clicks + sbData.clicks + sdData.clicks };
            total.cpc = total.clicks > 0 ? total.spend / total.clicks : 0;

            const allC = [...parsedData.sp.filter(r => r.Entity === 'Campaign'), ...parsedData.sb.filter(r => r.Entity === 'Campaign'), ...parsedData.sd.filter(r => r.Entity === 'Campaign')];
            const totalOverallSpend = allC.reduce((s, r) => s + (parseFloat(r.Spend) || 0), 0);

            document.getElementById('zeroSalesTable').innerHTML = `<table>
                <thead><tr><th>Campaign Type</th><th># Targets</th><th>Ad Sales</th><th>Ad Spend</th><th>Ad Clicks</th><th>Ad Orders</th><th>CPC</th><th>CVR</th><th>ACOS</th><th>% Sales</th><th>% Spend</th></tr></thead>
                <tbody>
                    ${rows.map(r => `<tr>
                        <td>${r.name}</td><td>${r.data.count}</td><td>0</td><td>${formatCurrency(r.data.spend)}</td><td>${formatNumber(r.data.clicks)}</td><td>0</td>
                        <td class="${getCpcClass(r.data.cpc)}">${r.data.clicks > 0 ? formatCPC(r.data.cpc) : ''}</td><td>0%</td><td>0.0%</td><td>0.0%</td>
                        <td><span class="${r.data.spend > 0 ? 'acos-bad' : ''}">${totalOverallSpend > 0 ? (r.data.spend / totalOverallSpend * 100).toFixed(1) + '%' : '0.0%'}</span></td>
                    </tr>`).join('')}
                    <tr class="total-row">
                        <td>Total</td><td>${total.count}</td><td>0</td><td>${formatCurrency(total.spend)}</td><td>${formatNumber(total.clicks)}</td><td>0</td>
                        <td class="${getCpcClass(total.cpc)}">${formatCPC(total.cpc)}</td><td>0%</td><td>0.0%</td><td>0.0%</td>
                        <td><span class="acos-bad">${totalOverallSpend > 0 ? (total.spend / totalOverallSpend * 100).toFixed(1) + '%' : '0.0%'}</span></td>
                    </tr>
                </tbody>
            </table>`;
        }

        function renderSearchTermsSummary() {
            const typeFilter = stTypeFilter.value;
            const excludeBranded = stExcludeBranded.checked;
            const brandNames = getBrandNames();

            let searchTerms = parsedData.searchTerms.filter(row => {
                if (typeFilter !== 'all') {
                    const pt = (row['Product targeting expression'] || '').toLowerCase();
                    if (typeFilter === 'keyword' && (pt.includes('asin') || pt.includes('category'))) return false;
                    if (typeFilter === 'asin' && !pt.includes('asin')) return false;
                    if (typeFilter === 'category' && !pt.includes('category')) return false;
                }
                if (excludeBranded && brandNames.length && isBranded(row['Customer search term'] || '', brandNames)) return false;
                return true;
            });

            const acosBrackets = [
                { label: 'no Sales', min: -1, max: -1, range: '' },
                { label: 'L0', min: 0, max: 0.10, range: '0% - 10%' },
                { label: 'L1', min: 0.10, max: 0.20, range: '10% - 20%' },
                { label: 'L2', min: 0.20, max: 0.30, range: '20% - 30%' },
                { label: 'L3', min: 0.30, max: 0.40, range: '30% - 40%' },
                { label: 'L4', min: 0.40, max: 0.50, range: '40% - 50%' },
                { label: 'L5', min: 0.50, max: 999, range: '50% - 999%' }
            ];

            const cvrBrackets = [
                { label: 'no Sales', min: -1, max: -1, range: '' },
                { label: 'L0', min: 0, max: 0.02, range: '0% - 2%' },
                { label: 'L1', min: 0.02, max: 0.05, range: '2% - 5%' },
                { label: 'L2', min: 0.05, max: 0.10, range: '5% - 10%' },
                { label: 'L3', min: 0.10, max: 0.15, range: '10% - 15%' },
                { label: 'L4', min: 0.15, max: 0.20, range: '15% - 20%' },
                { label: 'L5', min: 0.20, max: 999, range: '20% - 999%' }
            ];

            function aggregateByBracket(brackets, metricFn) {
                return brackets.map(b => {
                    let filtered = b.min === -1
                        ? searchTerms.filter(r => !parseFloat(r.Sales))
                        : searchTerms.filter(r => { const s = parseFloat(r.Sales) || 0; if (!s) return false; const m = metricFn(r); return m >= b.min && m < b.max; });
                    return { ...b, ...calcMetrics(aggregateData(filtered, () => true)) };
                });
            }

            const acosData = aggregateByBracket(acosBrackets, r => { const sp = parseFloat(r.Spend) || 0, sa = parseFloat(r.Sales) || 0; return sa > 0 ? sp / sa : 0; });
            const cvrData = aggregateByBracket(cvrBrackets, r => { const o = parseFloat(r.Orders) || 0, c = parseFloat(r.Clicks) || 0; return c > 0 ? o / c : 0; });

            const totalSpend = acosData.reduce((s, d) => s + d.spend, 0);
            const totalSales = acosData.reduce((s, d) => s + d.sales, 0);
            const totalOrders = acosData.reduce((s, d) => s + d.orders, 0);
            const totalClicks = acosData.reduce((s, d) => s + d.clicks, 0);

            document.getElementById('acosDistributionTable').innerHTML = renderDistributionTable(acosData, totalSpend, totalSales, totalOrders, totalClicks, 'ACOS Bracket');
            document.getElementById('cvrDistributionTable').innerHTML = renderDistributionTable(cvrData, totalSpend, totalSales, totalOrders, totalClicks, 'CVR Bracket');
        }

        function renderDistributionTable(data, totalSpend, totalSales, totalOrders, totalClicks, label) {
            const gt = { spend: totalSpend, sales: totalSales, orders: totalOrders, clicks: totalClicks, cpc: totalClicks > 0 ? totalSpend / totalClicks : 0, cvr: totalClicks > 0 ? totalOrders / totalClicks : 0, acos: totalSales > 0 ? totalSpend / totalSales : 0 };
            return `<table>
                <thead><tr><th colspan="2">${label}</th><th>% Spend</th><th>Spend</th><th>Sales</th><th>Orders</th><th>Clicks</th><th>CPC</th><th>CVR</th><th>ACOS</th></tr></thead>
                <tbody>
                    ${data.map(r => {
                        const pSpend = totalSpend > 0 ? r.spend / totalSpend : 0;
                        const acos = r.sales > 0 ? r.spend / r.sales : 0;
                        const cvr = r.clicks > 0 ? r.orders / r.clicks : 0;
                        return `<tr>
                            <td><span class="bracket-label">${r.label}</span></td><td><span class="bracket-range">${r.range}</span></td>
                            <td class="${getSpendColorClass(pSpend)}">${formatPercent(pSpend)}</td><td>${formatCurrency(r.spend)}</td>
                            <td class="${getSalesColorClass(r.sales, totalSales)}">${formatCurrency(r.sales)}</td>
                            <td>${formatNumber(r.orders)}</td><td>${formatNumber(r.clicks)}</td><td>${r.clicks > 0 ? formatDecimal(r.cpc) : ''}</td>
                            <td>${r.clicks > 0 ? formatPercent(cvr) : ''}</td><td class="${getAcosColorClass(acos)}">${r.sales > 0 ? formatPercent(acos) : '0%'}</td>
                        </tr>`;
                    }).join('')}
                    <tr class="total-row">
                        <td colspan="2">Total</td><td>100%</td><td>${formatCurrency(gt.spend)}</td><td>${formatCurrency(gt.sales)}</td><td>${formatNumber(gt.orders)}</td><td>${formatNumber(gt.clicks)}</td>
                        <td>${formatDecimal(gt.cpc)}</td><td>${formatPercent(gt.cvr)}</td><td class="${getAcosColorClass(gt.acos)}">${formatPercent(gt.acos)}</td>
                    </tr>
                </tbody>
            </table>`;
        }

        function renderUniqueSearchTerms() {
            const minSpend = parseFloat(minSpendFilter.value) || 0;
            const minClicks = parseFloat(minClicksFilter.value) || 0;
            const minAcos = parseFloat(minAcosFilter.value) / 100 || 0; // Convert from % to decimal
            const typeFilter = ustTypeFilter.value;
            const excludeBranded = ustExcludeBranded.checked;
            const salesFilter = ustSalesFilter.value;
            const brandNames = getBrandNames();

            // Build targeting coverage maps
            const coverageMap = buildCoverageMap();

            // Helper function to check if a string looks like an ASIN
            function isAsinPattern(str) {
                return /^[Bb]0[A-Za-z0-9]{8}$/.test(str.trim());
            }

            // Aggregate by unique search term first (before filtering by type)
            const searchTermMap = new Map();

            parsedData.searchTerms.forEach(row => {
                const searchTerm = (row['Customer search term'] || '').trim();
                if (!searchTerm) return;

                // Apply branded filter at row level
                if (excludeBranded && brandNames.length && isBranded(searchTerm, brandNames)) return;

                if (!searchTermMap.has(searchTerm)) {
                    searchTermMap.set(searchTerm, {
                        searchTerm,
                        spend: 0,
                        sales: 0,
                        clicks: 0,
                        orders: 0,
                        impressions: 0,
                        campaignDetails: []
                    });
                }

                const data = searchTermMap.get(searchTerm);
                data.spend += parseFloat(row.Spend) || 0;
                data.sales += parseFloat(row.Sales) || 0;
                data.clicks += parseFloat(row.Clicks) || 0;
                data.orders += parseFloat(row.Orders) || 0;
                data.impressions += parseFloat(row.Impressions) || 0;
                
                const campaign = row['Campaign name (Informational only)'] || row['Campaign name'] || '';
                const targeting = row['Targeting'] || row['Keyword text'] || '';
                if (campaign) {
                    data.campaignDetails.push({
                        campaign: campaign,
                        targeting: targeting,
                        spend: parseFloat(row.Spend) || 0,
                        sales: parseFloat(row.Sales) || 0
                    });
                }
            });

            // Convert to array and calculate metrics
            let uniqueTerms = Array.from(searchTermMap.values()).map(item => {
                const uniqueCampaigns = [...new Set(item.campaignDetails.map(d => d.campaign))];
                
                return {
                    ...item,
                    campaignCount: uniqueCampaigns.length,
                    cpc: item.clicks > 0 ? item.spend / item.clicks : 0,
                    cvr: item.clicks > 0 ? item.orders / item.clicks : 0,
                    acos: item.sales > 0 ? item.spend / item.sales : 0,
                    isAsin: isAsinPattern(item.searchTerm),
                    coverage: getCoverageForTerm(item.searchTerm, coverageMap)
                };
            });

            // Apply type filter based on the search term itself
            if (typeFilter === 'asin') {
                uniqueTerms = uniqueTerms.filter(t => t.isAsin);
            } else if (typeFilter === 'keyword') {
                uniqueTerms = uniqueTerms.filter(t => !t.isAsin);
            }

            // Apply minimum spend filter
            uniqueTerms = uniqueTerms.filter(t => t.spend >= minSpend);

            // Apply minimum clicks filter
            if (minClicks > 0) {
                uniqueTerms = uniqueTerms.filter(t => t.clicks >= minClicks);
            }

            // Apply minimum ACOS filter
            if (minAcos > 0) {
                uniqueTerms = uniqueTerms.filter(t => t.acos >= minAcos);
            }

            // Apply sales filter
            if (salesFilter === 'with-sales') {
                uniqueTerms = uniqueTerms.filter(t => t.sales > 0);
            } else if (salesFilter === 'no-sales') {
                uniqueTerms = uniqueTerms.filter(t => t.sales === 0);
            }

            // Sort by spend descending
            uniqueTerms.sort((a, b) => b.spend - a.spend);

            // Calculate grand totals
            const grandTotal = uniqueTerms.reduce((acc, t) => ({
                spend: acc.spend + t.spend,
                sales: acc.sales + t.sales,
                clicks: acc.clicks + t.clicks,
                orders: acc.orders + t.orders
            }), { spend: 0, sales: 0, clicks: 0, orders: 0 });

            grandTotal.cpc = grandTotal.clicks > 0 ? grandTotal.spend / grandTotal.clicks : 0;
            grandTotal.cvr = grandTotal.clicks > 0 ? grandTotal.orders / grandTotal.clicks : 0;
            grandTotal.acos = grandTotal.sales > 0 ? grandTotal.spend / grandTotal.sales : 0;

            // Update stats summary
            const statsEl = document.getElementById('uniqueSearchTermsStats');
            if (uniqueTerms.length > 0) {
                statsEl.style.display = 'flex';
                statsEl.innerHTML = `
                    <div class="stat-item">
                        <span class="stat-label">Unique Terms</span>
                        <span class="stat-value">${formatNumber(uniqueTerms.length)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Spend</span>
                        <span class="stat-value">${formatCurrencyDecimal(grandTotal.spend)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Sales</span>
                        <span class="stat-value">${formatCurrencyDecimal(grandTotal.sales)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Orders</span>
                        <span class="stat-value">${formatNumber(grandTotal.orders)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Avg CPC</span>
                        <span class="stat-value">${formatCPC(grandTotal.cpc)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Avg CVR</span>
                        <span class="stat-value">${formatPercent(grandTotal.cvr, 1)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Avg ACOS</span>
                        <span class="stat-value">${formatPercent(grandTotal.acos, 1)}</span>
                    </div>
                `;
            } else {
                statsEl.style.display = 'none';
            }

            if (uniqueTerms.length === 0) {
                document.getElementById('uniqueSearchTermsTable').innerHTML = `<div class="empty-state">No search terms found matching your criteria. Try lowering the minimum spend filter.</div>`;
                return;
            }

            // Store data globally for dropdown access
            window.uniqueTermsData = uniqueTerms;

            document.getElementById('uniqueSearchTermsTable').innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2">#</th>
                            <th rowspan="2">Search Term</th>
                            <th rowspan="2">Type</th>
                            <th rowspan="2">Spend</th>
                            <th rowspan="2">Clicks</th>
                            <th rowspan="2">Orders</th>
                            <th rowspan="2">Sales</th>
                            <th rowspan="2">CPC</th>
                            <th rowspan="2">CVR</th>
                            <th rowspan="2">ACOS</th>
                            <th rowspan="2">% Spend</th>
                            <th rowspan="2">Campaigns</th>
                            <th colspan="4" class="coverage-group header-sp-cover">SP</th>
                            <th colspan="3" class="coverage-group header-hsa-cover">HSA</th>
                            <th colspan="3" class="coverage-group header-sbv-cover">SBV</th>
                        </tr>
                        <tr>
                            <th class="coverage-header">EX</th>
                            <th class="coverage-header">PH</th>
                            <th class="coverage-header">BR</th>
                            <th class="coverage-header">ASIN</th>
                            <th class="coverage-header">EX</th>
                            <th class="coverage-header">PH</th>
                            <th class="coverage-header">BR</th>
                            <th class="coverage-header">EX</th>
                            <th class="coverage-header">PH</th>
                            <th class="coverage-header">BR</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${uniqueTerms.map((t, idx) => {
                            const pSpend = grandTotal.spend > 0 ? t.spend / grandTotal.spend : 0;
                            const typeLabel = t.isAsin ? '<span style="color:#8b5cf6;font-weight:600;">ASIN</span>' : '<span style="color:#3b82f6;">KW</span>';
                            return `<tr>
                                <td>${idx + 1}</td>
                                <td class="search-term-cell" title="${escapeHtml(t.searchTerm)}">${escapeHtml(t.searchTerm)}</td>
                                <td style="text-align:center;">${typeLabel}</td>
                                <td>${formatCurrencyDecimal(t.spend)}</td>
                                <td>${formatNumber(t.clicks)}</td>
                                <td>${formatNumber(t.orders)}</td>
                                <td>${formatCurrencyDecimal(t.sales)}</td>
                                <td class="${getCpcClass(t.cpc)}">${t.clicks > 0 ? formatCPC(t.cpc) : ''}</td>
                                <td>${t.clicks > 0 ? formatPercent(t.cvr, 1) : ''}</td>
                                <td class="${getAcosColorClass(t.acos)}">${t.sales > 0 ? formatPercent(t.acos, 1) : (t.spend > 0 ? '' : '')}</td>
                                <td class="${getSpendColorClass(pSpend)}">${formatPercent(pSpend, 1)}</td>
                                <td class="expandable-cell" onclick="toggleCampaignDropdown(event, ${idx})">
                                    <span class="count-badge">${t.campaignCount}</span>
                                    <span class="expand-icon"></span>
                                    <div class="dropdown-content" id="campaign-dropdown-${idx}">
                                        <div class="dropdown-header">Campaigns (${t.campaignCount})</div>
                                        ${t.campaignDetails.map(d => `
                                            <div class="dropdown-item">
                                                <div class="dropdown-item-campaign">${escapeHtml(d.campaign)}</div>
                                                <div class="dropdown-item-target">Target: ${escapeHtml(d.targeting)} | Spend: ${formatCurrencyDecimal(d.spend)}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </td>
                                ${renderCoverageCell(t.coverage.sp_exact, idx, 'sp_exact')}
                                ${renderCoverageCell(t.coverage.sp_phrase, idx, 'sp_phrase')}
                                ${renderCoverageCell(t.coverage.sp_broad, idx, 'sp_broad')}
                                ${renderCoverageCell(t.coverage.sp_asin, idx, 'sp_asin')}
                                ${renderCoverageCell(t.coverage.hsa_exact, idx, 'hsa_exact')}
                                ${renderCoverageCell(t.coverage.hsa_phrase, idx, 'hsa_phrase')}
                                ${renderCoverageCell(t.coverage.hsa_broad, idx, 'hsa_broad')}
                                ${renderCoverageCell(t.coverage.sbv_exact, idx, 'sbv_exact')}
                                ${renderCoverageCell(t.coverage.sbv_phrase, idx, 'sbv_phrase')}
                                ${renderCoverageCell(t.coverage.sbv_broad, idx, 'sbv_broad')}
                            </tr>`;
                        }).join('')}
                        <tr class="total-row">
                            <td></td>
                            <td>Total (${formatNumber(uniqueTerms.length)} terms)</td>
                            <td></td>
                            <td>${formatCurrencyDecimal(grandTotal.spend)}</td>
                            <td>${formatNumber(grandTotal.clicks)}</td>
                            <td>${formatNumber(grandTotal.orders)}</td>
                            <td>${formatCurrencyDecimal(grandTotal.sales)}</td>
                            <td class="${getCpcClass(grandTotal.cpc)}">${formatCPC(grandTotal.cpc)}</td>
                            <td>${formatPercent(grandTotal.cvr, 1)}</td>
                            <td class="${getAcosColorClass(grandTotal.acos)}">${formatPercent(grandTotal.acos, 1)}</td>
                            <td>100.0%</td>
                            <td colspan="11"></td>
                        </tr>
                    </tbody>
                </table>`;
        }

        function normalizeString(str) {
            // Normalize unicode (handle combining characters) and lowercase
            return str.normalize('NFC').toLowerCase().trim();
        }

        function buildCoverageMap() {
            const coverage = {
                sp_exact: new Map(),
                sp_phrase: new Map(),
                sp_broad: new Map(),
                sp_asin: new Map(),
                hsa_exact: new Map(),
                hsa_phrase: new Map(),
                hsa_broad: new Map(),
                sbv_exact: new Map(),
                sbv_phrase: new Map(),
                sbv_broad: new Map()
            };

            // Process SP Keywords
            const spKeywords = parsedData.sp.filter(r => r.Entity === 'Keyword' && r['Match type'] && !r['Match type'].includes('Negative'));
            spKeywords.forEach(row => {
                const keyword = normalizeString(row['Keyword text'] || '');
                const matchType = (row['Match type'] || '').toLowerCase();
                const campaign = row['Campaign name (Informational only)'] || row['Campaign name'] || '';
                
                if (!keyword) return;
                
                let targetMap;
                if (matchType === 'exact') targetMap = coverage.sp_exact;
                else if (matchType === 'phrase') targetMap = coverage.sp_phrase;
                else if (matchType === 'broad') targetMap = coverage.sp_broad;
                else return;

                if (!targetMap.has(keyword)) {
                    targetMap.set(keyword, []);
                }
                targetMap.get(keyword).push({ campaign, target: row['Keyword text'] || '' });
            });

            // Process SP ASIN targeting
            const spAsin = parsedData.sp.filter(r => r.Entity === 'Product targeting' && (r['Product targeting expression'] || '').includes('asin='));
            spAsin.forEach(row => {
                const pt = row['Product targeting expression'] || '';
                const asinMatch = pt.match(/asin="([^"]+)"/i);
                if (asinMatch) {
                    const asin = asinMatch[1].toUpperCase();
                    const campaign = row['Campaign name (Informational only)'] || row['Campaign name'] || '';
                    
                    if (!coverage.sp_asin.has(asin)) {
                        coverage.sp_asin.set(asin, []);
                    }
                    coverage.sp_asin.get(asin).push({ campaign, target: pt });
                }
            });

            // First, build a map of campaign names to their ad format (video or not)
            const sbCampaignFormats = new Map();
            parsedData.sb.filter(r => r.Entity === 'Campaign').forEach(row => {
                // Try multiple possible field names for campaign name
                const campaignName = (row['Campaign name (Informational only)'] || row['Campaign name'] || row['Campaign Name'] || '').trim();
                const format = (row['Ad format'] || row['Ad format (Informational only)'] || row['Ad Format'] || '').toLowerCase();
                const isVideo = format.includes('video');
                if (campaignName) {
                    sbCampaignFormats.set(campaignName, isVideo);
                    // Also store lowercase version for case-insensitive matching
                    sbCampaignFormats.set(campaignName.toLowerCase(), isVideo);
                }
            });

            // Process SB Keywords - check campaign format to determine HSA vs SBV
            // Also check for "Targeting" entity type which some bulk files use
            const sbKeywords = parsedData.sb.filter(r => {
                const entity = (r.Entity || '').toLowerCase();
                return (entity === 'keyword' || entity === 'targeting') && 
                       r['Match type'] && !r['Match type'].includes('Negative');
            });
            sbKeywords.forEach(row => {
                // Try multiple possible field names for keyword
                const keyword = normalizeString(row['Keyword text'] || row['Keyword Text'] || row['Targeting'] || row['Keyword'] || '');
                const matchType = (row['Match type'] || row['Match Type'] || '').toLowerCase();
                const campaign = (row['Campaign name (Informational only)'] || row['Campaign name'] || row['Campaign Name'] || row['Campaign'] || '').trim();
                
                if (!keyword) return;
                
                // Determine if this is a video campaign or HSA - try exact match first, then lowercase
                let isVideo = sbCampaignFormats.get(campaign);
                if (isVideo === undefined) {
                    isVideo = sbCampaignFormats.get(campaign.toLowerCase());
                }
                // If still undefined, check if campaign name contains 'video' as fallback
                if (isVideo === undefined) {
                    isVideo = campaign.toLowerCase().includes('video') || campaign.toLowerCase().includes('sbv');
                }
                
                let targetMap;
                if (matchType === 'exact') {
                    targetMap = isVideo ? coverage.sbv_exact : coverage.hsa_exact;
                } else if (matchType === 'phrase') {
                    targetMap = isVideo ? coverage.sbv_phrase : coverage.hsa_phrase;
                } else if (matchType === 'broad') {
                    targetMap = isVideo ? coverage.sbv_broad : coverage.hsa_broad;
                } else {
                    return;
                }

                if (!targetMap.has(keyword)) {
                    targetMap.set(keyword, []);
                }
                targetMap.get(keyword).push({ campaign, target: row['Keyword text'] || row['Keyword Text'] || row['Targeting'] || row['Keyword'] || '' });
            });

            return coverage;
        }

        function getCoverageForTerm(searchTerm, coverageMap) {
            const term = normalizeString(searchTerm);
            const isAsin = /^[A-Z0-9]{10}$/i.test(searchTerm.trim());
            
            const result = {
                sp_exact: { covered: false, details: [] },
                sp_phrase: { covered: false, details: [] },
                sp_broad: { covered: false, details: [] },
                sp_asin: { covered: false, details: [] },
                hsa_exact: { covered: false, details: [] },
                hsa_phrase: { covered: false, details: [] },
                hsa_broad: { covered: false, details: [] },
                sbv_exact: { covered: false, details: [] },
                sbv_phrase: { covered: false, details: [] },
                sbv_broad: { covered: false, details: [] }
            };

            // Check exact matches
            if (coverageMap.sp_exact.has(term)) {
                result.sp_exact = { covered: true, details: coverageMap.sp_exact.get(term) };
            }
            if (coverageMap.hsa_exact.has(term)) {
                result.hsa_exact = { covered: true, details: coverageMap.hsa_exact.get(term) };
            }
            if (coverageMap.sbv_exact.has(term)) {
                result.sbv_exact = { covered: true, details: coverageMap.sbv_exact.get(term) };
            }

            // Check phrase matches (keyword is contained in search term or vice versa)
            coverageMap.sp_phrase.forEach((details, keyword) => {
                if (term.includes(keyword) || keyword.includes(term)) {
                    result.sp_phrase = { covered: true, details: [...result.sp_phrase.details, ...details] };
                }
            });
            coverageMap.hsa_phrase.forEach((details, keyword) => {
                if (term.includes(keyword) || keyword.includes(term)) {
                    result.hsa_phrase = { covered: true, details: [...result.hsa_phrase.details, ...details] };
                }
            });
            coverageMap.sbv_phrase.forEach((details, keyword) => {
                if (term.includes(keyword) || keyword.includes(term)) {
                    result.sbv_phrase = { covered: true, details: [...result.sbv_phrase.details, ...details] };
                }
            });

            // Check broad matches (any word overlap)
            const termWords = term.split(/\s+/);
            coverageMap.sp_broad.forEach((details, keyword) => {
                const kwWords = keyword.split(/\s+/);
                if (kwWords.some(kw => termWords.some(tw => tw.includes(kw) || kw.includes(tw)))) {
                    result.sp_broad = { covered: true, details: [...result.sp_broad.details, ...details] };
                }
            });
            coverageMap.hsa_broad.forEach((details, keyword) => {
                const kwWords = keyword.split(/\s+/);
                if (kwWords.some(kw => termWords.some(tw => tw.includes(kw) || kw.includes(tw)))) {
                    result.hsa_broad = { covered: true, details: [...result.hsa_broad.details, ...details] };
                }
            });
            coverageMap.sbv_broad.forEach((details, keyword) => {
                const kwWords = keyword.split(/\s+/);
                if (kwWords.some(kw => termWords.some(tw => tw.includes(kw) || kw.includes(tw)))) {
                    result.sbv_broad = { covered: true, details: [...result.sbv_broad.details, ...details] };
                }
            });

            // Check ASIN targeting
            if (isAsin && coverageMap.sp_asin.has(searchTerm.trim().toUpperCase())) {
                result.sp_asin = { covered: true, details: coverageMap.sp_asin.get(searchTerm.trim().toUpperCase()) };
            }

            return result;
        }

        function renderCoverageCell(coverageData, rowIdx, coverageType) {
            if (coverageData.covered) {
                const uniqueDetails = [];
                const seen = new Set();
                coverageData.details.forEach(d => {
                    const key = d.campaign + '|' + d.target;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueDetails.push(d);
                    }
                });
                
                return `<td class="coverage-cell coverage-yes" onclick="toggleCoverageDropdown(event, ${rowIdx}, '${coverageType}')">
                    <span class="coverage-icon"></span>
                    <div class="dropdown-content coverage-dropdown" id="coverage-${rowIdx}-${coverageType}">
                        <div class="dropdown-header">${getCoverageLabel(coverageType)} (${uniqueDetails.length})</div>
                        ${uniqueDetails.map(d => `
                            <div class="dropdown-item">
                                <div class="dropdown-item-campaign">${escapeHtml(d.campaign)}</div>
                                <div class="dropdown-item-target">Target: ${escapeHtml(d.target)}</div>
                            </div>
                        `).join('')}
                    </div>
                </td>`;
            } else {
                return `<td class="coverage-cell coverage-no"><span class="coverage-icon"></span></td>`;
            }
        }

        function getCoverageLabel(coverageType) {
            const labels = {
                sp_exact: 'SP Exact',
                sp_phrase: 'SP Phrase',
                sp_broad: 'SP Broad',
                sp_asin: 'SP ASIN',
                hsa_exact: 'HSA Exact',
                hsa_phrase: 'HSA Phrase',
                hsa_broad: 'HSA Broad',
                sbv_exact: 'SBV Exact',
                sbv_phrase: 'SBV Phrase',
                sbv_broad: 'SBV Broad'
            };
            return labels[coverageType] || coverageType;
        }

        function toggleCampaignDropdown(event, idx) {
            event.stopPropagation();
            closeAllDropdowns();
            const dropdown = document.getElementById(`campaign-dropdown-${idx}`);
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        function toggleCoverageDropdown(event, rowIdx, coverageType) {
            event.stopPropagation();
            closeAllDropdowns();
            const dropdown = document.getElementById(`coverage-${rowIdx}-${coverageType}`);
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.expandable-cell') && !event.target.closest('.coverage-yes')) {
                closeAllDropdowns();
            }
        });

        function renderPlacementOptimizer() {
            const minSpend = parseFloat(placementMinSpend.value) || 0;
            const biddingFilter = currentBiddingFilter;
            const targetingFilter = currentTargetingFilter;

            // Get campaign data
            const campaigns = parsedData.sp.filter(r => r.Entity === 'Campaign');
            
            // Get bidding adjustments (placements)
            const biddingAdjustments = parsedData.sp.filter(r => r.Entity === 'Bidding adjustment');
            
            // Get keywords and product targeting to determine campaign type
            const keywords = parsedData.sp.filter(r => r.Entity === 'Keyword');
            const productTargeting = parsedData.sp.filter(r => r.Entity === 'Product targeting');
            
            // Build maps for targeting type per campaign
            const campaignHasKeywords = new Set();
            const campaignHasProductTargeting = new Set();
            
            keywords.forEach(row => {
                const campaignName = row['Campaign name (Informational only)'] || row['Campaign name'] || '';
                if (campaignName) campaignHasKeywords.add(campaignName);
            });
            
            productTargeting.forEach(row => {
                const campaignName = row['Campaign name (Informational only)'] || row['Campaign name'] || '';
                if (campaignName) campaignHasProductTargeting.add(campaignName);
            });
            
            // Build placement data map by campaign
            const campaignDataMap = new Map();
            
            // First, process campaigns
            campaigns.forEach(row => {
                const campaignName = row['Campaign name (Informational only)'] || row['Campaign name'] || row['Campaign Name'] || '';
                if (!campaignName) return;
                
                const biddingStrategy = row['Bidding strategy'] || row['Campaign bidding strategy'] || '';
                const portfolio = row['Portfolio name (Informational only)'] || row['Portfolio name'] || row['Portfolio'] || '';
                const targetingType = row['Targeting type'] || row['Campaign targeting type'] || '';
                
                // Determine targeting type
                let targeting = 'auto';
                if (targetingType.toLowerCase().includes('auto')) {
                    targeting = 'auto';
                } else if (campaignHasKeywords.has(campaignName) && campaignHasProductTargeting.has(campaignName)) {
                    targeting = 'mixed';
                } else if (campaignHasKeywords.has(campaignName)) {
                    targeting = 'kw';
                } else if (campaignHasProductTargeting.has(campaignName)) {
                    targeting = 'asin';
                } else if (targetingType.toLowerCase().includes('manual')) {
                    targeting = 'kw'; // default manual to KW
                }
                
                campaignDataMap.set(campaignName, {
                    name: campaignName,
                    biddingStrategy: biddingStrategy,
                    portfolio: portfolio || '(No Portfolio)',
                    targeting: targeting,
                    totalSpend: parseFloat(row.Spend) || 0,
                    totalSales: parseFloat(row.Sales) || 0,
                    totalClicks: parseFloat(row.Clicks) || 0,
                    totalOrders: parseFloat(row.Orders) || 0,
                    totalImpressions: parseFloat(row.Impressions) || 0,
                    // Placement data
                    tos: { spend: 0, sales: 0, clicks: 0, orders: 0, impressions: 0, modifier: 0 },
                    pp: { spend: 0, sales: 0, clicks: 0, orders: 0, impressions: 0, modifier: 0 },
                    ros: { spend: 0, sales: 0, clicks: 0, orders: 0, impressions: 0, modifier: 0 }
                });
            });
            
            // Collect all campaigns and portfolios for filter dropdowns
            const campaignSet = new Set();
            const portfolioSet = new Set();
            campaignDataMap.forEach(c => {
                campaignSet.add(c.name);
                portfolioSet.add(c.portfolio);
            });
            allCampaigns = [...campaignSet].sort();
            allPortfolios = [...portfolioSet].sort();
            
            // Update filter option counts
            document.getElementById('campaignCount').textContent = allCampaigns.length;
            document.getElementById('portfolioCount').textContent = allPortfolios.length;
            
            // Initialize selected if empty (select all by default)
            if (selectedCampaigns.size === 0) {
                selectedCampaigns = new Set(allCampaigns);
            }
            if (selectedPortfolios.size === 0) {
                selectedPortfolios = new Set(allPortfolios);
            }
            
            // Update campaign filter options
            campaignFilterOptions.innerHTML = allCampaigns.map(c => `
                <div class="filter-option">
                    <input type="checkbox" id="campaign-${c.replace(/[^a-zA-Z0-9]/g, '_')}" 
                           value="${escapeHtml(c)}" 
                           ${selectedCampaigns.has(c) ? 'checked' : ''}
                           onchange="toggleCampaign('${escapeHtml(c).replace(/'/g, "\\'")}', this.checked)">
                    <label for="campaign-${c.replace(/[^a-zA-Z0-9]/g, '_')}" title="${escapeHtml(c)}">${escapeHtml(c)}</label>
                </div>
            `).join('');
            
            // Update portfolio filter options
            portfolioFilterOptions.innerHTML = allPortfolios.map(p => `
                <div class="filter-option">
                    <input type="checkbox" id="portfolio-${p.replace(/[^a-zA-Z0-9]/g, '_')}" 
                           value="${escapeHtml(p)}" 
                           ${selectedPortfolios.has(p) ? 'checked' : ''}
                           onchange="togglePortfolio('${escapeHtml(p).replace(/'/g, "\\'")}', this.checked)">
                    <label for="portfolio-${p.replace(/[^a-zA-Z0-9]/g, '_')}" title="${escapeHtml(p)}">${escapeHtml(p)}</label>
                </div>
            `).join('');
            
            // Process bidding adjustments to get placement modifiers
            biddingAdjustments.forEach(row => {
                const campaignName = row['Campaign name (Informational only)'] || row['Campaign name'] || row['Campaign Name'] || '';
                const placement = (row.Placement || '').toLowerCase();
                const percentage = parseFloat(row.Percentage) || 0;
                
                if (!campaignDataMap.has(campaignName)) return;
                
                const campaign = campaignDataMap.get(campaignName);
                
                if (placement.includes('top') || placement === 'placement top') {
                    campaign.tos.modifier = percentage;
                } else if (placement.includes('product') || placement === 'placement product page') {
                    campaign.pp.modifier = percentage;
                } else if (placement.includes('rest') || placement === 'placement rest of search') {
                    campaign.ros.modifier = percentage;
                }
            });
            
            // Try to get placement-level metrics from search term report or calculate from available data
            // In the bulk file, placement metrics are often in a separate placement report
            // For now, we'll work with what we have from the campaign data
            
            // Check if we have a separate placement report
            if (parsedData.placements && parsedData.placements.length > 0) {
                parsedData.placements.forEach(row => {
                    const campaignName = row['Campaign name (Informational only)'] || row['Campaign name'] || row['Campaign Name'] || row['Campaign'] || '';
                    const placement = (row.Placement || row['Placement Type'] || '').toLowerCase();
                    
                    if (!campaignDataMap.has(campaignName)) return;
                    
                    const campaign = campaignDataMap.get(campaignName);
                    const spend = parseFloat(row.Spend) || 0;
                    const sales = parseFloat(row.Sales) || 0;
                    const clicks = parseFloat(row.Clicks) || 0;
                    const orders = parseFloat(row.Orders) || 0;
                    const impressions = parseFloat(row.Impressions) || 0;
                    
                    if (placement.includes('top')) {
                        campaign.tos = { ...campaign.tos, spend, sales, clicks, orders, impressions };
                    } else if (placement.includes('product') || placement.includes('detail')) {
                        campaign.pp = { ...campaign.pp, spend, sales, clicks, orders, impressions };
                    } else if (placement.includes('rest') || placement.includes('other')) {
                        campaign.ros = { ...campaign.ros, spend, sales, clicks, orders, impressions };
                    }
                });
            }
            
            // Check if there's placement-specific data in the SP data
            const placementRows = parsedData.sp.filter(r => {
                const entity = (r.Entity || '').toLowerCase();
                return entity === 'placement' || (r.Placement && r.Spend);
            });
            
            if (placementRows.length > 0) {
                placementRows.forEach(row => {
                    const campaignName = row['Campaign name (Informational only)'] || row['Campaign name'] || row['Campaign Name'] || '';
                    const placement = (row.Placement || '').toLowerCase();
                    
                    if (!campaignDataMap.has(campaignName)) return;
                    
                    const campaign = campaignDataMap.get(campaignName);
                    const spend = parseFloat(row.Spend) || 0;
                    const sales = parseFloat(row.Sales) || 0;
                    const clicks = parseFloat(row.Clicks) || 0;
                    const orders = parseFloat(row.Orders) || 0;
                    const impressions = parseFloat(row.Impressions) || 0;
                    
                    if (placement.includes('top')) {
                        campaign.tos = { ...campaign.tos, spend, sales, clicks, orders, impressions };
                    } else if (placement.includes('product') || placement.includes('detail')) {
                        campaign.pp = { ...campaign.pp, spend, sales, clicks, orders, impressions };
                    } else if (placement.includes('rest') || placement.includes('other')) {
                        campaign.ros = { ...campaign.ros, spend, sales, clicks, orders, impressions };
                    }
                });
            }
            
            // Convert to array
            let campaignList = Array.from(campaignDataMap.values());
            
            // Apply filters
            if (minSpend > 0) {
                campaignList = campaignList.filter(c => c.totalSpend >= minSpend);
            }
            
            if (biddingFilter !== 'all') {
                campaignList = campaignList.filter(c => {
                    const strategy = c.biddingStrategy.toLowerCase();
                    if (biddingFilter === 'dynamic-down') return strategy.includes('down only') || strategy.includes('down-only');
                    if (biddingFilter === 'dynamic-up-down') return strategy.includes('up and down') || strategy.includes('up-and-down');
                    if (biddingFilter === 'fixed') return strategy.includes('fixed');
                    return true;
                });
            }
            
            // Campaign filter
            if (selectedCampaigns.size > 0 && selectedCampaigns.size < allCampaigns.length) {
                campaignList = campaignList.filter(c => selectedCampaigns.has(c.name));
            }
            
            // Targeting type filter
            if (targetingFilter !== 'all') {
                campaignList = campaignList.filter(c => {
                    if (targetingFilter === 'kw') return c.targeting === 'kw' || c.targeting === 'mixed';
                    if (targetingFilter === 'asin') return c.targeting === 'asin' || c.targeting === 'mixed';
                    if (targetingFilter === 'auto') return c.targeting === 'auto';
                    return true;
                });
            }
            
            // Portfolio filter
            if (selectedPortfolios.size > 0 && selectedPortfolios.size < allPortfolios.length) {
                campaignList = campaignList.filter(c => selectedPortfolios.has(c.portfolio));
            }
            
            // Sort by total spend descending
            campaignList.sort((a, b) => b.totalSpend - a.totalSpend);
            
            // Calculate totals from FILTERED list
            const grandTotal = campaignList.reduce((acc, c) => ({
                spend: acc.spend + c.totalSpend,
                sales: acc.sales + c.totalSales,
                clicks: acc.clicks + c.totalClicks,
                orders: acc.orders + c.totalOrders,
                tos: {
                    spend: acc.tos.spend + c.tos.spend,
                    sales: acc.tos.sales + c.tos.sales,
                    clicks: acc.tos.clicks + c.tos.clicks,
                    orders: acc.tos.orders + c.tos.orders
                },
                pp: {
                    spend: acc.pp.spend + c.pp.spend,
                    sales: acc.pp.sales + c.pp.sales,
                    clicks: acc.pp.clicks + c.pp.clicks,
                    orders: acc.pp.orders + c.pp.orders
                },
                ros: {
                    spend: acc.ros.spend + c.ros.spend,
                    sales: acc.ros.sales + c.ros.sales,
                    clicks: acc.ros.clicks + c.ros.clicks,
                    orders: acc.ros.orders + c.ros.orders
                }
            }), {
                spend: 0, sales: 0, clicks: 0, orders: 0,
                tos: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                pp: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                ros: { spend: 0, sales: 0, clicks: 0, orders: 0 }
            });

            // Update stats
            const statsEl = document.getElementById('placementStats');
            if (campaignList.length > 0) {
                const totalAcos = grandTotal.sales > 0 ? grandTotal.spend / grandTotal.sales : 0;
                const totalCvr = grandTotal.clicks > 0 ? grandTotal.orders / grandTotal.clicks : 0;
                const totalCpc = grandTotal.clicks > 0 ? grandTotal.spend / grandTotal.clicks : 0;
                
                statsEl.style.display = 'flex';
                statsEl.innerHTML = `
                    <div class="stat-item">
                        <span class="stat-label">Campaigns</span>
                        <span class="stat-value">${formatNumber(campaignList.length)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Spend</span>
                        <span class="stat-value">${formatCurrencyDecimal(grandTotal.spend)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Sales</span>
                        <span class="stat-value">${formatCurrencyDecimal(grandTotal.sales)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ACOS</span>
                        <span class="stat-value">${formatPercent(totalAcos, 1)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">CVR</span>
                        <span class="stat-value">${formatPercent(totalCvr, 1)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">CPC</span>
                        <span class="stat-value">${formatCPC(totalCpc)}</span>
                    </div>
                `;
            } else {
                statsEl.style.display = 'none';
            }

            // Calculate and render Match Type Performance
            renderMatchTypePerformance(campaignList);

            if (campaignList.length === 0) {
                document.getElementById('placementOptimizerTable').innerHTML = `<div class="empty-state">No campaigns found matching your criteria.</div>`;
                document.getElementById('matchTypeSection').style.display = 'none';
                return;
            }

            // Check if we have placement-level data
            const hasPlacementData = campaignList.some(c => c.tos.spend > 0 || c.pp.spend > 0 || c.ros.spend > 0);

            document.getElementById('placementOptimizerTable').innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2">#</th>
                            <th rowspan="2" style="min-width:200px;">Campaign</th>
                            <th rowspan="2">Portfolio</th>
                            <th rowspan="2">Type</th>
                            <th rowspan="2">Bidding Strategy</th>
                            <th rowspan="2">Total<br>Spend</th>
                            <th rowspan="2">ACOS</th>
                            <th rowspan="2">CPC</th>
                            <th colspan="3" class="header-group" style="background:#6366f1;color:white;">Spend %</th>
                            <th colspan="3" class="header-group" style="background:#3b82f6;color:white;">Spend</th>
                            <th colspan="3" class="header-group" style="background:#0ea5e9;color:white;">CPC</th>
                            <th colspan="3" class="header-group" style="background:#dc2626;color:white;">ACOS</th>
                            <th colspan="3" class="header-group" style="background:#16a34a;color:white;">CVR</th>
                            <th colspan="3" class="header-group" style="background:#ca8a04;color:white;">Sales</th>
                            <th colspan="3" class="header-group" style="background:#7c3aed;color:white;">Clicks</th>
                            <th colspan="3" class="header-group" style="background:#db2777;color:white;">Orders</th>
                        </tr>
                        <tr>
                            <th class="coverage-header">TOS</th>
                            <th class="coverage-header">PP</th>
                            <th class="coverage-header">ROS</th>
                            <th class="coverage-header">TOS</th>
                            <th class="coverage-header">PP</th>
                            <th class="coverage-header">ROS</th>
                            <th class="coverage-header">TOS</th>
                            <th class="coverage-header">PP</th>
                            <th class="coverage-header">ROS</th>
                            <th class="coverage-header">TOS</th>
                            <th class="coverage-header">PP</th>
                            <th class="coverage-header">ROS</th>
                            <th class="coverage-header">TOS</th>
                            <th class="coverage-header">PP</th>
                            <th class="coverage-header">ROS</th>
                            <th class="coverage-header">TOS</th>
                            <th class="coverage-header">PP</th>
                            <th class="coverage-header">ROS</th>
                            <th class="coverage-header">TOS</th>
                            <th class="coverage-header">PP</th>
                            <th class="coverage-header">ROS</th>
                            <th class="coverage-header">TOS</th>
                            <th class="coverage-header">PP</th>
                            <th class="coverage-header">ROS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="total-row" style="background:#e0e7ff;">
                            <td></td>
                            <td><strong>Totals (${formatNumber(campaignList.length)} campaigns)</strong></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td><strong>${formatCurrencyDecimal(grandTotal.spend)}</strong></td>
                            <td class="${getAcosColorClass(grandTotal.sales > 0 ? grandTotal.spend / grandTotal.sales : 0)}"><strong>${formatPercent(grandTotal.sales > 0 ? grandTotal.spend / grandTotal.sales : 0, 1)}</strong></td>
                            <td><strong>${formatCPC(grandTotal.clicks > 0 ? grandTotal.spend / grandTotal.clicks : 0)}</strong></td>
                            <td class="placement-cell"><strong>${hasPlacementData && grandTotal.spend > 0 ? formatPercent(grandTotal.tos.spend / grandTotal.spend, 0) : '-'}</strong></td>
                            <td class="placement-cell"><strong>${hasPlacementData && grandTotal.spend > 0 ? formatPercent(grandTotal.pp.spend / grandTotal.spend, 0) : '-'}</strong></td>
                            <td class="placement-cell"><strong>${hasPlacementData && grandTotal.spend > 0 ? formatPercent(grandTotal.ros.spend / grandTotal.spend, 0) : '-'}</strong></td>
                            <td class="placement-cell"><strong>${formatNumber(grandTotal.tos.spend)}</strong></td>
                            <td class="placement-cell"><strong>${formatNumber(grandTotal.pp.spend)}</strong></td>
                            <td class="placement-cell"><strong>${formatNumber(grandTotal.ros.spend)}</strong></td>
                            <td class="placement-cell"><strong>${grandTotal.tos.clicks > 0 ? formatDecimal(grandTotal.tos.spend / grandTotal.tos.clicks) : '-'}</strong></td>
                            <td class="placement-cell"><strong>${grandTotal.pp.clicks > 0 ? formatDecimal(grandTotal.pp.spend / grandTotal.pp.clicks) : '-'}</strong></td>
                            <td class="placement-cell"><strong>${grandTotal.ros.clicks > 0 ? formatDecimal(grandTotal.ros.spend / grandTotal.ros.clicks) : '-'}</strong></td>
                            <td class="placement-cell ${getAcosColorClass(grandTotal.tos.sales > 0 ? grandTotal.tos.spend / grandTotal.tos.sales : 0)}"><strong>${grandTotal.tos.sales > 0 ? formatPercent(grandTotal.tos.spend / grandTotal.tos.sales, 0) : '-'}</strong></td>
                            <td class="placement-cell ${getAcosColorClass(grandTotal.pp.sales > 0 ? grandTotal.pp.spend / grandTotal.pp.sales : 0)}"><strong>${grandTotal.pp.sales > 0 ? formatPercent(grandTotal.pp.spend / grandTotal.pp.sales, 0) : '-'}</strong></td>
                            <td class="placement-cell ${getAcosColorClass(grandTotal.ros.sales > 0 ? grandTotal.ros.spend / grandTotal.ros.sales : 0)}"><strong>${grandTotal.ros.sales > 0 ? formatPercent(grandTotal.ros.spend / grandTotal.ros.sales, 0) : '-'}</strong></td>
                            <td class="placement-cell ${getCvrClass(grandTotal.tos.clicks > 0 ? grandTotal.tos.orders / grandTotal.tos.clicks : 0)}"><strong>${grandTotal.tos.clicks > 0 ? formatPercent(grandTotal.tos.orders / grandTotal.tos.clicks, 0) : '-'}</strong></td>
                            <td class="placement-cell ${getCvrClass(grandTotal.pp.clicks > 0 ? grandTotal.pp.orders / grandTotal.pp.clicks : 0)}"><strong>${grandTotal.pp.clicks > 0 ? formatPercent(grandTotal.pp.orders / grandTotal.pp.clicks, 0) : '-'}</strong></td>
                            <td class="placement-cell ${getCvrClass(grandTotal.ros.clicks > 0 ? grandTotal.ros.orders / grandTotal.ros.clicks : 0)}"><strong>${grandTotal.ros.clicks > 0 ? formatPercent(grandTotal.ros.orders / grandTotal.ros.clicks, 0) : '-'}</strong></td>
                            <td class="placement-cell"><strong>${formatNumber(grandTotal.tos.sales)}</strong></td>
                            <td class="placement-cell"><strong>${formatNumber(grandTotal.pp.sales)}</strong></td>
                            <td class="placement-cell"><strong>${formatNumber(grandTotal.ros.sales)}</strong></td>
                            <td class="placement-cell"><strong>${formatNumber(grandTotal.tos.clicks)}</strong></td>
                            <td class="placement-cell"><strong>${formatNumber(grandTotal.pp.clicks)}</strong></td>
                            <td class="placement-cell"><strong>${formatNumber(grandTotal.ros.clicks)}</strong></td>
                            <td class="placement-cell"><strong>${formatNumber(grandTotal.tos.orders)}</strong></td>
                            <td class="placement-cell"><strong>${formatNumber(grandTotal.pp.orders)}</strong></td>
                            <td class="placement-cell"><strong>${formatNumber(grandTotal.ros.orders)}</strong></td>
                        </tr>
                        ${campaignList.map((c, idx) => {
                            const totalAcos = c.totalSales > 0 ? c.totalSpend / c.totalSales : 0;
                            const totalCpc = c.totalClicks > 0 ? c.totalSpend / c.totalClicks : 0;
                            
                            // Calculate placement metrics
                            const tosSpendPct = c.totalSpend > 0 ? c.tos.spend / c.totalSpend : 0;
                            const ppSpendPct = c.totalSpend > 0 ? c.pp.spend / c.totalSpend : 0;
                            const rosSpendPct = c.totalSpend > 0 ? c.ros.spend / c.totalSpend : 0;
                            
                            const tosCpc = c.tos.clicks > 0 ? c.tos.spend / c.tos.clicks : 0;
                            const ppCpc = c.pp.clicks > 0 ? c.pp.spend / c.pp.clicks : 0;
                            const rosCpc = c.ros.clicks > 0 ? c.ros.spend / c.ros.clicks : 0;
                            
                            const tosCvr = c.tos.clicks > 0 ? c.tos.orders / c.tos.clicks : 0;
                            const ppCvr = c.pp.clicks > 0 ? c.pp.orders / c.pp.clicks : 0;
                            const rosCvr = c.ros.clicks > 0 ? c.ros.orders / c.ros.clicks : 0;
                            
                            const tosAcos = c.tos.sales > 0 ? c.tos.spend / c.tos.sales : 0;
                            const ppAcos = c.pp.sales > 0 ? c.pp.spend / c.pp.sales : 0;
                            const rosAcos = c.ros.sales > 0 ? c.ros.spend / c.ros.sales : 0;
                            
                            return `<tr>
                                <td>${idx + 1}</td>
                                <td class="campaign-name-cell" title="${escapeHtml(c.name)}">${escapeHtml(c.name)}</td>
                                <td class="portfolio-cell" title="${escapeHtml(c.portfolio)}">${escapeHtml(c.portfolio)}</td>
                                <td>${renderTargetingBadge(c.targeting)}</td>
                                <td>${renderBiddingStrategy(c.biddingStrategy)}</td>
                                <td>${formatCurrencyDecimal(c.totalSpend)}</td>
                                <td class="${getAcosColorClass(totalAcos)}">${formatPercent(totalAcos, 1)}</td>
                                <td class="${getCpcClass(totalCpc)}">${formatCPC(totalCpc)}</td>
                                
                                <!-- Spend % -->
                                <td class="placement-cell ${getSpendPctClass(tosSpendPct)}">${hasPlacementData ? formatPercent(tosSpendPct, 0) : '-'}</td>
                                <td class="placement-cell ${getSpendPctClass(ppSpendPct)}">${hasPlacementData ? formatPercent(ppSpendPct, 0) : '-'}</td>
                                <td class="placement-cell ${getSpendPctClass(rosSpendPct)}">${hasPlacementData ? formatPercent(rosSpendPct, 0) : '-'}</td>
                                
                                <!-- Spend -->
                                <td class="placement-cell">${hasPlacementData && c.tos.spend > 0 ? formatNumber(c.tos.spend) : '-'}</td>
                                <td class="placement-cell">${hasPlacementData && c.pp.spend > 0 ? formatNumber(c.pp.spend) : '-'}</td>
                                <td class="placement-cell">${hasPlacementData && c.ros.spend > 0 ? formatNumber(c.ros.spend) : '-'}</td>
                                
                                <!-- CPC -->
                                <td class="placement-cell ${getCpcClass(tosCpc)}">${hasPlacementData && c.tos.clicks > 0 ? formatDecimal(tosCpc) : '-'}</td>
                                <td class="placement-cell ${getCpcClass(ppCpc)}">${hasPlacementData && c.pp.clicks > 0 ? formatDecimal(ppCpc) : '-'}</td>
                                <td class="placement-cell ${getCpcClass(rosCpc)}">${hasPlacementData && c.ros.clicks > 0 ? formatDecimal(rosCpc) : '-'}</td>
                                
                                <!-- ACOS -->
                                <td class="placement-cell ${getAcosColorClass(tosAcos)}">${hasPlacementData && c.tos.sales > 0 ? formatPercent(tosAcos, 0) : '-'}</td>
                                <td class="placement-cell ${getAcosColorClass(ppAcos)}">${hasPlacementData && c.pp.sales > 0 ? formatPercent(ppAcos, 0) : '-'}</td>
                                <td class="placement-cell ${getAcosColorClass(rosAcos)}">${hasPlacementData && c.ros.sales > 0 ? formatPercent(rosAcos, 0) : '-'}</td>
                                
                                <!-- CVR -->
                                <td class="placement-cell ${getCvrClass(tosCvr)}">${hasPlacementData && c.tos.clicks > 0 ? formatPercent(tosCvr, 0) : '-'}</td>
                                <td class="placement-cell ${getCvrClass(ppCvr)}">${hasPlacementData && c.pp.clicks > 0 ? formatPercent(ppCvr, 0) : '-'}</td>
                                <td class="placement-cell ${getCvrClass(rosCvr)}">${hasPlacementData && c.ros.clicks > 0 ? formatPercent(rosCvr, 0) : '-'}</td>
                                
                                <!-- Sales -->
                                <td class="placement-cell">${hasPlacementData && c.tos.sales > 0 ? formatNumber(c.tos.sales) : '-'}</td>
                                <td class="placement-cell">${hasPlacementData && c.pp.sales > 0 ? formatNumber(c.pp.sales) : '-'}</td>
                                <td class="placement-cell">${hasPlacementData && c.ros.sales > 0 ? formatNumber(c.ros.sales) : '-'}</td>
                                
                                <!-- Clicks -->
                                <td class="placement-cell">${hasPlacementData && c.tos.clicks > 0 ? formatNumber(c.tos.clicks) : '-'}</td>
                                <td class="placement-cell">${hasPlacementData && c.pp.clicks > 0 ? formatNumber(c.pp.clicks) : '-'}</td>
                                <td class="placement-cell">${hasPlacementData && c.ros.clicks > 0 ? formatNumber(c.ros.clicks) : '-'}</td>
                                
                                <!-- Orders -->
                                <td class="placement-cell">${hasPlacementData && c.tos.orders > 0 ? formatNumber(c.tos.orders) : '-'}</td>
                                <td class="placement-cell">${hasPlacementData && c.pp.orders > 0 ? formatNumber(c.pp.orders) : '-'}</td>
                                <td class="placement-cell">${hasPlacementData && c.ros.orders > 0 ? formatNumber(c.ros.orders) : '-'}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
                ${!hasPlacementData ? '<p style="padding: 1rem; color: #6b7280; font-size: 0.8rem;"> Placement-level metrics are not available in this bulk file. To see full placement data, include the Placement Report in your export.</p>' : ''}
            `;
        }

        function renderTargetingBadge(targeting) {
            switch(targeting) {
                case 'kw':
                    return '<span class="targeting-badge targeting-kw">KW</span>';
                case 'asin':
                    return '<span class="targeting-badge targeting-asin">ASIN</span>';
                case 'auto':
                    return '<span class="targeting-badge targeting-auto">Auto</span>';
                case 'mixed':
                    return '<span class="targeting-badge targeting-mixed">Mixed</span>';
                default:
                    return '<span class="targeting-badge">' + escapeHtml(targeting) + '</span>';
            }
        }

        function getSpendPctClass(pct) {
            if (pct >= 0.50) return 'cell-spend-high';
            if (pct >= 0.25) return 'cell-green-1';
            return '';
        }

        function getCvrClass(cvr) {
            if (cvr >= 0.15) return 'cell-green-3';
            if (cvr >= 0.10) return 'cell-green-2';
            if (cvr >= 0.05) return 'cell-green-1';
            return '';
        }

        function renderBidModifier(modifier) {
            if (modifier > 0) {
                return `<span class="bid-modifier bid-modifier-positive">+${modifier}%</span>`;
            } else if (modifier < 0) {
                return `<span class="bid-modifier bid-modifier-negative">${modifier}%</span>`;
            } else {
                return `<span class="bid-modifier bid-modifier-zero">0%</span>`;
            }
        }

        function renderBiddingStrategy(strategy) {
            const s = (strategy || '').toLowerCase();
            if (s.includes('down only') || s.includes('down-only')) {
                return `<span class="bidding-strategy bidding-down">Dynamic - Down</span>`;
            } else if (s.includes('up and down') || s.includes('up-and-down')) {
                return `<span class="bidding-strategy bidding-up-down">Dynamic - Up/Down</span>`;
            } else if (s.includes('fixed')) {
                return `<span class="bidding-strategy bidding-fixed">Fixed</span>`;
            }
            return `<span class="bidding-strategy">${escapeHtml(strategy || 'Unknown')}</span>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderAsinPerformanceTable() {
            const marketplace = marketplaceSelect.value;
            const baseUrl = `https://www.amazon.${marketplace}/dp/`;

            // Get all Product ads from SP (these have ASINs)
            const spProductAds = parsedData.sp.filter(r => r.Entity === 'Product ad');
            
            // Get SB Video campaigns - extract ASIN from Landing page URL
            const sbVideoCampaigns = parsedData.sb.filter(r => {
                const format = (r['Ad format'] || r['Ad format (Informational only)'] || '').toLowerCase();
                return r.Entity === 'Campaign' && format.includes('video');
            });

            // Aggregate SP data by ASIN
            const asinDataMap = new Map();

            // Process SP Product Ads
            spProductAds.forEach(row => {
                const asin = (row['ASIN (Informational only)'] || '').toUpperCase();
                if (!asin || asin.length < 10) return;

                if (!asinDataMap.has(asin)) {
                    asinDataMap.set(asin, {
                        asin,
                        sp: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                        sb: { spend: 0, sales: 0, clicks: 0, orders: 0 }
                    });
                }

                const data = asinDataMap.get(asin);
                data.sp.spend += parseFloat(row.Spend) || 0;
                data.sp.sales += parseFloat(row.Sales) || 0;
                data.sp.clicks += parseFloat(row.Clicks) || 0;
                data.sp.orders += parseFloat(row.Orders) || 0;
            });

            // Process SB Video Campaigns - extract ASIN from Landing page URL
            sbVideoCampaigns.forEach(row => {
                const landingPageUrl = row['Landing page URL'] || '';
                const asin = extractAsinFromUrl(landingPageUrl);
                
                if (!asin) return;

                if (!asinDataMap.has(asin)) {
                    asinDataMap.set(asin, {
                        asin,
                        sp: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                        sb: { spend: 0, sales: 0, clicks: 0, orders: 0 }
                    });
                }

                const data = asinDataMap.get(asin);
                data.sb.spend += parseFloat(row.Spend) || 0;
                data.sb.sales += parseFloat(row.Sales) || 0;
                data.sb.clicks += parseFloat(row.Clicks) || 0;
                data.sb.orders += parseFloat(row.Orders) || 0;
            });

            // Convert to array and calculate metrics
            let asinRows = Array.from(asinDataMap.values()).map(item => {
                const sp = {
                    ...item.sp,
                    cpc: item.sp.clicks > 0 ? item.sp.spend / item.sp.clicks : 0,
                    cvr: item.sp.clicks > 0 ? item.sp.orders / item.sp.clicks : 0,
                    acos: item.sp.sales > 0 ? item.sp.spend / item.sp.sales : 0
                };
                const sb = {
                    ...item.sb,
                    cpc: item.sb.clicks > 0 ? item.sb.spend / item.sb.clicks : 0,
                    cvr: item.sb.clicks > 0 ? item.sb.orders / item.sb.clicks : 0,
                    acos: item.sb.sales > 0 ? item.sb.spend / item.sb.sales : 0
                };
                const total = {
                    spend: sp.spend + sb.spend,
                    sales: sp.sales + sb.sales,
                    clicks: sp.clicks + sb.clicks,
                    orders: sp.orders + sb.orders
                };
                total.cpc = total.clicks > 0 ? total.spend / total.clicks : 0;
                total.cvr = total.clicks > 0 ? total.orders / total.clicks : 0;
                total.acos = total.sales > 0 ? total.spend / total.sales : 0;

                return { asin: item.asin, sp, sb, total };
            });

            // Sort by total spend descending
            asinRows.sort((a, b) => b.total.spend - a.total.spend);

            // Calculate grand totals
            const grandTotal = asinRows.reduce((acc, r) => ({
                sp: { spend: acc.sp.spend + r.sp.spend, sales: acc.sp.sales + r.sp.sales, clicks: acc.sp.clicks + r.sp.clicks, orders: acc.sp.orders + r.sp.orders },
                sb: { spend: acc.sb.spend + r.sb.spend, sales: acc.sb.sales + r.sb.sales, clicks: acc.sb.clicks + r.sb.clicks, orders: acc.sb.orders + r.sb.orders },
                total: { spend: acc.total.spend + r.total.spend, sales: acc.total.sales + r.total.sales, clicks: acc.total.clicks + r.total.clicks, orders: acc.total.orders + r.total.orders }
            }), {
                sp: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                sb: { spend: 0, sales: 0, clicks: 0, orders: 0 },
                total: { spend: 0, sales: 0, clicks: 0, orders: 0 }
            });

            grandTotal.sp.cpc = grandTotal.sp.clicks > 0 ? grandTotal.sp.spend / grandTotal.sp.clicks : 0;
            grandTotal.sp.cvr = grandTotal.sp.clicks > 0 ? grandTotal.sp.orders / grandTotal.sp.clicks : 0;
            grandTotal.sp.acos = grandTotal.sp.sales > 0 ? grandTotal.sp.spend / grandTotal.sp.sales : 0;
            grandTotal.sb.cpc = grandTotal.sb.clicks > 0 ? grandTotal.sb.spend / grandTotal.sb.clicks : 0;
            grandTotal.sb.cvr = grandTotal.sb.clicks > 0 ? grandTotal.sb.orders / grandTotal.sb.clicks : 0;
            grandTotal.sb.acos = grandTotal.sb.sales > 0 ? grandTotal.sb.spend / grandTotal.sb.sales : 0;
            grandTotal.total.cpc = grandTotal.total.clicks > 0 ? grandTotal.total.spend / grandTotal.total.clicks : 0;
            grandTotal.total.cvr = grandTotal.total.clicks > 0 ? grandTotal.total.orders / grandTotal.total.clicks : 0;
            grandTotal.total.acos = grandTotal.total.sales > 0 ? grandTotal.total.spend / grandTotal.total.sales : 0;

            if (asinRows.length === 0) {
                document.getElementById('asinPerformanceTable').innerHTML = `<div class="empty-state">No ASIN data found. Make sure your bulk file contains Product ads.</div>`;
                return;
            }

            document.getElementById('asinPerformanceTable').innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2">Link</th>
                            <th rowspan="2">ASIN</th>
                            <th colspan="7" class="header-group header-sp">SP</th>
                            <th colspan="7" class="header-group header-sb">SB Video</th>
                            <th colspan="7" class="header-group header-total">TOTAL</th>
                            <th rowspan="2">% Spend</th>
                        </tr>
                        <tr>
                            <th>Ad Sales</th><th>Ad Spend</th><th>Clicks</th><th>Orders</th><th>CPC</th><th>CVR</th><th>ACOS</th>
                            <th>Ad Sales</th><th>Ad Spend</th><th>Clicks</th><th>Orders</th><th>CPC</th><th>CVR</th><th>ACOS</th>
                            <th>Ad Sales</th><th>Ad Spend</th><th>Clicks</th><th>Orders</th><th>CPC</th><th>CVR</th><th>ACOS</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${asinRows.map(r => {
                            const pSpend = grandTotal.total.spend > 0 ? r.total.spend / grandTotal.total.spend : 0;
                            return `<tr>
                                <td><a href="${baseUrl}${r.asin}" target="_blank" class="asin-link"> Link</a></td>
                                <td style="font-family: 'JetBrains Mono', monospace;">${r.asin}</td>
                                <td>${formatCurrency(r.sp.sales)}</td>
                                <td>${formatCurrency(r.sp.spend)}</td>
                                <td>${formatNumber(r.sp.clicks)}</td>
                                <td>${formatNumber(r.sp.orders)}</td>
                                <td>${r.sp.clicks > 0 ? formatDecimal(r.sp.cpc) : ''}</td>
                                <td>${r.sp.clicks > 0 ? formatPercent(r.sp.cvr) : ''}</td>
                                <td class="${getAcosColorClass(r.sp.acos)}">${r.sp.sales > 0 ? formatPercent(r.sp.acos) : ''}</td>
                                <td>${formatCurrency(r.sb.sales)}</td>
                                <td>${formatCurrency(r.sb.spend)}</td>
                                <td>${formatNumber(r.sb.clicks)}</td>
                                <td>${formatNumber(r.sb.orders)}</td>
                                <td>${r.sb.clicks > 0 ? formatDecimal(r.sb.cpc) : ''}</td>
                                <td>${r.sb.clicks > 0 ? formatPercent(r.sb.cvr) : ''}</td>
                                <td class="${getAcosColorClass(r.sb.acos)}">${r.sb.sales > 0 ? formatPercent(r.sb.acos) : ''}</td>
                                <td>${formatCurrency(r.total.sales)}</td>
                                <td>${formatCurrency(r.total.spend)}</td>
                                <td>${formatNumber(r.total.clicks)}</td>
                                <td>${formatNumber(r.total.orders)}</td>
                                <td>${r.total.clicks > 0 ? formatDecimal(r.total.cpc) : ''}</td>
                                <td>${r.total.clicks > 0 ? formatPercent(r.total.cvr) : ''}</td>
                                <td class="${getAcosColorClass(r.total.acos)}">${r.total.sales > 0 ? formatPercent(r.total.acos) : ''}</td>
                                <td class="${getSpendColorClass(pSpend)}">${formatPercent(pSpend, 1)}</td>
                            </tr>`;
                        }).join('')}
                        <tr class="total-row">
                            <td></td>
                            <td>Total</td>
                            <td>${formatCurrency(grandTotal.sp.sales)}</td>
                            <td>${formatCurrency(grandTotal.sp.spend)}</td>
                            <td>${formatNumber(grandTotal.sp.clicks)}</td>
                            <td>${formatNumber(grandTotal.sp.orders)}</td>
                            <td>${formatDecimal(grandTotal.sp.cpc)}</td>
                            <td>${formatPercent(grandTotal.sp.cvr)}</td>
                            <td class="${getAcosColorClass(grandTotal.sp.acos)}">${formatPercent(grandTotal.sp.acos)}</td>
                            <td>${formatCurrency(grandTotal.sb.sales)}</td>
                            <td>${formatCurrency(grandTotal.sb.spend)}</td>
                            <td>${formatNumber(grandTotal.sb.clicks)}</td>
                            <td>${formatNumber(grandTotal.sb.orders)}</td>
                            <td>${formatDecimal(grandTotal.sb.cpc)}</td>
                            <td>${formatPercent(grandTotal.sb.cvr)}</td>
                            <td class="${getAcosColorClass(grandTotal.sb.acos)}">${formatPercent(grandTotal.sb.acos)}</td>
                            <td>${formatCurrency(grandTotal.total.sales)}</td>
                            <td>${formatCurrency(grandTotal.total.spend)}</td>
                            <td>${formatNumber(grandTotal.total.clicks)}</td>
                            <td>${formatNumber(grandTotal.total.orders)}</td>
                            <td>${formatDecimal(grandTotal.total.cpc)}</td>
                            <td>${formatPercent(grandTotal.total.cvr)}</td>
                            <td class="${getAcosColorClass(grandTotal.total.acos)}">${formatPercent(grandTotal.total.acos)}</td>
                            <td>100.0%</td>
                        </tr>
                    </tbody>
                </table>`;
        }

        // ==================== ACTIONABLE INSIGHTS FUNCTIONS ====================

        // Sort state management for each table
        const insightSortState = {
            st0Sales: { column: null, direction: null },
            stHighAcos: { column: null, direction: null },
            stPerforming: { column: null, direction: null },
            kw0Sales: { column: null, direction: null },
            kwHighAcos: { column: null, direction: null },
            kwPerforming: { column: null, direction: null },
            campHighAcos: { column: null, direction: null }
        };

        function handleInsightSort(tableKey, column, renderFn) {
            const state = insightSortState[tableKey];
            if (state.column === column) {
                if (state.direction === 'desc') {
                    state.direction = 'asc';
                } else if (state.direction === 'asc') {
                    state.column = null;
                    state.direction = null;
                } else {
                    state.direction = 'desc';
                }
            } else {
                state.column = column;
                state.direction = 'desc';
            }
            renderFn();
        }

        function getSortIcon(tableKey, column) {
            const state = insightSortState[tableKey];
            if (state.column !== column) return '<span class="sort-icon"></span>';
            if (state.direction === 'desc') return '<span class="sort-icon active"></span>';
            if (state.direction === 'asc') return '<span class="sort-icon active"></span>';
            return '<span class="sort-icon"></span>';
        }

        function sortInsightDataAggregated(data, tableKey, defaultSort) {
            const state = insightSortState[tableKey];
            const sortColumn = state.column || defaultSort.column;
            const sortDirection = state.direction || defaultSort.direction;
            
            if (!sortColumn) return data;
            
            return [...data].sort((a, b) => {
                let aVal, bVal;
                
                switch (sortColumn) {
                    case 'searchTerm':
                        aVal = (a.searchTerm || '').toLowerCase();
                        bVal = (b.searchTerm || '').toLowerCase();
                        break;
                    case 'keyword':
                        aVal = (a.keyword || '').toLowerCase();
                        bVal = (b.keyword || '').toLowerCase();
                        break;
                    case 'campaign':
                        aVal = (a.campaign || '').toLowerCase();
                        bVal = (b.campaign || '').toLowerCase();
                        break;
                    case 'targeting':
                        aVal = (a.targeting || '').toLowerCase();
                        bVal = (b.targeting || '').toLowerCase();
                        break;
                    case 'impressions':
                        aVal = a.impressions || 0;
                        bVal = b.impressions || 0;
                        break;
                    case 'clicks':
                        aVal = a.clicks || 0;
                        bVal = b.clicks || 0;
                        break;
                    case 'spend':
                        aVal = a.spend || 0;
                        bVal = b.spend || 0;
                        break;
                    case 'sales':
                        aVal = a.sales || 0;
                        bVal = b.sales || 0;
                        break;
                    case 'orders':
                        aVal = a.orders || 0;
                        bVal = b.orders || 0;
                        break;
                    case 'cpc':
                        aVal = a.clicks > 0 ? a.spend / a.clicks : 0;
                        bVal = b.clicks > 0 ? b.spend / b.clicks : 0;
                        break;
                    case 'cvr':
                        aVal = a.clicks > 0 ? a.orders / a.clicks : 0;
                        bVal = b.clicks > 0 ? b.orders / b.clicks : 0;
                        break;
                    case 'acos':
                        aVal = a.sales > 0 ? a.spend / a.sales : (a.spend > 0 ? 999999 : 0);
                        bVal = b.sales > 0 ? b.spend / b.sales : (b.spend > 0 ? 999999 : 0);
                        break;
                    default:
                        return 0;
                }
                
                if (typeof aVal === 'string') {
                    return sortDirection === 'desc' ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
                }
                return sortDirection === 'desc' ? bVal - aVal : aVal - bVal;
            });
        }

        // Search Terms with 0 Sales
        function renderSearchTerms0Sales() {
            const minSpend = parseFloat(document.getElementById('st0SalesMinSpend').value) || 0;
            const maxOrders = parseFloat(document.getElementById('st0SalesMaxOrders').value) || 0;
            
            // First aggregate by search term
            const searchTermMap = new Map();
            parsedData.searchTerms.forEach(row => {
                const term = row['Customer search term'] || '';
                if (!term) return;
                
                if (!searchTermMap.has(term)) {
                    searchTermMap.set(term, {
                        searchTerm: term,
                        impressions: 0,
                        clicks: 0,
                        spend: 0,
                        sales: 0,
                        orders: 0
                    });
                }
                const data = searchTermMap.get(term);
                data.impressions += parseFloat(row.Impressions) || 0;
                data.clicks += parseFloat(row.Clicks) || 0;
                data.spend += parseFloat(row.Spend) || 0;
                data.sales += parseFloat(row.Sales) || 0;
                data.orders += parseFloat(row.Orders) || 0;
            });
            
            // Filter aggregated data
            let searchTerms = Array.from(searchTermMap.values()).filter(row => {
                return row.spend >= minSpend && row.orders <= maxOrders;
            });
            
            // Sort data
            searchTerms = sortInsightDataAggregated(searchTerms, 'st0Sales', { column: 'spend', direction: 'desc' });
            
            // Calculate totals
            const totalSpend = searchTerms.reduce((sum, r) => sum + r.spend, 0);
            const totalClicks = searchTerms.reduce((sum, r) => sum + r.clicks, 0);
            
            // Update summary
            const summaryEl = document.getElementById('st0SalesSummary');
            summaryEl.className = 'insight-summary bad';
            summaryEl.innerHTML = `
                <div class="insight-summary-item"><span class="insight-summary-label">Count:</span><span class="insight-summary-value">${formatNumber(searchTerms.length)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Spend:</span><span class="insight-summary-value">${formatCurrencyDecimal(totalSpend)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Clicks:</span><span class="insight-summary-value">${formatNumber(totalClicks)}</span></div>
            `;
            
            const tableEl = document.getElementById('st0SalesTable');
            if (searchTerms.length === 0) {
                tableEl.innerHTML = `<div class="insight-empty good"> No search terms with 0 sales found matching the filters</div>`;
                return;
            }
            
            tableEl.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable-header" onclick="handleInsightSort('st0Sales', 'searchTerm', renderSearchTerms0Sales)">Search Term ${getSortIcon('st0Sales', 'searchTerm')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('st0Sales', 'impressions', renderSearchTerms0Sales)">Impr. ${getSortIcon('st0Sales', 'impressions')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('st0Sales', 'clicks', renderSearchTerms0Sales)">Clicks ${getSortIcon('st0Sales', 'clicks')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('st0Sales', 'spend', renderSearchTerms0Sales)">Spend ${getSortIcon('st0Sales', 'spend')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('st0Sales', 'cpc', renderSearchTerms0Sales)">CPC ${getSortIcon('st0Sales', 'cpc')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${searchTerms.slice(0, 100).map(row => {
                            const cpc = row.clicks > 0 ? row.spend / row.clicks : 0;
                            return `<tr>
                                <td class="search-term-text" title="${escapeHtml(row.searchTerm)}">${escapeHtml(row.searchTerm)}</td>
                                <td>${formatNumber(row.impressions)}</td>
                                <td>${formatNumber(row.clicks)}</td>
                                <td>${formatCurrencyDecimal(row.spend)}</td>
                                <td>${row.clicks > 0 ? formatCPC(cpc) : '-'}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
                ${searchTerms.length > 100 ? `<div style="padding:0.5rem;text-align:center;color:#666;font-size:0.75rem;">Showing top 100 of ${formatNumber(searchTerms.length)} results</div>` : ''}
            `;
        }

        // Search Terms with High ACOS
        function renderSearchTermsHighAcos() {
            const minSpend = parseFloat(document.getElementById('stHighAcosMinSpend').value) || 0;
            const minAcos = (parseFloat(document.getElementById('stHighAcosMinAcos').value) || 0) / 100;
            
            // First aggregate by search term
            const searchTermMap = new Map();
            parsedData.searchTerms.forEach(row => {
                const term = row['Customer search term'] || '';
                if (!term) return;
                
                if (!searchTermMap.has(term)) {
                    searchTermMap.set(term, {
                        searchTerm: term,
                        impressions: 0,
                        clicks: 0,
                        spend: 0,
                        sales: 0,
                        orders: 0
                    });
                }
                const data = searchTermMap.get(term);
                data.impressions += parseFloat(row.Impressions) || 0;
                data.clicks += parseFloat(row.Clicks) || 0;
                data.spend += parseFloat(row.Spend) || 0;
                data.sales += parseFloat(row.Sales) || 0;
                data.orders += parseFloat(row.Orders) || 0;
            });
            
            // Filter aggregated data
            let searchTerms = Array.from(searchTermMap.values()).filter(row => {
                const acos = row.sales > 0 ? row.spend / row.sales : (row.spend > 0 ? Infinity : 0);
                return row.spend >= minSpend && acos >= minAcos;
            });
            
            // Sort data
            searchTerms = sortInsightDataAggregated(searchTerms, 'stHighAcos', { column: 'spend', direction: 'desc' });
            
            // Calculate totals
            const totalSpend = searchTerms.reduce((sum, r) => sum + r.spend, 0);
            const totalSales = searchTerms.reduce((sum, r) => sum + r.sales, 0);
            const totalOrders = searchTerms.reduce((sum, r) => sum + r.orders, 0);
            
            const summaryEl = document.getElementById('stHighAcosSummary');
            summaryEl.className = 'insight-summary bad';
            summaryEl.innerHTML = `
                <div class="insight-summary-item"><span class="insight-summary-label">Count:</span><span class="insight-summary-value">${formatNumber(searchTerms.length)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Spend:</span><span class="insight-summary-value">${formatCurrencyDecimal(totalSpend)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Sales:</span><span class="insight-summary-value">${formatCurrencyDecimal(totalSales)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Orders:</span><span class="insight-summary-value">${formatNumber(totalOrders)}</span></div>
            `;
            
            const tableEl = document.getElementById('stHighAcosTable');
            if (searchTerms.length === 0) {
                tableEl.innerHTML = `<div class="insight-empty good"> No search terms with high ACOS found matching the filters</div>`;
                return;
            }
            
            tableEl.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable-header" onclick="handleInsightSort('stHighAcos', 'searchTerm', renderSearchTermsHighAcos)">Search Term ${getSortIcon('stHighAcos', 'searchTerm')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('stHighAcos', 'clicks', renderSearchTermsHighAcos)">Clicks ${getSortIcon('stHighAcos', 'clicks')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('stHighAcos', 'orders', renderSearchTermsHighAcos)">Orders ${getSortIcon('stHighAcos', 'orders')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('stHighAcos', 'spend', renderSearchTermsHighAcos)">Spend ${getSortIcon('stHighAcos', 'spend')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('stHighAcos', 'sales', renderSearchTermsHighAcos)">Sales ${getSortIcon('stHighAcos', 'sales')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('stHighAcos', 'cpc', renderSearchTermsHighAcos)">CPC ${getSortIcon('stHighAcos', 'cpc')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('stHighAcos', 'cvr', renderSearchTermsHighAcos)">CVR ${getSortIcon('stHighAcos', 'cvr')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('stHighAcos', 'acos', renderSearchTermsHighAcos)">ACOS ${getSortIcon('stHighAcos', 'acos')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${searchTerms.slice(0, 100).map(row => {
                            const cpc = row.clicks > 0 ? row.spend / row.clicks : 0;
                            const cvr = row.clicks > 0 ? row.orders / row.clicks : 0;
                            const acos = row.sales > 0 ? row.spend / row.sales : (row.spend > 0 ? Infinity : 0);
                            return `<tr>
                                <td class="search-term-text" title="${escapeHtml(row.searchTerm)}">${escapeHtml(row.searchTerm)}</td>
                                <td>${formatNumber(row.clicks)}</td>
                                <td>${formatNumber(row.orders)}</td>
                                <td>${formatCurrencyDecimal(row.spend)}</td>
                                <td>${formatCurrencyDecimal(row.sales)}</td>
                                <td>${row.clicks > 0 ? formatCPC(cpc) : '-'}</td>
                                <td>${row.clicks > 0 ? formatPercent(cvr, 1) : '-'}</td>
                                <td class="${getAcosColorClass(acos)}">${acos === Infinity ? '' : formatPercent(acos, 1)}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
                ${searchTerms.length > 100 ? `<div style="padding:0.5rem;text-align:center;color:#666;font-size:0.75rem;">Showing top 100 of ${formatNumber(searchTerms.length)} results</div>` : ''}
            `;
        }

        // Performing Search Terms
        function renderSearchTermsPerforming() {
            const minCvr = (parseFloat(document.getElementById('stPerformingMinCvr').value) || 0) / 100;
            const minOrders = parseFloat(document.getElementById('stPerformingMinOrders').value) || 0;
            
            // First aggregate by search term
            const searchTermMap = new Map();
            parsedData.searchTerms.forEach(row => {
                const term = row['Customer search term'] || '';
                if (!term) return;
                
                if (!searchTermMap.has(term)) {
                    searchTermMap.set(term, {
                        searchTerm: term,
                        impressions: 0,
                        clicks: 0,
                        spend: 0,
                        sales: 0,
                        orders: 0
                    });
                }
                const data = searchTermMap.get(term);
                data.impressions += parseFloat(row.Impressions) || 0;
                data.clicks += parseFloat(row.Clicks) || 0;
                data.spend += parseFloat(row.Spend) || 0;
                data.sales += parseFloat(row.Sales) || 0;
                data.orders += parseFloat(row.Orders) || 0;
            });
            
            // Filter aggregated data
            let searchTerms = Array.from(searchTermMap.values()).filter(row => {
                const cvr = row.clicks > 0 ? row.orders / row.clicks : 0;
                return cvr >= minCvr && row.orders >= minOrders;
            });
            
            // Sort data
            searchTerms = sortInsightDataAggregated(searchTerms, 'stPerforming', { column: 'orders', direction: 'desc' });
            
            // Calculate totals
            const totalSpend = searchTerms.reduce((sum, r) => sum + r.spend, 0);
            const totalSales = searchTerms.reduce((sum, r) => sum + r.sales, 0);
            const totalOrders = searchTerms.reduce((sum, r) => sum + r.orders, 0);
            
            const summaryEl = document.getElementById('stPerformingSummary');
            summaryEl.className = 'insight-summary good';
            summaryEl.innerHTML = `
                <div class="insight-summary-item"><span class="insight-summary-label">Count:</span><span class="insight-summary-value">${formatNumber(searchTerms.length)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Orders:</span><span class="insight-summary-value">${formatNumber(totalOrders)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Sales:</span><span class="insight-summary-value">${formatCurrencyDecimal(totalSales)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Spend:</span><span class="insight-summary-value">${formatCurrencyDecimal(totalSpend)}</span></div>
            `;
            
            const tableEl = document.getElementById('stPerformingTable');
            if (searchTerms.length === 0) {
                tableEl.innerHTML = `<div class="insight-empty">No performing search terms found matching the filters</div>`;
                return;
            }
            
            tableEl.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable-header" onclick="handleInsightSort('stPerforming', 'searchTerm', renderSearchTermsPerforming)">Search Term ${getSortIcon('stPerforming', 'searchTerm')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('stPerforming', 'clicks', renderSearchTermsPerforming)">Clicks ${getSortIcon('stPerforming', 'clicks')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('stPerforming', 'orders', renderSearchTermsPerforming)">Orders ${getSortIcon('stPerforming', 'orders')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('stPerforming', 'sales', renderSearchTermsPerforming)">Sales ${getSortIcon('stPerforming', 'sales')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('stPerforming', 'spend', renderSearchTermsPerforming)">Spend ${getSortIcon('stPerforming', 'spend')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('stPerforming', 'cvr', renderSearchTermsPerforming)">CVR ${getSortIcon('stPerforming', 'cvr')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('stPerforming', 'acos', renderSearchTermsPerforming)">ACOS ${getSortIcon('stPerforming', 'acos')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${searchTerms.slice(0, 100).map(row => {
                            const cvr = row.clicks > 0 ? row.orders / row.clicks : 0;
                            const acos = row.sales > 0 ? row.spend / row.sales : 0;
                            return `<tr>
                                <td class="search-term-text" title="${escapeHtml(row.searchTerm)}">${escapeHtml(row.searchTerm)}</td>
                                <td>${formatNumber(row.clicks)}</td>
                                <td>${formatNumber(row.orders)}</td>
                                <td>${formatCurrencyDecimal(row.sales)}</td>
                                <td>${formatCurrencyDecimal(row.spend)}</td>
                                <td style="color:#16a34a;font-weight:600;">${formatPercent(cvr, 1)}</td>
                                <td class="${getAcosColorClass(acos)}">${formatPercent(acos, 1)}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
                ${searchTerms.length > 100 ? `<div style="padding:0.5rem;text-align:center;color:#666;font-size:0.75rem;">Showing top 100 of ${formatNumber(searchTerms.length)} results</div>` : ''}
            `;
        }

        // Keywords with 0 Sales
        function renderKeywords0Sales() {
            const minSpend = parseFloat(document.getElementById('kw0SalesMinSpend').value) || 0;
            const maxOrders = parseFloat(document.getElementById('kw0SalesMaxOrders').value) || 0;
            
            // First aggregate by keyword
            const keywordMap = new Map();
            parsedData.sp.forEach(row => {
                const entity = (row.Entity || '').toLowerCase();
                const matchType = (row['Match type'] || '').toLowerCase();
                if (entity !== 'keyword' || matchType.includes('negative')) return;
                
                const keyword = row['Keyword text'] || '';
                if (!keyword) return;
                
                // Use keyword + match type as key to keep different match types separate
                const key = keyword.toLowerCase() + '|' + matchType;
                
                if (!keywordMap.has(key)) {
                    keywordMap.set(key, {
                        keyword: keyword,
                        matchType: row['Match type'] || '',
                        impressions: 0,
                        clicks: 0,
                        spend: 0,
                        sales: 0,
                        orders: 0,
                        campaigns: new Set()
                    });
                }
                const data = keywordMap.get(key);
                data.impressions += parseFloat(row.Impressions) || 0;
                data.clicks += parseFloat(row.Clicks) || 0;
                data.spend += parseFloat(row.Spend) || 0;
                data.sales += parseFloat(row.Sales) || 0;
                data.orders += parseFloat(row.Orders) || 0;
                const campaign = row['Campaign name (Informational only)'] || row['Campaign name'] || '';
                if (campaign) data.campaigns.add(campaign);
            });
            
            // Filter aggregated data
            let keywords = Array.from(keywordMap.values()).filter(row => {
                return row.spend >= minSpend && row.orders <= maxOrders;
            });
            
            // Sort data
            keywords = sortInsightDataAggregated(keywords, 'kw0Sales', { column: 'spend', direction: 'desc' });
            
            // Calculate totals
            const totalSpend = keywords.reduce((sum, r) => sum + r.spend, 0);
            const totalClicks = keywords.reduce((sum, r) => sum + r.clicks, 0);
            
            const summaryEl = document.getElementById('kw0SalesSummary');
            summaryEl.className = 'insight-summary bad';
            summaryEl.innerHTML = `
                <div class="insight-summary-item"><span class="insight-summary-label">Count:</span><span class="insight-summary-value">${formatNumber(keywords.length)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Spend:</span><span class="insight-summary-value">${formatCurrencyDecimal(totalSpend)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Clicks:</span><span class="insight-summary-value">${formatNumber(totalClicks)}</span></div>
            `;
            
            const tableEl = document.getElementById('kw0SalesTable');
            if (keywords.length === 0) {
                tableEl.innerHTML = `<div class="insight-empty good"> No keywords with 0 sales found matching the filters</div>`;
                return;
            }
            
            tableEl.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable-header" onclick="handleInsightSort('kw0Sales', 'keyword', renderKeywords0Sales)">Keyword ${getSortIcon('kw0Sales', 'keyword')}</th>
                            <th>Match</th>
                            <th>Campaigns</th>
                            <th class="sortable-header" onclick="handleInsightSort('kw0Sales', 'clicks', renderKeywords0Sales)">Clicks ${getSortIcon('kw0Sales', 'clicks')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('kw0Sales', 'spend', renderKeywords0Sales)">Spend ${getSortIcon('kw0Sales', 'spend')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('kw0Sales', 'cpc', renderKeywords0Sales)">CPC ${getSortIcon('kw0Sales', 'cpc')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${keywords.slice(0, 100).map(row => {
                            const cpc = row.clicks > 0 ? row.spend / row.clicks : 0;
                            return `<tr>
                                <td class="keyword-text" title="${escapeHtml(row.keyword)}">${escapeHtml(row.keyword)}</td>
                                <td>${row.matchType}</td>
                                <td>${row.campaigns.size}</td>
                                <td>${formatNumber(row.clicks)}</td>
                                <td>${formatCurrencyDecimal(row.spend)}</td>
                                <td>${row.clicks > 0 ? formatCPC(cpc) : '-'}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
                ${keywords.length > 100 ? `<div style="padding:0.5rem;text-align:center;color:#666;font-size:0.75rem;">Showing top 100 of ${formatNumber(keywords.length)} results</div>` : ''}
            `;
        }

        // Keywords with High ACOS
        function renderKeywordsHighAcos() {
            const minSpend = parseFloat(document.getElementById('kwHighAcosMinSpend').value) || 0;
            const minAcos = (parseFloat(document.getElementById('kwHighAcosMinAcos').value) || 0) / 100;
            
            // First aggregate by keyword + match type
            const keywordMap = new Map();
            parsedData.sp.forEach(row => {
                const entity = (row.Entity || '').toLowerCase();
                const matchType = (row['Match type'] || '').toLowerCase();
                if (entity !== 'keyword' || matchType.includes('negative')) return;
                
                const keyword = row['Keyword text'] || '';
                if (!keyword) return;
                
                // Use keyword + match type as key
                const key = keyword.toLowerCase() + '|' + matchType;
                
                if (!keywordMap.has(key)) {
                    keywordMap.set(key, {
                        keyword: keyword,
                        matchType: row['Match type'] || '',
                        impressions: 0,
                        clicks: 0,
                        spend: 0,
                        sales: 0,
                        orders: 0
                    });
                }
                const data = keywordMap.get(key);
                data.impressions += parseFloat(row.Impressions) || 0;
                data.clicks += parseFloat(row.Clicks) || 0;
                data.spend += parseFloat(row.Spend) || 0;
                data.sales += parseFloat(row.Sales) || 0;
                data.orders += parseFloat(row.Orders) || 0;
            });
            
            // Filter aggregated data
            let keywords = Array.from(keywordMap.values()).filter(row => {
                const acos = row.sales > 0 ? row.spend / row.sales : (row.spend > 0 ? Infinity : 0);
                return row.spend >= minSpend && acos >= minAcos;
            });
            
            // Sort data
            keywords = sortInsightDataAggregated(keywords, 'kwHighAcos', { column: 'spend', direction: 'desc' });
            
            // Calculate totals
            const totalSpend = keywords.reduce((sum, r) => sum + r.spend, 0);
            const totalSales = keywords.reduce((sum, r) => sum + r.sales, 0);
            const totalOrders = keywords.reduce((sum, r) => sum + r.orders, 0);
            
            const summaryEl = document.getElementById('kwHighAcosSummary');
            summaryEl.className = 'insight-summary bad';
            summaryEl.innerHTML = `
                <div class="insight-summary-item"><span class="insight-summary-label">Count:</span><span class="insight-summary-value">${formatNumber(keywords.length)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Spend:</span><span class="insight-summary-value">${formatCurrencyDecimal(totalSpend)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Sales:</span><span class="insight-summary-value">${formatCurrencyDecimal(totalSales)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Orders:</span><span class="insight-summary-value">${formatNumber(totalOrders)}</span></div>
            `;
            
            const tableEl = document.getElementById('kwHighAcosTable');
            if (keywords.length === 0) {
                tableEl.innerHTML = `<div class="insight-empty good"> No keywords with high ACOS found matching the filters</div>`;
                return;
            }
            
            tableEl.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable-header" onclick="handleInsightSort('kwHighAcos', 'keyword', renderKeywordsHighAcos)">Keyword ${getSortIcon('kwHighAcos', 'keyword')}</th>
                            <th>Match</th>
                            <th class="sortable-header" onclick="handleInsightSort('kwHighAcos', 'clicks', renderKeywordsHighAcos)">Clicks ${getSortIcon('kwHighAcos', 'clicks')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('kwHighAcos', 'orders', renderKeywordsHighAcos)">Orders ${getSortIcon('kwHighAcos', 'orders')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('kwHighAcos', 'spend', renderKeywordsHighAcos)">Spend ${getSortIcon('kwHighAcos', 'spend')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('kwHighAcos', 'sales', renderKeywordsHighAcos)">Sales ${getSortIcon('kwHighAcos', 'sales')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('kwHighAcos', 'cvr', renderKeywordsHighAcos)">CVR ${getSortIcon('kwHighAcos', 'cvr')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('kwHighAcos', 'acos', renderKeywordsHighAcos)">ACOS ${getSortIcon('kwHighAcos', 'acos')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${keywords.slice(0, 100).map(row => {
                            const cvr = row.clicks > 0 ? row.orders / row.clicks : 0;
                            const acos = row.sales > 0 ? row.spend / row.sales : (row.spend > 0 ? Infinity : 0);
                            return `<tr>
                                <td class="keyword-text" title="${escapeHtml(row.keyword)}">${escapeHtml(row.keyword)}</td>
                                <td>${row.matchType}</td>
                                <td>${formatNumber(row.clicks)}</td>
                                <td>${formatNumber(row.orders)}</td>
                                <td>${formatCurrencyDecimal(row.spend)}</td>
                                <td>${formatCurrencyDecimal(row.sales)}</td>
                                <td>${row.clicks > 0 ? formatPercent(cvr, 1) : '-'}</td>
                                <td class="${getAcosColorClass(acos)}">${acos === Infinity ? '' : formatPercent(acos, 1)}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
                ${keywords.length > 100 ? `<div style="padding:0.5rem;text-align:center;color:#666;font-size:0.75rem;">Showing top 100 of ${formatNumber(keywords.length)} results</div>` : ''}
            `;
        }

        // Performing Keywords
        function renderKeywordsPerforming() {
            const minCvr = (parseFloat(document.getElementById('kwPerformingMinCvr').value) || 0) / 100;
            const minOrders = parseFloat(document.getElementById('kwPerformingMinOrders').value) || 0;
            
            // First aggregate by keyword + match type
            const keywordMap = new Map();
            parsedData.sp.forEach(row => {
                const entity = (row.Entity || '').toLowerCase();
                const matchType = (row['Match type'] || '').toLowerCase();
                if (entity !== 'keyword' || matchType.includes('negative')) return;
                
                const keyword = row['Keyword text'] || '';
                if (!keyword) return;
                
                // Use keyword + match type as key
                const key = keyword.toLowerCase() + '|' + matchType;
                
                if (!keywordMap.has(key)) {
                    keywordMap.set(key, {
                        keyword: keyword,
                        matchType: row['Match type'] || '',
                        impressions: 0,
                        clicks: 0,
                        spend: 0,
                        sales: 0,
                        orders: 0
                    });
                }
                const data = keywordMap.get(key);
                data.impressions += parseFloat(row.Impressions) || 0;
                data.clicks += parseFloat(row.Clicks) || 0;
                data.spend += parseFloat(row.Spend) || 0;
                data.sales += parseFloat(row.Sales) || 0;
                data.orders += parseFloat(row.Orders) || 0;
            });
            
            // Filter aggregated data
            let keywords = Array.from(keywordMap.values()).filter(row => {
                const cvr = row.clicks > 0 ? row.orders / row.clicks : 0;
                return cvr >= minCvr && row.orders >= minOrders;
            });
            
            // Sort data
            keywords = sortInsightDataAggregated(keywords, 'kwPerforming', { column: 'orders', direction: 'desc' });
            
            // Calculate totals
            const totalSpend = keywords.reduce((sum, r) => sum + r.spend, 0);
            const totalSales = keywords.reduce((sum, r) => sum + r.sales, 0);
            const totalOrders = keywords.reduce((sum, r) => sum + r.orders, 0);
            
            const summaryEl = document.getElementById('kwPerformingSummary');
            summaryEl.className = 'insight-summary good';
            summaryEl.innerHTML = `
                <div class="insight-summary-item"><span class="insight-summary-label">Count:</span><span class="insight-summary-value">${formatNumber(keywords.length)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Orders:</span><span class="insight-summary-value">${formatNumber(totalOrders)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Sales:</span><span class="insight-summary-value">${formatCurrencyDecimal(totalSales)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Spend:</span><span class="insight-summary-value">${formatCurrencyDecimal(totalSpend)}</span></div>
            `;
            
            const tableEl = document.getElementById('kwPerformingTable');
            if (keywords.length === 0) {
                tableEl.innerHTML = `<div class="insight-empty">No performing keywords found matching the filters</div>`;
                return;
            }
            
            tableEl.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable-header" onclick="handleInsightSort('kwPerforming', 'keyword', renderKeywordsPerforming)">Keyword ${getSortIcon('kwPerforming', 'keyword')}</th>
                            <th>Match</th>
                            <th class="sortable-header" onclick="handleInsightSort('kwPerforming', 'clicks', renderKeywordsPerforming)">Clicks ${getSortIcon('kwPerforming', 'clicks')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('kwPerforming', 'orders', renderKeywordsPerforming)">Orders ${getSortIcon('kwPerforming', 'orders')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('kwPerforming', 'sales', renderKeywordsPerforming)">Sales ${getSortIcon('kwPerforming', 'sales')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('kwPerforming', 'spend', renderKeywordsPerforming)">Spend ${getSortIcon('kwPerforming', 'spend')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('kwPerforming', 'cvr', renderKeywordsPerforming)">CVR ${getSortIcon('kwPerforming', 'cvr')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('kwPerforming', 'acos', renderKeywordsPerforming)">ACOS ${getSortIcon('kwPerforming', 'acos')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${keywords.slice(0, 100).map(row => {
                            const cvr = row.clicks > 0 ? row.orders / row.clicks : 0;
                            const acos = row.sales > 0 ? row.spend / row.sales : 0;
                            return `<tr>
                                <td class="keyword-text" title="${escapeHtml(row.keyword)}">${escapeHtml(row.keyword)}</td>
                                <td>${row.matchType}</td>
                                <td>${formatNumber(row.clicks)}</td>
                                <td>${formatNumber(row.orders)}</td>
                                <td>${formatCurrencyDecimal(row.sales)}</td>
                                <td>${formatCurrencyDecimal(row.spend)}</td>
                                <td style="color:#16a34a;font-weight:600;">${formatPercent(cvr, 1)}</td>
                                <td class="${getAcosColorClass(acos)}">${formatPercent(acos, 1)}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
                ${keywords.length > 100 ? `<div style="padding:0.5rem;text-align:center;color:#666;font-size:0.75rem;">Showing top 100 of ${formatNumber(keywords.length)} results</div>` : ''}
            `;
        }

        // Campaigns with High ACOS
        function renderCampaignsHighAcos() {
            const minSpend = parseFloat(document.getElementById('campHighAcosMinSpend').value) || 0;
            const minAcos = (parseFloat(document.getElementById('campHighAcosMinAcos').value) || 0) / 100;
            
            // Filter campaign-level data
            let campaigns = parsedData.sp.filter(row => {
                const entity = (row.Entity || '').toLowerCase();
                if (entity !== 'campaign') return false;
                
                const spend = parseFloat(row.Spend) || 0;
                const sales = parseFloat(row.Sales) || 0;
                const acos = sales > 0 ? spend / sales : (spend > 0 ? Infinity : 0);
                return spend >= minSpend && acos >= minAcos;
            }).map(row => ({
                campaign: row['Campaign name (Informational only)'] || row['Campaign name'] || '',
                targeting: row['Targeting type'] || '',
                impressions: parseFloat(row.Impressions) || 0,
                clicks: parseFloat(row.Clicks) || 0,
                spend: parseFloat(row.Spend) || 0,
                sales: parseFloat(row.Sales) || 0,
                orders: parseFloat(row.Orders) || 0
            }));
            
            // Sort data
            campaigns = sortInsightDataAggregated(campaigns, 'campHighAcos', { column: 'spend', direction: 'desc' });
            
            // Calculate totals
            const totalSpend = campaigns.reduce((sum, r) => sum + r.spend, 0);
            const totalSales = campaigns.reduce((sum, r) => sum + r.sales, 0);
            const totalOrders = campaigns.reduce((sum, r) => sum + r.orders, 0);
            
            const summaryEl = document.getElementById('campHighAcosSummary');
            summaryEl.className = 'insight-summary bad';
            summaryEl.innerHTML = `
                <div class="insight-summary-item"><span class="insight-summary-label">Count:</span><span class="insight-summary-value">${formatNumber(campaigns.length)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Spend:</span><span class="insight-summary-value">${formatCurrencyDecimal(totalSpend)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Sales:</span><span class="insight-summary-value">${formatCurrencyDecimal(totalSales)}</span></div>
                <div class="insight-summary-item"><span class="insight-summary-label">Total Orders:</span><span class="insight-summary-value">${formatNumber(totalOrders)}</span></div>
            `;
            
            const tableEl = document.getElementById('campHighAcosTable');
            if (campaigns.length === 0) {
                tableEl.innerHTML = `<div class="insight-empty good"> No campaigns with high ACOS found matching the filters</div>`;
                return;
            }
            
            tableEl.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable-header" onclick="handleInsightSort('campHighAcos', 'campaign', renderCampaignsHighAcos)">Campaign ${getSortIcon('campHighAcos', 'campaign')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('campHighAcos', 'targeting', renderCampaignsHighAcos)">Targeting ${getSortIcon('campHighAcos', 'targeting')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('campHighAcos', 'clicks', renderCampaignsHighAcos)">Clicks ${getSortIcon('campHighAcos', 'clicks')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('campHighAcos', 'orders', renderCampaignsHighAcos)">Orders ${getSortIcon('campHighAcos', 'orders')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('campHighAcos', 'spend', renderCampaignsHighAcos)">Spend ${getSortIcon('campHighAcos', 'spend')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('campHighAcos', 'sales', renderCampaignsHighAcos)">Sales ${getSortIcon('campHighAcos', 'sales')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('campHighAcos', 'cvr', renderCampaignsHighAcos)">CVR ${getSortIcon('campHighAcos', 'cvr')}</th>
                            <th class="sortable-header" onclick="handleInsightSort('campHighAcos', 'acos', renderCampaignsHighAcos)">ACOS ${getSortIcon('campHighAcos', 'acos')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${campaigns.slice(0, 100).map(row => {
                            const cvr = row.clicks > 0 ? row.orders / row.clicks : 0;
                            const acos = row.sales > 0 ? row.spend / row.sales : (row.spend > 0 ? Infinity : 0);
                            return `<tr>
                                <td class="campaign-name-cell" title="${escapeHtml(row.campaign)}">${escapeHtml(row.campaign)}</td>
                                <td>${row.targeting}</td>
                                <td>${formatNumber(row.clicks)}</td>
                                <td>${formatNumber(row.orders)}</td>
                                <td>${formatCurrencyDecimal(row.spend)}</td>
                                <td>${formatCurrencyDecimal(row.sales)}</td>
                                <td>${row.clicks > 0 ? formatPercent(cvr, 1) : '-'}</td>
                                <td class="${getAcosColorClass(acos)}">${acos === Infinity ? '' : formatPercent(acos, 1)}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
                ${campaigns.length > 100 ? `<div style="padding:0.5rem;text-align:center;color:#666;font-size:0.75rem;">Showing top 100 of ${formatNumber(campaigns.length)} results</div>` : ''}
            `;
        }

        // Make Actionable Insights functions global
        window.handleInsightSort = handleInsightSort;
        window.renderSearchTerms0Sales = renderSearchTerms0Sales;
        window.renderSearchTermsHighAcos = renderSearchTermsHighAcos;
        window.renderSearchTermsPerforming = renderSearchTermsPerforming;
        window.renderKeywords0Sales = renderKeywords0Sales;
        window.renderKeywordsHighAcos = renderKeywordsHighAcos;
        window.renderKeywordsPerforming = renderKeywordsPerforming;
        window.renderCampaignsHighAcos = renderCampaignsHighAcos;

        // ==================== IMPRESSION SHARE TRENDS ====================
        
        const isDropZone = document.getElementById('isDropZone');
        const isFileInput = document.getElementById('isFileInput');
        const isFileInfo = document.getElementById('isFileInfo');
        const isLoading = document.getElementById('isLoading');
        const isResults = document.getElementById('isResults');
        
        let impressionShareSortState = { column: 'spend', direction: 'desc' };
        let isAllPortfolios = [];
        let isAllCampaigns = [];
        let isMinDate = null;
        let isMaxDate = null;
        let isFiltersInitialized = false;
        let currentIsResults = []; // Store current results for chart modal
        let chartModalInstance = null; // Chart.js instance
        
        if (isDropZone) {
            isDropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                isDropZone.classList.add('dragover');
            });
            
            isDropZone.addEventListener('dragleave', () => {
                isDropZone.classList.remove('dragover');
            });
            
            isDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                isDropZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) handleImpressionShareFile(file);
            });
        }
        
        if (isFileInput) {
            isFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleImpressionShareFile(file);
            });
        }
        
        function handleImpressionShareFile(file) {
            if (!file.name.endsWith('.csv')) {
                alert('Please upload a CSV file');
                return;
            }
            
            isFileInfo.textContent = `Loading: ${file.name}`;
            isLoading.style.display = 'block';
            isDropZone.style.display = 'none';
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csvData = parseCSV(e.target.result);
                    parsedData.impressionShare = csvData;
                    
                    // Extract unique portfolios, campaigns, and date range
                    const portfolios = new Set();
                    const campaigns = new Set();
                    isMinDate = null;
                    isMaxDate = null;
                    
                    csvData.forEach(row => {
                        if (row['Portfolio name']) portfolios.add(row['Portfolio name']);
                        if (row['Campaign Name']) campaigns.add(row['Campaign Name']);
                        
                        const date = parseDateString(row['Date'] || '');
                        if (date) {
                            if (!isMinDate || date < isMinDate) isMinDate = date;
                            if (!isMaxDate || date > isMaxDate) isMaxDate = date;
                        }
                    });
                    
                    isAllPortfolios = Array.from(portfolios).sort();
                    isAllCampaigns = Array.from(campaigns).sort();
                    
                    // Populate filters and set date range defaults
                    populateIsFilters();
                    
                    isLoading.style.display = 'none';
                    isResults.style.display = 'block';
                    isFileInfo.textContent = `Loaded: ${file.name} (${csvData.length.toLocaleString()} rows)`;
                    renderImpressionShareTable();
                    
                    // Always rebuild SP rank mapping when impression share data is loaded
                    // This ensures SQP tab has access to rank data
                    buildSpRankMapping();
                    
                    // Refresh SQP table if it's already loaded
                    if (typeof window.getSqpDataLoaded === 'function' && window.getSqpDataLoaded()) {
                        if (typeof window.renderSqpTable === 'function') window.renderSqpTable();
                    }
                } catch (err) {
                    console.error('Error parsing CSV:', err);
                    alert('Error parsing CSV file. Please check the format.');
                    isLoading.style.display = 'none';
                    isDropZone.style.display = 'block';
                }
            };
            reader.readAsText(file);
        }
        
        function populateIsFilters() {
            const portfolioSelect = document.getElementById('isPortfolioFilter');
            const campaignSelect = document.getElementById('isCampaignFilter');
            const dateFromInput = document.getElementById('isDateFrom');
            const dateToInput = document.getElementById('isDateTo');
            const minSpendInput = document.getElementById('isMinSpend');
            const trendFilterSelect = document.getElementById('isTrendFilter');
            
            portfolioSelect.innerHTML = '<option value="all">All Portfolios</option>' +
                isAllPortfolios.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
            
            campaignSelect.innerHTML = '<option value="all">All Campaigns</option>' +
                isAllCampaigns.map(c => `<option value="${escapeHtml(c)}" title="${escapeHtml(c)}">${escapeHtml(c.length > 50 ? c.substring(0, 50) + '...' : c)}</option>`).join('');
            
            // Set date range defaults and constraints based on available data
            if (isMinDate && isMaxDate) {
                const minDateStr = formatDateForInput(isMinDate);
                const maxDateStr = formatDateForInput(isMaxDate);
                
                // Set min and max constraints on both date inputs
                dateFromInput.min = minDateStr;
                dateFromInput.max = maxDateStr;
                dateToInput.min = minDateStr;
                dateToInput.max = maxDateStr;
                
                // Set default values
                dateFromInput.value = minDateStr;
                dateToInput.value = maxDateStr;
            }
            
            // Add event listeners for automatic filter updates (only once)
            if (!isFiltersInitialized) {
                dateFromInput.addEventListener('change', renderImpressionShareTable);
                dateToInput.addEventListener('change', renderImpressionShareTable);
                portfolioSelect.addEventListener('change', renderImpressionShareTable);
                campaignSelect.addEventListener('change', renderImpressionShareTable);
                trendFilterSelect.addEventListener('change', renderImpressionShareTable);
                minSpendInput.addEventListener('input', debounce(renderImpressionShareTable, 300));
                isFiltersInitialized = true;
            }
        }
        
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function parseCSV(text) {
            // Strip BOM if present
            if (text.charCodeAt(0) === 0xFEFF) {
                text = text.slice(1);
            }
            const lines = text.split(/\r?\n/);
            if (lines.length < 2) return [];
            
            const headers = parseCSVLine(lines[0]);
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((h, idx) => {
                    row[h.trim()] = values[idx] || '';
                });
                data.push(row);
            }
            return data;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        function parseDateString(dateStr) {
            const months = { 'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5, 
                           'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11 };
            const match = dateStr.match(/(\w+)\s+(\d+),\s*(\d+)/);
            if (match) {
                const month = months[match[1]];
                const day = parseInt(match[2]);
                const year = parseInt(match[3]);
                return new Date(year, month, day);
            }
            return null;
        }
        
        function formatDateShort(date) {
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}/${day}`;
        }
        
        function renderImpressionShareTable() {
            const dateFromInput = document.getElementById('isDateFrom').value;
            const dateToInput = document.getElementById('isDateTo').value;
            const minSpend = parseFloat(document.getElementById('isMinSpend').value) || 0;
            const portfolioFilter = document.getElementById('isPortfolioFilter').value;
            const campaignFilter = document.getElementById('isCampaignFilter').value;
            const trendFilter = document.getElementById('isTrendFilter').value;
            
            // Parse date filters - use local time by splitting the date string
            let filterDateFrom = isMinDate;
            let filterDateTo = isMaxDate;
            
            if (dateFromInput) {
                const parts = dateFromInput.split('-');
                filterDateFrom = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            }
            if (dateToInput) {
                const parts = dateToInput.split('-');
                filterDateTo = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            }
            
            if (!filterDateFrom || !filterDateTo) {
                document.getElementById('isTableContainer').innerHTML = '<div class="insight-empty">No valid date data found</div>';
                return;
            }
            
            // Normalize dates to start/end of day for comparison
            filterDateFrom.setHours(0, 0, 0, 0);
            filterDateTo.setHours(23, 59, 59, 999);
            
            // Calculate midpoint for trend analysis (first half vs second half)
            const totalDays = Math.ceil((filterDateTo - filterDateFrom) / (1000 * 60 * 60 * 24)) + 1;
            const midDate = new Date(filterDateFrom.getTime() + (filterDateTo - filterDateFrom) / 2);
            
            // Create a map of all dates in range for filling gaps with 0
            const allDates = [];
            const currentDate = new Date(filterDateFrom);
            currentDate.setHours(0, 0, 0, 0);
            const endDate = new Date(filterDateTo);
            endDate.setHours(0, 0, 0, 0);
            while (currentDate <= endDate) {
                allDates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Aggregate data by Search Term + Campaign + Ad Group
            const aggregatedMap = new Map();
            
            parsedData.impressionShare.forEach(row => {
                const searchTerm = row['Customer Search Term'] || '';
                const campaign = row['Campaign Name'] || '';
                const adGroup = row['Ad Group Name'] || '';
                const portfolio = row['Portfolio name'] || '';
                const matchType = row['Match Type'] || '';
                
                if (!searchTerm) return;
                
                // Apply portfolio and campaign filters
                if (portfolioFilter !== 'all' && portfolio !== portfolioFilter) return;
                if (campaignFilter !== 'all' && campaign !== campaignFilter) return;
                
                const date = parseDateString(row['Date'] || '');
                if (!date) return;
                
                // Normalize date for comparison
                date.setHours(12, 0, 0, 0);
                
                // Apply date filter
                if (date < filterDateFrom || date > filterDateTo) return;
                
                const key = `${searchTerm}|||${campaign}|||${adGroup}`;
                
                // Parse metrics
                const rank = parseInt(row['Search Term Impression Rank']) || 0;
                const shareStr = (row['Search Term Impression Share'] || '0').replace('%', '').replace(',', '.');
                const share = parseFloat(shareStr) || 0;
                const clicks = parseInt(row['Clicks']) || 0;
                const impressions = parseInt(row['Impressions']) || 0;
                const spendStr = (row['Spend'] || '0').replace('', '').replace('$', '').replace(',', '.');
                const spend = parseFloat(spendStr) || 0;
                const orders = parseInt(row['7 Day Total Orders (#)']) || 0;
                const salesStr = (row['7 Day Total Sales'] || '0').replace('', '').replace('$', '').replace(',', '.');
                const sales = parseFloat(salesStr) || 0;
                
                if (!aggregatedMap.has(key)) {
                    aggregatedMap.set(key, {
                        searchTerm,
                        campaign,
                        adGroup,
                        portfolio,
                        matchType,
                        totalSpend: 0,
                        totalSales: 0,
                        totalClicks: 0,
                        totalImpressions: 0,
                        totalOrders: 0,
                        dailyData: new Map(), // Use Map with date key for easy lookup
                        firstHalfRanks: [],
                        firstHalfShares: [],
                        secondHalfRanks: [],
                        secondHalfShares: [],
                        // New: track daily metrics for trends
                        dailyMetrics: new Map()
                    });
                }
                
                const agg = aggregatedMap.get(key);
                agg.totalSpend += spend;
                agg.totalSales += sales;
                agg.totalClicks += clicks;
                agg.totalImpressions += impressions;
                agg.totalOrders += orders;
                
                // Store daily data
                const dateKey = date.toISOString().split('T')[0];
                if (!agg.dailyData.has(dateKey)) {
                    agg.dailyData.set(dateKey, { rank: 0, share: 0 });
                }
                const dayData = agg.dailyData.get(dateKey);
                // Take the max/best values if multiple entries per day
                if (rank > 0 && (dayData.rank === 0 || rank < dayData.rank)) dayData.rank = rank;
                if (share > dayData.share) dayData.share = share;
                
                // Store daily metrics for trend charts (accumulate per day)
                if (!agg.dailyMetrics.has(dateKey)) {
                    agg.dailyMetrics.set(dateKey, { spend: 0, sales: 0, clicks: 0 });
                }
                const dayMetrics = agg.dailyMetrics.get(dateKey);
                dayMetrics.spend += spend;
                dayMetrics.sales += sales;
                dayMetrics.clicks += clicks;
                
                // Assign to first or second half for trend
                if (date <= midDate) {
                    if (rank > 0) agg.firstHalfRanks.push(rank);
                    if (share > 0) agg.firstHalfShares.push(share);
                } else {
                    if (rank > 0) agg.secondHalfRanks.push(rank);
                    if (share > 0) agg.secondHalfShares.push(share);
                }
            });
            
            // Calculate trends for each row
            let results = Array.from(aggregatedMap.values()).map(agg => {
                // Build complete daily series (fill gaps with 0)
                const dailySeries = allDates.map(d => {
                    const dateKey = d.toISOString().split('T')[0];
                    const data = agg.dailyData.get(dateKey);
                    const metrics = agg.dailyMetrics.get(dateKey);
                    return {
                        date: d,
                        rank: data ? data.rank : 0,
                        share: data ? data.share : 0,
                        spend: metrics ? metrics.spend : 0,
                        sales: metrics ? metrics.sales : 0,
                        clicks: metrics ? metrics.clicks : 0,
                        cpc: metrics && metrics.clicks > 0 ? metrics.spend / metrics.clicks : 0,
                        acos: metrics && metrics.sales > 0 ? metrics.spend / metrics.sales : 0
                    };
                });
                
                // Calculate averages (treating 0 as 0, not excluding)
                const avgRank = dailySeries.reduce((s, d) => s + d.rank, 0) / dailySeries.length;
                const avgShare = dailySeries.reduce((s, d) => s + d.share, 0) / dailySeries.length;
                
                // Calculate first half and second half averages (for trend)
                const halfPoint = Math.floor(dailySeries.length / 2);
                const firstHalf = dailySeries.slice(0, halfPoint);
                const secondHalf = dailySeries.slice(halfPoint);
                
                const firstHalfAvgRank = firstHalf.length > 0 ? firstHalf.reduce((s, d) => s + d.rank, 0) / firstHalf.length : 0;
                const secondHalfAvgRank = secondHalf.length > 0 ? secondHalf.reduce((s, d) => s + d.rank, 0) / secondHalf.length : 0;
                const firstHalfAvgShare = firstHalf.length > 0 ? firstHalf.reduce((s, d) => s + d.share, 0) / firstHalf.length : 0;
                const secondHalfAvgShare = secondHalf.length > 0 ? secondHalf.reduce((s, d) => s + d.share, 0) / secondHalf.length : 0;
                
                // Calculate metric averages for first and second half
                const firstHalfSpend = firstHalf.reduce((s, d) => s + d.spend, 0);
                const secondHalfSpend = secondHalf.reduce((s, d) => s + d.spend, 0);
                const firstHalfSales = firstHalf.reduce((s, d) => s + d.sales, 0);
                const secondHalfSales = secondHalf.reduce((s, d) => s + d.sales, 0);
                const firstHalfClicks = firstHalf.reduce((s, d) => s + d.clicks, 0);
                const secondHalfClicks = secondHalf.reduce((s, d) => s + d.clicks, 0);
                
                // Calculate CPC and ACOS for each half
                const firstHalfCpc = firstHalfClicks > 0 ? firstHalfSpend / firstHalfClicks : 0;
                const secondHalfCpc = secondHalfClicks > 0 ? secondHalfSpend / secondHalfClicks : 0;
                const firstHalfAcos = firstHalfSales > 0 ? firstHalfSpend / firstHalfSales : 0;
                const secondHalfAcos = secondHalfSales > 0 ? secondHalfSpend / secondHalfSales : 0;
                
                // Calculate trend direction
                const rankChange = secondHalfAvgRank - firstHalfAvgRank; // negative = improving (lower rank is better)
                const shareChange = secondHalfAvgShare - firstHalfAvgShare; // positive = improving (higher share is better)
                
                // Calculate metric changes
                const spendChange = secondHalfSpend - firstHalfSpend;
                const salesChange = secondHalfSales - firstHalfSales;
                const cpcChange = secondHalfCpc - firstHalfCpc;
                const acosChange = secondHalfAcos - firstHalfAcos;
                
                // Determine metric trends (lower CPC and ACOS is better, higher sales is better)
                let spendTrend = 'stable';
                const spendChangePercent = firstHalfSpend > 0 ? (spendChange / firstHalfSpend) : 0;
                if (spendChangePercent > 0.1) spendTrend = 'rising';
                else if (spendChangePercent < -0.1) spendTrend = 'decreasing';
                
                let salesTrend = 'stable';
                const salesChangePercent = firstHalfSales > 0 ? (salesChange / firstHalfSales) : 0;
                if (salesChangePercent > 0.1) salesTrend = 'rising';
                else if (salesChangePercent < -0.1) salesTrend = 'decreasing';
                
                let cpcTrend = 'stable';
                const cpcChangePercent = firstHalfCpc > 0 ? (cpcChange / firstHalfCpc) : 0;
                if (cpcChangePercent > 0.1) cpcTrend = 'rising';
                else if (cpcChangePercent < -0.1) cpcTrend = 'decreasing';
                
                let acosTrend = 'stable';
                const acosChangePercent = firstHalfAcos > 0 ? (acosChange / firstHalfAcos) : 0;
                if (acosChangePercent > 0.1) acosTrend = 'rising';
                else if (acosChangePercent < -0.1) acosTrend = 'decreasing';
                
                // Determine individual trends for rank and share
                let rankTrend = 'stable';
                const rankChangePercent = firstHalfAvgRank > 0 ? (rankChange / firstHalfAvgRank) : 0;
                if (rankChangePercent < -0.1) rankTrend = 'improving';
                else if (rankChangePercent > 0.1) rankTrend = 'declining';
                
                let shareTrend = 'stable';
                const shareChangePercent = firstHalfAvgShare > 0 ? (shareChange / firstHalfAvgShare) : 0;
                if (shareChangePercent > 0.1) shareTrend = 'improving';
                else if (shareChangePercent < -0.1) shareTrend = 'declining';
                
                // ========== BALANCED OVERALL TREND SCORE ==========
                // Combines visibility metrics and profitability metrics
                // Each metric contributes a normalized score from -1 to +1
                // Positive = improving, Negative = declining
                
                let trendScore = 0;
                let metricsCount = 0;
                
                // VISIBILITY METRICS (weight: 40% total)
                // Rank: lower is better (weight: 20%)
                if (firstHalfAvgRank > 0) {
                    const rankScore = -rankChangePercent; // negative change = positive score
                    trendScore += Math.max(-1, Math.min(1, rankScore * 5)) * 0.20;
                    metricsCount++;
                }
                
                // Share: higher is better (weight: 20%)
                if (firstHalfAvgShare > 0) {
                    const shareScore = shareChangePercent; // positive change = positive score
                    trendScore += Math.max(-1, Math.min(1, shareScore * 5)) * 0.20;
                    metricsCount++;
                }
                
                // PROFITABILITY METRICS (weight: 60% total)
                // Sales: higher is better (weight: 25%)
                if (firstHalfSales > 0) {
                    const salesScore = salesChangePercent; // positive change = positive score
                    trendScore += Math.max(-1, Math.min(1, salesScore * 3)) * 0.25;
                    metricsCount++;
                }
                
                // ACOS: lower is better (weight: 25%)
                if (firstHalfAcos > 0) {
                    const acosScore = -acosChangePercent; // negative change = positive score
                    trendScore += Math.max(-1, Math.min(1, acosScore * 3)) * 0.25;
                    metricsCount++;
                }
                
                // CPC: lower is better (weight: 10%)
                if (firstHalfCpc > 0) {
                    const cpcScore = -cpcChangePercent; // negative change = positive score
                    trendScore += Math.max(-1, Math.min(1, cpcScore * 3)) * 0.10;
                    metricsCount++;
                }
                
                // Determine overall trend based on balanced score
                // Thresholds adjusted for the weighted scoring system
                let trend = 'stable';
                if (trendScore > 0.08) trend = 'improving';
                else if (trendScore < -0.08) trend = 'declining';
                
                return {
                    ...agg,
                    dailySeries,
                    avgRank,
                    avgShare,
                    firstHalfAvgRank,
                    secondHalfAvgRank,
                    firstHalfAvgShare,
                    secondHalfAvgShare,
                    rankChange,
                    shareChange,
                    rankTrend,
                    shareTrend,
                    trend,
                    trendScore,
                    // New metric trends
                    firstHalfSpend,
                    secondHalfSpend,
                    firstHalfSales,
                    secondHalfSales,
                    firstHalfCpc,
                    secondHalfCpc,
                    firstHalfAcos,
                    secondHalfAcos,
                    spendTrend,
                    salesTrend,
                    cpcTrend,
                    acosTrend,
                    // Total CPC
                    totalCpc: agg.totalClicks > 0 ? agg.totalSpend / agg.totalClicks : 0
                };
            });
            
            // Apply filters
            results = results.filter(r => {
                if (r.totalSpend < minSpend) return false;
                if (trendFilter !== 'all' && r.trend !== trendFilter) return false;
                return true;
            });
            
            // Sort
            results = sortImpressionShareData(results);
            
            // Summary stats
            const totalRows = results.length;
            const improvingCount = results.filter(r => r.trend === 'improving').length;
            const decliningCount = results.filter(r => r.trend === 'declining').length;
            const stableCount = results.filter(r => r.trend === 'stable').length;
            const totalSpendSum = results.reduce((s, r) => s + r.totalSpend, 0);
            const totalSalesSum = results.reduce((s, r) => s + r.totalSales, 0);
            const totalClicksSum = results.reduce((s, r) => s + r.totalClicks, 0);
            const totalCpc = totalClicksSum > 0 ? totalSpendSum / totalClicksSum : 0;
            const totalAcos = totalSalesSum > 0 ? totalSpendSum / totalSalesSum : 0;
            
            document.getElementById('isSummaryBar').innerHTML = `
                <div class="is-summary-item">
                    <span class="is-summary-label">Search Terms:</span>
                    <span class="is-summary-value">${formatNumber(totalRows)}</span>
                </div>
                <div class="is-summary-item">
                    <span class="is-summary-label"> Improving:</span>
                    <span class="is-summary-value" style="color:#4ade80">${formatNumber(improvingCount)}</span>
                </div>
                <div class="is-summary-item">
                    <span class="is-summary-label"> Declining:</span>
                    <span class="is-summary-value" style="color:#f87171">${formatNumber(decliningCount)}</span>
                </div>
                <div class="is-summary-item">
                    <span class="is-summary-label"> Stable:</span>
                    <span class="is-summary-value" style="color:#9ca3af">${formatNumber(stableCount)}</span>
                </div>
                <div class="is-summary-item">
                    <span class="is-summary-label">Total Spend:</span>
                    <span class="is-summary-value">${formatCurrencyDecimal(totalSpendSum)}</span>
                </div>
                <div class="is-summary-item">
                    <span class="is-summary-label">Total Sales:</span>
                    <span class="is-summary-value">${formatCurrencyDecimal(totalSalesSum)}</span>
                </div>
                <div class="is-summary-item">
                    <span class="is-summary-label">Total ACOS:</span>
                    <span class="is-summary-value">${formatPercent(totalAcos, 1)}</span>
                </div>
                <div class="is-summary-item">
                    <span class="is-summary-label">Avg CPC:</span>
                    <span class="is-summary-value">${formatCurrencyDecimal(totalCpc)}</span>
                </div>
                <div class="is-summary-item">
                    <span class="is-summary-label">Period:</span>
                    <span class="is-summary-value">${formatDateShort(filterDateFrom)} - ${formatDateShort(filterDateTo)} (${totalDays} days)</span>
                </div>
            `;
            
            // Build table
            const tableContainer = document.getElementById('isTableContainer');
            
            if (results.length === 0) {
                tableContainer.innerHTML = '<div class="insight-empty">No data matching the filters</div>';
                return;
            }
            
            // Store results for chart modal
            currentIsResults = results;
            
            tableContainer.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="is-sticky-col sortable-header" onclick="sortImpressionShare('searchTerm')" style="min-width:200px;">Search Term ${getIsSortIcon('searchTerm')}</th>
                            <th class="sortable-header" onclick="sortImpressionShare('spend')">Spend ${getIsSortIcon('spend')}</th>
                            <th class="sortable-header" onclick="sortImpressionShare('sales')">Sales ${getIsSortIcon('sales')}</th>
                            <th class="sortable-header" onclick="sortImpressionShare('acos')">ACOS ${getIsSortIcon('acos')}</th>
                            <th class="sortable-header" onclick="sortImpressionShare('cpc')">CPC ${getIsSortIcon('cpc')}</th>
                            <th class="sortable-header" onclick="sortImpressionShare('avgRank')">Avg Rank ${getIsSortIcon('avgRank')}</th>
                            <th>Rank Trend</th>
                            <th class="sortable-header" onclick="sortImpressionShare('avgShare')">Avg Share ${getIsSortIcon('avgShare')}</th>
                            <th>Share Trend</th>
                            <th>Rank Chart</th>
                            <th>Share Chart</th>
                            <th>Spend Chart</th>
                            <th>Sales Chart</th>
                            <th>ACOS Chart</th>
                            <th>CPC Chart</th>
                            <th class="sortable-header" onclick="sortImpressionShare('trend')">Overall ${getIsSortIcon('trend')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.slice(0, 200).map((row, idx) => {
                            const acos = row.totalSales > 0 ? row.totalSpend / row.totalSales : (row.totalSpend > 0 ? Infinity : 0);
                            
                            return `<tr>
                                <td class="is-sticky-col is-search-term-cell">
                                    <span class="is-search-term-text" title="${escapeHtml(row.searchTerm)}">${escapeHtml(row.searchTerm)}</span>
                                    <span class="is-meta-text" title="${escapeHtml(row.campaign)}">${escapeHtml(row.campaign)}</span>
                                    <span class="is-meta-text is-portfolio-text">${escapeHtml(row.portfolio || 'No Portfolio')}</span>
                                </td>
                                <td class="is-kpi-cell">${formatCurrencyDecimal(row.totalSpend)}</td>
                                <td class="is-kpi-cell">${formatCurrencyDecimal(row.totalSales)}</td>
                                <td class="is-kpi-cell ${getAcosColorClass(acos)}">${acos === Infinity ? '' : formatPercent(acos, 1)}</td>
                                <td class="is-kpi-cell">${formatCurrencyDecimal(row.totalCpc)}</td>
                                <td class="is-kpi-cell">${row.avgRank > 0 ? row.avgRank.toFixed(1) : '-'}</td>
                                <td class="is-trend-cell">
                                    ${renderTrendCell(row.firstHalfAvgRank, row.secondHalfAvgRank, row.rankTrend, true)}
                                </td>
                                <td class="is-kpi-cell">${row.avgShare > 0 ? row.avgShare.toFixed(1) + '%' : '-'}</td>
                                <td class="is-trend-cell">
                                    ${renderTrendCell(row.firstHalfAvgShare, row.secondHalfAvgShare, row.shareTrend, false, true)}
                                </td>
                                <td>${renderMiniChart(row.dailySeries, 'rank', row.rankTrend, idx)}</td>
                                <td>${renderMiniChart(row.dailySeries, 'share', row.shareTrend, idx)}</td>
                                <td>${renderMiniChart(row.dailySeries, 'spend', row.spendTrend, idx)}</td>
                                <td>${renderMiniChart(row.dailySeries, 'sales', row.salesTrend, idx)}</td>
                                <td>${renderMiniChart(row.dailySeries, 'acos', row.acosTrend, idx)}</td>
                                <td>${renderMiniChart(row.dailySeries, 'cpc', row.cpcTrend, idx)}</td>
                                <td class="is-trend-cell">
                                    <span class="trend-badge ${row.trend === 'improving' ? 'up' : row.trend === 'declining' ? 'down' : 'stable'}">
                                        ${row.trend === 'improving' ? '' : row.trend === 'declining' ? '' : ''}
                                    </span>
                                </td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
                ${results.length > 200 ? `<div style="padding:0.5rem;text-align:center;color:#666;font-size:0.75rem;">Showing top 200 of ${formatNumber(results.length)} results</div>` : ''}
            `;
        }
        
        function renderTrendCell(firstVal, secondVal, trend, lowerIsBetter = false, isPercent = false) {
            if (firstVal === 0 && secondVal === 0) return '<span style="color:#9ca3af">-</span>';
            
            const firstDisplay = isPercent ? firstVal.toFixed(1) + '%' : firstVal.toFixed(1);
            const secondDisplay = isPercent ? secondVal.toFixed(1) + '%' : secondVal.toFixed(1);
            
            let colorClass = '';
            let arrow = '';
            
            if (trend === 'improving') {
                colorClass = 'trend-improving';
                arrow = lowerIsBetter ? '' : '';
            } else if (trend === 'declining') {
                colorClass = 'trend-declining';
                arrow = lowerIsBetter ? '' : '';
            } else {
                colorClass = 'trend-stable';
                arrow = '';
            }
            
            return `<span class="${colorClass}" style="font-size:0.7rem;">${firstDisplay} ${arrow} ${secondDisplay}</span>`;
        }
        
        function renderMiniChart(dailySeries, metric = 'share', trend = 'stable', rowIndex = 0) {
            if (!dailySeries || dailySeries.length < 2) return '-';
            
            // Get last 30 days max
            const data = dailySeries.slice(-30);
            const values = data.map(d => d[metric] || 0);
            const maxValue = Math.max(...values, 0.001); // Avoid division by zero
            
            // Reduce to max ~15 bars for display
            const step = Math.max(1, Math.floor(values.length / 15));
            const reducedValues = values.filter((_, i) => i % step === 0);
            
            // Determine colors based on metric type
            let barColor = '#3b82f6'; // default blue
            if (metric === 'spend') barColor = '#f59e0b'; // orange
            else if (metric === 'sales') barColor = '#10b981'; // green
            else if (metric === 'acos') barColor = '#ef4444'; // red
            else if (metric === 'cpc') barColor = '#8b5cf6'; // purple
            else if (metric === 'rank') barColor = '#06b6d4'; // cyan
            
            // Trend indicator
            let trendIcon = '';
            let trendColor = '#6b7280';
            if (trend === 'rising') {
                trendIcon = '';
                // For ACOS, CPC, and Rank, rising is bad; for sales, rising is good; for spend, neutral-ish
                if (metric === 'acos' || metric === 'cpc' || metric === 'rank') {
                    trendColor = '#ef4444'; // red for bad
                } else if (metric === 'sales') {
                    trendColor = '#10b981'; // green for good
                } else {
                    trendColor = '#f59e0b'; // orange for spend
                }
            } else if (trend === 'decreasing') {
                trendIcon = '';
                // For ACOS, CPC, and Rank, decreasing is good; for sales, decreasing is bad
                if (metric === 'acos' || metric === 'cpc' || metric === 'rank') {
                    trendColor = '#10b981'; // green for good
                } else if (metric === 'sales') {
                    trendColor = '#ef4444'; // red for bad
                } else {
                    trendColor = '#10b981'; // green for spend decrease
                }
            } else {
                trendIcon = '';
            }
            
            return `<div class="mini-chart-container" onclick="openChartModal(${rowIndex}, '${metric}')" title="Click to view details">
                <div class="mini-chart">
                    ${reducedValues.map(v => {
                        const height = Math.max(2, (v / maxValue) * 18);
                        const color = v === 0 ? '#e5e7eb' : barColor;
                        return `<div class="mini-bar" style="height:${height}px;background:${color}"></div>`;
                    }).join('')}
                </div>
                <span class="mini-chart-trend" style="color:${trendColor}">${trendIcon}</span>
            </div>`;
        }
        
        function sortImpressionShare(column) {
            if (impressionShareSortState.column === column) {
                impressionShareSortState.direction = impressionShareSortState.direction === 'desc' ? 'asc' : 'desc';
            } else {
                impressionShareSortState.column = column;
                impressionShareSortState.direction = 'desc';
            }
            renderImpressionShareTable();
        }
        
        function getIsSortIcon(column) {
            if (impressionShareSortState.column !== column) return '<span class="sort-icon"></span>';
            return impressionShareSortState.direction === 'desc' 
                ? '<span class="sort-icon active"></span>' 
                : '<span class="sort-icon active"></span>';
        }
        
        function sortImpressionShareData(data) {
            const col = impressionShareSortState.column;
            const dir = impressionShareSortState.direction;
            
            return [...data].sort((a, b) => {
                let aVal, bVal;
                
                switch (col) {
                    case 'searchTerm':
                        aVal = a.searchTerm.toLowerCase();
                        bVal = b.searchTerm.toLowerCase();
                        break;
                    case 'spend':
                        aVal = a.totalSpend;
                        bVal = b.totalSpend;
                        break;
                    case 'sales':
                        aVal = a.totalSales;
                        bVal = b.totalSales;
                        break;
                    case 'acos':
                        aVal = a.totalSales > 0 ? a.totalSpend / a.totalSales : 999999;
                        bVal = b.totalSales > 0 ? b.totalSpend / b.totalSales : 999999;
                        break;
                    case 'cpc':
                        aVal = a.totalCpc || 0;
                        bVal = b.totalCpc || 0;
                        break;
                    case 'avgRank':
                        aVal = a.avgRank || 999;
                        bVal = b.avgRank || 999;
                        break;
                    case 'avgShare':
                        aVal = a.avgShare || 0;
                        bVal = b.avgShare || 0;
                        break;
                    case 'trend':
                        const trendOrder = { improving: 1, stable: 2, declining: 3 };
                        aVal = trendOrder[a.trend] || 2;
                        bVal = trendOrder[b.trend] || 2;
                        break;
                    default:
                        aVal = a.totalSpend;
                        bVal = b.totalSpend;
                }
                
                if (typeof aVal === 'string') {
                    return dir === 'desc' ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
                }
                return dir === 'desc' ? bVal - aVal : aVal - bVal;
            });
        }
        
        // Make Impression Share functions global
        window.sortImpressionShare = sortImpressionShare;
        window.renderImpressionShareTable = renderImpressionShareTable;
        
        // ==================== CHART MODAL FUNCTIONS ====================
        
        function openChartModal(rowIndex, metric) {
            const row = currentIsResults[rowIndex];
            if (!row) return;
            
            const modal = document.getElementById('chartModal');
            const titleEl = document.getElementById('chartModalTitle');
            const subtitleEl = document.getElementById('chartModalSubtitle');
            const statsEl = document.getElementById('chartModalStats');
            
            // Metric display names and colors
            const metricConfig = {
                share: { name: 'Impression Share', color: '#3b82f6', unit: '%', icon: '' },
                spend: { name: 'Spend', color: '#f59e0b', unit: '', icon: '' },
                sales: { name: 'Sales', color: '#10b981', unit: '', icon: '' },
                acos: { name: 'ACOS', color: '#ef4444', unit: '%', icon: '' },
                cpc: { name: 'CPC', color: '#8b5cf6', unit: '', icon: '' },
                rank: { name: 'Impression Rank', color: '#06b6d4', unit: '', icon: '' }
            };
            
            const config = metricConfig[metric] || metricConfig.share;
            
            // Set title
            titleEl.innerHTML = `${config.icon} ${config.name} Trend`;
            subtitleEl.textContent = row.searchTerm;
            
            // Calculate stats
            const dailySeries = row.dailySeries || [];
            const values = dailySeries.map(d => d[metric] || 0);
            const total = values.reduce((a, b) => a + b, 0);
            const avg = values.length > 0 ? total / values.length : 0;
            const max = Math.max(...values, 0);
            const min = Math.min(...values.filter(v => v > 0), max);
            
            // Get trend info
            let trendKey = metric + 'Trend';
            if (metric === 'share') trendKey = 'shareTrend';
            const trend = row[trendKey] || 'stable';
            
            // Calculate first and second half for trend display
            const halfPoint = Math.floor(values.length / 2);
            const firstHalfValues = values.slice(0, halfPoint);
            const secondHalfValues = values.slice(halfPoint);
            const firstHalfAvg = firstHalfValues.length > 0 ? firstHalfValues.reduce((a, b) => a + b, 0) / firstHalfValues.length : 0;
            const secondHalfAvg = secondHalfValues.length > 0 ? secondHalfValues.reduce((a, b) => a + b, 0) / secondHalfValues.length : 0;
            const changePercent = firstHalfAvg > 0 ? ((secondHalfAvg - firstHalfAvg) / firstHalfAvg * 100) : 0;
            
            // Determine trend class - for rank, lower is better
            let trendClass = 'stable';
            let trendArrow = '';
            if (trend === 'rising') {
                trendClass = (metric === 'acos' || metric === 'cpc' || metric === 'rank') ? 'down' : 'up';
                trendArrow = '';
            } else if (trend === 'decreasing') {
                trendClass = (metric === 'acos' || metric === 'cpc' || metric === 'rank') ? 'up' : 'down';
                trendArrow = '';
            }
            
            // Format value based on metric type
            const formatValue = (val) => {
                if (metric === 'acos' || metric === 'share') {
                    return (val * (metric === 'acos' ? 100 : 1)).toFixed(1) + '%';
                } else if (metric === 'rank') {
                    return val.toFixed(1);
                } else {
                    return '' + val.toFixed(2);
                }
            };
            
            // Build stats HTML
            statsEl.innerHTML = `
                <div class="chart-modal-stat">
                    <span class="chart-modal-stat-label">${metric === 'rank' ? 'Average' : 'Total'} ${config.name}</span>
                    <span class="chart-modal-stat-value" style="color:${config.color}">${metric === 'acos' || metric === 'share' || metric === 'rank' ? formatValue(avg) : formatValue(total)}</span>
                </div>
                <div class="chart-modal-stat">
                    <span class="chart-modal-stat-label">Average</span>
                    <span class="chart-modal-stat-value">${formatValue(avg)}</span>
                </div>
                <div class="chart-modal-stat">
                    <span class="chart-modal-stat-label">${metric === 'rank' ? 'Best (Lowest)' : 'Maximum'}</span>
                    <span class="chart-modal-stat-value">${metric === 'rank' ? formatValue(min) : formatValue(max)}</span>
                </div>
                <div class="chart-modal-stat">
                    <span class="chart-modal-stat-label">${metric === 'rank' ? 'Worst (Highest)' : 'Minimum'}</span>
                    <span class="chart-modal-stat-value">${metric === 'rank' ? formatValue(max) : formatValue(min)}</span>
                </div>
                <div class="chart-modal-stat">
                    <span class="chart-modal-stat-label">Trend</span>
                    <span class="chart-modal-stat-value">
                        <span class="chart-modal-stat-trend ${trendClass}">${trendArrow} ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%</span>
                    </span>
                </div>
                <div class="chart-modal-stat">
                    <span class="chart-modal-stat-label">Period</span>
                    <span class="chart-modal-stat-value">${dailySeries.length} days</span>
                </div>
            `;
            
            // Create chart
            renderDetailChart(dailySeries, metric, config);
            
            // Show modal
            modal.classList.add('show');
            
            // Close on escape key
            document.addEventListener('keydown', handleModalEscape);
            
            // Close on overlay click
            modal.addEventListener('click', handleModalOverlayClick);
        }
        
        function renderDetailChart(dailySeries, metric, config) {
            const canvas = document.getElementById('chartModalCanvas');
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (chartModalInstance) {
                chartModalInstance.destroy();
            }
            
            // Prepare data
            const labels = dailySeries.map(d => {
                const date = d.date;
                const month = date.toLocaleString('default', { month: 'short' });
                const day = date.getDate();
                return `${month} ${day}`;
            });
            
            const values = dailySeries.map(d => {
                let val = d[metric] || 0;
                // Convert ACOS to percentage for display
                if (metric === 'acos') val = val * 100;
                return val;
            });
            
            // Create chart
            chartModalInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: config.name,
                        data: values,
                        borderColor: config.color,
                        backgroundColor: config.color + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: values.length > 30 ? 0 : 3,
                        pointHoverRadius: 5,
                        pointBackgroundColor: config.color,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 12 },
                            bodyFont: { size: 13 },
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    let val = context.raw;
                                    if (metric === 'acos' || metric === 'share') {
                                        return `${config.name}: ${val.toFixed(1)}%`;
                                    } else if (metric === 'rank') {
                                        return `${config.name}: ${val.toFixed(1)}`;
                                    } else {
                                        return `${config.name}: ${val.toFixed(2)}`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 10,
                                font: { size: 10 }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#e5e7eb'
                            },
                            ticks: {
                                font: { size: 10 },
                                callback: function(value) {
                                    if (metric === 'acos' || metric === 'share') {
                                        return value.toFixed(0) + '%';
                                    } else if (metric === 'rank') {
                                        return value.toFixed(0);
                                    } else {
                                        return '' + value.toFixed(0);
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function closeChartModal() {
            const modal = document.getElementById('chartModal');
            modal.classList.remove('show');
            document.removeEventListener('keydown', handleModalEscape);
            modal.removeEventListener('click', handleModalOverlayClick);
        }
        
        function handleModalEscape(e) {
            if (e.key === 'Escape') {
                closeChartModal();
            }
        }
        
        function handleModalOverlayClick(e) {
            if (e.target.classList.contains('chart-modal-overlay')) {
                closeChartModal();
            }
        }
        
        // Make chart modal functions global
        window.openChartModal = openChartModal;
        window.closeChartModal = closeChartModal;
        
        // ==================== SQP ANALYSIS ====================
        
        const sqpDropZone = document.getElementById('sqpDropZone');
        const sqpFileInput = document.getElementById('sqpFileInput');
        const sqpFileInfo = document.getElementById('sqpFileInfo');
        const sqpLoading = document.getElementById('sqpLoading');
        const sqpResults = document.getElementById('sqpResults');
        
        let sqpData = [];
        let sqpCombinedData = [];
        let sqpAllAsins = [];
        let sqpAllWeeks = []; // Array of {date, weekNum, startDate, endDate}
        let sqpSelectedWeeks = new Set(); // Set of date strings
        let sqpSortState = { column: 'spend', direction: 'desc' };
        let asinMapping = new Map(); // Campaign ID + Ad Group ID -> ASIN
        
        if (sqpDropZone) {
            sqpDropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                sqpDropZone.classList.add('dragover');
            });
            
            sqpDropZone.addEventListener('dragleave', () => {
                sqpDropZone.classList.remove('dragover');
            });
            
            sqpDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                sqpDropZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) handleSqpFile(file);
            });
        }
        
        if (sqpFileInput) {
            sqpFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleSqpFile(file);
            });
        }
        
        function buildAsinMapping() {
            // Build ASIN mapping from parsed SP data (Product ad entities)
            asinMapping.clear();
            asinToSkuMapping.clear();
            
            if (!parsedData.sp || parsedData.sp.length === 0) {
                console.warn('No SP data available for ASIN mapping');
                return;
            }
            
            parsedData.sp.forEach(row => {
                const entity = row['Entity'] || '';
                if (entity === 'Product ad') {
                    const campaignId = row['Campaign ID'];
                    const adGroupId = row['Ad group ID'];
                    const asin = row['ASIN (Informational only)'];
                    const sku = row['SKU'] || row['Sku'] || '';
                    
                    if (campaignId && adGroupId && asin) {
                        const key = `${campaignId}|||${adGroupId}`;
                        asinMapping.set(key, asin);
                        
                        // Also map ASIN to SKU
                        if (asin && sku && !asinToSkuMapping.has(asin)) {
                            asinToSkuMapping.set(asin, sku);
                        }
                    }
                }
            });
            
            console.log(`Built ASIN mapping with ${asinMapping.size} entries, SKU mapping with ${asinToSkuMapping.size} entries`);
        }
        
        // SKU mapping
        let asinToSkuMapping = new Map();
        
        function handleSqpFile(file) {
            if (!file.name.endsWith('.csv')) {
                alert('Please upload a CSV file');
                return;
            }
            
            // Check if bulk file was uploaded first
            if (!parsedData.sp || parsedData.sp.length === 0) {
                alert('Please upload the bulk XLSX file first to enable ASIN mapping');
                return;
            }
            
            // Build ASIN mapping if not done yet
            if (asinMapping.size === 0) {
                buildAsinMapping();
            }
            
            sqpFileInfo.textContent = `Loading: ${file.name}`;
            sqpFileInfo.classList.add('visible');
            sqpLoading.style.display = 'block';
            sqpDropZone.style.display = 'none';
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    sqpData = parseSqpCsv(e.target.result);
                    console.log(`Parsed ${sqpData.length} SQP rows`);
                    
                    // Process and combine data
                    processSqpData();
                    
                    sqpLoading.style.display = 'none';
                    sqpResults.style.display = 'block';
                    sqpFileInfo.textContent = `Loaded: ${file.name} (${sqpData.length.toLocaleString()} rows)`;
                    renderSqpTable();
                } catch (err) {
                    console.error('Error parsing SQP CSV:', err);
                    alert('Error parsing SQP CSV file. Please check the format.');
                    sqpLoading.style.display = 'none';
                    sqpDropZone.style.display = 'block';
                }
            };
            reader.readAsText(file);
        }
        
        function parseSqpCsv(text) {
            const lines = text.split(/\r?\n/);
            if (lines.length < 2) return [];
            
            const headers = parseCSVLine(lines[0]);
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((h, idx) => {
                    row[h.trim()] = values[idx] || '';
                });
                data.push(row);
            }
            return data;
        }
        
        function processSqpData() {
            // Extract unique weeks from SQP data
            sqpAllWeeks = [];
            const weekDates = new Set();
            sqpData.forEach(row => {
                const dateStr = row['Reporting Date'] || '';
                if (dateStr && !weekDates.has(dateStr)) {
                    weekDates.add(dateStr);
                    const date = new Date(dateStr);
                    // Calculate week number (ISO week)
                    const weekNum = getISOWeek(date);
                    // Calculate week start (Sunday) and end (Saturday)
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - date.getDay());
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    
                    sqpAllWeeks.push({
                        date: dateStr,
                        weekNum: weekNum,
                        startDate: weekStart,
                        endDate: weekEnd,
                        displayDate: date
                    });
                }
            });
            
            // Sort weeks by date descending (newest first)
            sqpAllWeeks.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Select all weeks by default
            sqpSelectedWeeks = new Set(sqpAllWeeks.map(w => w.date));
            
            // Populate week filter UI
            populateWeekFilter();
            
            // Process data with selected weeks
            reprocessSqpDataWithWeeks();
        }
        
        function getISOWeek(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        function populateWeekFilter() {
            const optionsContainer = document.getElementById('sqpWeekFilterOptions');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            optionsContainer.innerHTML = sqpAllWeeks.map(week => {
                const startStr = `${months[week.startDate.getMonth()]} ${week.startDate.getDate()}`;
                const endStr = `${months[week.endDate.getMonth()]} ${week.endDate.getDate()}, ${week.endDate.getFullYear()}`;
                
                return `
                    <label class="sqp-week-option">
                        <input type="checkbox" value="${week.date}" checked onchange="toggleSqpWeek('${week.date}')">
                        <span class="sqp-week-option-label">
                            <span class="sqp-week-number">W${week.weekNum}</span>
                            <span class="sqp-week-dates">${startStr} - ${endStr}</span>
                        </span>
                    </label>
                `;
            }).join('');
            
            updateWeekFilterLabel();
            
            // Setup dropdown toggle
            const trigger = document.getElementById('sqpWeekFilterTrigger');
            const wrapper = trigger.parentElement;
            
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                wrapper.classList.toggle('open');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    wrapper.classList.remove('open');
                }
            });
        }
        
        function toggleSqpWeek(dateStr) {
            if (sqpSelectedWeeks.has(dateStr)) {
                sqpSelectedWeeks.delete(dateStr);
            } else {
                sqpSelectedWeeks.add(dateStr);
            }
            updateWeekFilterLabel();
            reprocessSqpDataWithWeeks();
            renderSqpTable();
        }
        
        function sqpSelectAllWeeks() {
            sqpSelectedWeeks = new Set(sqpAllWeeks.map(w => w.date));
            document.querySelectorAll('#sqpWeekFilterOptions input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateWeekFilterLabel();
            reprocessSqpDataWithWeeks();
            renderSqpTable();
        }
        
        function sqpDeselectAllWeeks() {
            sqpSelectedWeeks.clear();
            document.querySelectorAll('#sqpWeekFilterOptions input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateWeekFilterLabel();
            reprocessSqpDataWithWeeks();
            renderSqpTable();
        }
        
        function updateWeekFilterLabel() {
            const label = document.getElementById('sqpWeekFilterLabel');
            const total = sqpAllWeeks.length;
            const selected = sqpSelectedWeeks.size;
            
            if (selected === 0) {
                label.textContent = 'No weeks selected';
            } else if (selected === total) {
                label.textContent = `All Weeks (${total})`;
            } else {
                label.textContent = `${selected} of ${total} weeks`;
            }
        }
        
        function reprocessSqpDataWithWeeks() {
            // 1. Get search terms with ASINs from search term report
            const searchTermsWithAsin = [];
            
            if (parsedData.searchTerms && parsedData.searchTerms.length > 0) {
                parsedData.searchTerms.forEach(row => {
                    const campaignId = row['Campaign ID'];
                    const adGroupId = row['Ad group ID'];
                    const key = `${campaignId}|||${adGroupId}`;
                    const asin = asinMapping.get(key);
                    
                    if (asin) {
                        searchTermsWithAsin.push({
                            ...row,
                            ASIN: asin,
                            searchTermNormalized: (row['Customer search term'] || '').toLowerCase().trim()
                        });
                    }
                });
            }
            
            console.log(`Search terms with ASIN: ${searchTermsWithAsin.length}`);
            
            // 2. Aggregate search terms by ASIN + search term
            const stAggMap = new Map();
            searchTermsWithAsin.forEach(row => {
                const key = `${row.ASIN}|||${row.searchTermNormalized}`;
                if (!stAggMap.has(key)) {
                    stAggMap.set(key, {
                        asin: row.ASIN,
                        searchTerm: row['Customer search term'] || '',
                        searchTermNormalized: row.searchTermNormalized,
                        campaign: row['Campaign name (Informational only)'] || '',
                        portfolio: row['Portfolio name (Informational only)'] || '',
                        impressions: 0,
                        clicks: 0,
                        spend: 0,
                        sales: 0,
                        orders: 0,
                        units: 0
                    });
                }
                const agg = stAggMap.get(key);
                agg.impressions += parseFloat(row['Impressions']) || 0;
                agg.clicks += parseFloat(row['Clicks']) || 0;
                agg.spend += parseFloat(row['Spend']) || 0;
                agg.sales += parseFloat(row['Sales']) || 0;
                agg.orders += parseFloat(row['Orders']) || 0;
                agg.units += parseFloat(row['Units']) || 0;
            });
            
            // 3. Aggregate SQP data by ASIN + search term (sum counts across selected weeks, then calculate rates)
            const sqpAggMap = new Map();
            sqpData.forEach(row => {
                // Filter by selected weeks
                const rowDate = row['Reporting Date'] || '';
                if (!sqpSelectedWeeks.has(rowDate)) {
                    return; // Skip rows from unselected weeks
                }
                
                const asin = row['ASIN'] || '';
                const searchQuery = (row['Search Query'] || '').toLowerCase().trim();
                const key = `${asin}|||${searchQuery}`;
                
                if (!sqpAggMap.has(key)) {
                    sqpAggMap.set(key, {
                        queryVolumes: [],
                        // Raw counts for calculating conversion rates
                        clicksTotalCount: 0,
                        clicksAsinCount: 0,
                        purchasesTotalCount: 0,
                        purchasesAsinCount: 0,
                        impressionsTotalCount: 0,
                        impressionsAsinCount: 0,
                        // Other metrics
                        impressionShares: [],
                        clickShares: [],
                        purchaseShares: [],
                        // Click median prices
                        clickPriceAsin: [],
                        clickPriceMarket: [],
                        // Weekly impression share data for chart
                        weeklyImpShare: []
                    });
                }
                const agg = sqpAggMap.get(key);
                
                const vol = parseFloat(row['Search Query Volume']) || 0;
                const impShare = parseFloat(row['Impressions: ASIN Share %']) || 0;
                const clickShare = parseFloat(row['Clicks: ASIN Share %']) || 0;
                const purchaseShare = parseFloat(row['Purchases: ASIN Share %']) || 0;
                
                // Sum raw counts for conversion rate and CTR calculation
                agg.clicksTotalCount += parseFloat(row['Clicks: Total Count']) || 0;
                agg.clicksAsinCount += parseFloat(row['Clicks: ASIN Count']) || 0;
                agg.purchasesTotalCount += parseFloat(row['Purchases: Total Count']) || 0;
                agg.purchasesAsinCount += parseFloat(row['Purchases: ASIN Count']) || 0;
                agg.impressionsTotalCount += parseFloat(row['Impressions: Total Count']) || 0;
                agg.impressionsAsinCount += parseFloat(row['Impressions: ASIN Count']) || 0;
                
                // Click median prices
                const clickPriceAsin = parseFloat(row['Clicks: ASIN Price (Median)']) || 0;
                const clickPriceMarket = parseFloat(row['Clicks: Price (Median)']) || 0;
                if (clickPriceAsin > 0) agg.clickPriceAsin.push(clickPriceAsin);
                if (clickPriceMarket > 0) agg.clickPriceMarket.push(clickPriceMarket);
                
                // Weekly impression share for chart
                agg.weeklyImpShare.push({ date: rowDate, share: impShare });
                
                if (vol > 0) agg.queryVolumes.push(vol);
                if (impShare > 0) agg.impressionShares.push(impShare);
                if (clickShare > 0) agg.clickShares.push(clickShare);
                if (purchaseShare > 0) agg.purchaseShares.push(purchaseShare);
            });
            
            // Calculate sums and conversion rates for SQP data
            const sqpAvgMap = new Map();
            sqpAggMap.forEach((value, key) => {
                // Sum query volumes across selected weeks
                const queryVolumeSum = value.queryVolumes.reduce((a, b) => a + b, 0);
                
                // Average for share metrics
                const avg = arr => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
                
                // Calculate conversion rates from raw counts
                // Market Conv = Purchases: Total Count / Clicks: Total Count * 100
                const marketConvRate = value.clicksTotalCount > 0 
                    ? (value.purchasesTotalCount / value.clicksTotalCount) * 100 
                    : 0;
                
                // ASIN Conv = Purchases: ASIN Count / Clicks: ASIN Count * 100
                const asinConvRate = value.clicksAsinCount > 0 
                    ? (value.purchasesAsinCount / value.clicksAsinCount) * 100 
                    : 0;
                
                // Calculate CTR from raw counts
                // Market CTR = Clicks: Total Count / Impressions: Total Count * 100
                const marketCtr = value.impressionsTotalCount > 0 
                    ? (value.clicksTotalCount / value.impressionsTotalCount) * 100 
                    : 0;
                
                // ASIN CTR = Clicks: ASIN Count / Impressions: ASIN Count * 100
                const asinCtr = value.impressionsAsinCount > 0 
                    ? (value.clicksAsinCount / value.impressionsAsinCount) * 100 
                    : 0;
                
                // Calculate impression share trend
                const weeklyData = value.weeklyImpShare.sort((a, b) => new Date(a.date) - new Date(b.date));
                let impShareTrend = 'stable';
                if (weeklyData.length >= 2) {
                    const halfPoint = Math.floor(weeklyData.length / 2);
                    const firstHalf = weeklyData.slice(0, halfPoint);
                    const secondHalf = weeklyData.slice(halfPoint);
                    const firstAvg = firstHalf.reduce((s, d) => s + d.share, 0) / firstHalf.length;
                    const secondAvg = secondHalf.reduce((s, d) => s + d.share, 0) / secondHalf.length;
                    const changePercent = firstAvg > 0 ? (secondAvg - firstAvg) / firstAvg : 0;
                    if (changePercent > 0.1) impShareTrend = 'rising';
                    else if (changePercent < -0.1) impShareTrend = 'decreasing';
                }
                
                sqpAvgMap.set(key, {
                    queryVolume: queryVolumeSum,
                    marketConvRate: marketConvRate,
                    asinConvRate: asinConvRate,
                    marketCtr: marketCtr,
                    asinCtr: asinCtr,
                    ctrDelta: asinCtr - marketCtr,
                    purchaseShare: avg(value.purchaseShares),
                    impressionShare: avg(value.impressionShares),
                    clickShare: avg(value.clickShares),
                    clickPriceAsin: avg(value.clickPriceAsin),
                    clickPriceMarket: avg(value.clickPriceMarket),
                    weeklyImpShare: weeklyData,
                    impShareTrend: impShareTrend
                });
            });
            
            // 4. Combine ST data with SQP data - ONLY include rows with SQP data
            sqpCombinedData = [];
            sqpAllAsins = new Set();
            
            stAggMap.forEach((stData, key) => {
                const sqpMatch = sqpAvgMap.get(key);
                
                // Only include rows that have SQP data
                if (!sqpMatch) return;
                
                // Calculate ACOS, CPC, CVR from SP data
                const acos = stData.sales > 0 ? stData.spend / stData.sales : (stData.spend > 0 ? Infinity : 0);
                const cpc = stData.clicks > 0 ? stData.spend / stData.clicks : 0;
                const spCvr = stData.clicks > 0 ? (stData.orders / stData.clicks) * 100 : 0; // SP conversion rate in %
                
                // Use SQP-calculated rates (from Purchases Count / Clicks Count)
                const asinConvRate = sqpMatch.asinConvRate;
                const marketConvRate = sqpMatch.marketConvRate;
                const convDelta = marketConvRate > 0 ? asinConvRate - marketConvRate : null;
                
                sqpAllAsins.add(stData.asin);
                
                sqpCombinedData.push({
                    asin: stData.asin,
                    sku: asinToSkuMapping.get(stData.asin) || '',
                    searchTerm: stData.searchTerm,
                    campaign: stData.campaign,
                    portfolio: stData.portfolio,
                    // SP metrics
                    impressions: stData.impressions,
                    clicks: stData.clicks,
                    spend: stData.spend,
                    sales: stData.sales,
                    orders: stData.orders,
                    units: stData.units,
                    acos: acos,
                    cpc: cpc,
                    spCvr: spCvr,
                    // SQP metrics
                    hasSqpData: true,
                    queryVolume: sqpMatch.queryVolume,
                    marketConvRate: marketConvRate,
                    asinConvRate: asinConvRate,
                    convDelta: convDelta,
                    // CTR metrics
                    asinCtr: sqpMatch.asinCtr,
                    marketCtr: sqpMatch.marketCtr,
                    ctrDelta: sqpMatch.ctrDelta,
                    // Click median prices
                    clickPriceAsin: sqpMatch.clickPriceAsin,
                    clickPriceMarket: sqpMatch.clickPriceMarket,
                    // Impression share
                    impressionShareSqp: sqpMatch.impressionShare,
                    weeklyImpShare: sqpMatch.weeklyImpShare,
                    impShareTrend: sqpMatch.impShareTrend
                });
            });
            
            // Populate ASIN filter
            populateSqpFilters();
            
            // Build SP rank mapping from impression share data
            buildSpRankMapping();
            
            console.log(`Combined data: ${sqpCombinedData.length} rows, ${sqpAllAsins.size} unique ASINs`);
        }
        
        // SP Rank mapping - defined globally for cross-tab access
        
        function buildSpRankMapping() {
            spRankMapping.clear();
            
            if (!parsedData.impressionShare || parsedData.impressionShare.length === 0) {
                console.log('No impression share data available for SP rank mapping');
                return;
            }
            
            console.log(`Building SP rank mapping from ${parsedData.impressionShare.length} impression share rows`);
            
            // Build mapping: search term (normalized) -> array of { date, rank }
            let validRows = 0;
            parsedData.impressionShare.forEach(row => {
                const searchTerm = (row['Customer Search Term'] || '').toLowerCase().trim();
                if (!searchTerm) return;
                
                const dateStr = row['Date'] || '';
                const date = parseDateString(dateStr);
                if (!date) return;
                
                const rank = parseInt(row['Search Term Impression Rank']) || 0;
                if (rank === 0) return;
                
                validRows++;
                
                if (!spRankMapping.has(searchTerm)) {
                    spRankMapping.set(searchTerm, []);
                }
                
                spRankMapping.get(searchTerm).push({
                    date: date,
                    rank: rank
                });
            });
            
            // Sort each search term's data by date descending (newest first)
            spRankMapping.forEach((data, key) => {
                data.sort((a, b) => b.date - a.date);
            });
            
            console.log(`Built SP rank mapping: ${spRankMapping.size} unique search terms from ${validRows} valid rows`);
            
            // Log a few sample entries for debugging
            if (spRankMapping.size > 0) {
                const sampleKeys = Array.from(spRankMapping.keys()).slice(0, 3);
                console.log('Sample SP rank entries:', sampleKeys);
            }
        }
        
        function getSpRankStats(searchTerm, endDate) {
            const normalized = (searchTerm || '').toLowerCase().trim();
            const rankData = spRankMapping.get(normalized);
            
            if (!rankData || rankData.length === 0) {
                return { avg7d: null, avg14d: null, avg30d: null, bestRank: null, dailyData: [], trend: 'stable' };
            }
            
            // Filter data up to endDate
            const filteredData = rankData.filter(d => d.date <= endDate);
            
            if (filteredData.length === 0) {
                return { avg7d: null, avg14d: null, avg30d: null, bestRank: null, dailyData: [], trend: 'stable' };
            }
            
            // Calculate date thresholds
            const d7 = new Date(endDate);
            d7.setDate(d7.getDate() - 7);
            const d14 = new Date(endDate);
            d14.setDate(d14.getDate() - 14);
            const d30 = new Date(endDate);
            d30.setDate(d30.getDate() - 30);
            
            // Get ranks for each period
            const ranks7d = filteredData.filter(d => d.date >= d7).map(d => d.rank);
            const ranks14d = filteredData.filter(d => d.date >= d14).map(d => d.rank);
            const ranks30d = filteredData.filter(d => d.date >= d30).map(d => d.rank);
            const dailyData30d = filteredData.filter(d => d.date >= d30).sort((a, b) => a.date - b.date);
            
            // Calculate averages and best rank
            const avg = arr => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : null;
            const best = arr => arr.length > 0 ? Math.min(...arr) : null;
            
            // Calculate trend (compare first half vs second half of 30d data)
            // For rank, lower is better, so if second half avg < first half avg, it's improving
            let trend = 'stable';
            if (dailyData30d.length >= 4) {
                const halfPoint = Math.floor(dailyData30d.length / 2);
                const firstHalf = dailyData30d.slice(0, halfPoint);
                const secondHalf = dailyData30d.slice(halfPoint);
                const firstAvg = firstHalf.reduce((s, d) => s + d.rank, 0) / firstHalf.length;
                const secondAvg = secondHalf.reduce((s, d) => s + d.rank, 0) / secondHalf.length;
                const change = secondAvg - firstAvg;
                // For rank, negative change means improvement (lower rank is better)
                if (change <= -1) {
                    trend = 'improving'; // Rank decreased = better position
                } else if (change >= 1) {
                    trend = 'declining'; // Rank increased = worse position
                }
            }
            
            return {
                avg7d: avg(ranks7d),
                avg14d: avg(ranks14d),
                avg30d: avg(ranks30d),
                bestRank: best(ranks30d),
                dailyData: dailyData30d,
                trend: trend
            };
        }
        
        function renderSpRankChart(searchTerm, idx) {
            const spRankStats = getSpRankStats(searchTerm, currentSqpEndDate);
            
            if (!spRankStats.dailyData || spRankStats.dailyData.length === 0) {
                return '-';
            }
            
            const dailyData = spRankStats.dailyData;
            const trend = spRankStats.trend;
            
            // Trend indicator - for rank, lower is better
            let trendIcon = '';
            let trendColor = '#6b7280';
            if (trend === 'improving') {
                trendIcon = '';
                trendColor = '#10b981'; // Green - improving (lower rank)
            } else if (trend === 'declining') {
                trendIcon = '';
                trendColor = '#ef4444'; // Red - declining (higher rank)
            }
            
            // Build mini bar chart (inverted - lower rank = taller bar)
            const maxRank = Math.max(...dailyData.map(d => d.rank), 1);
            const minRank = Math.min(...dailyData.map(d => d.rank), 1);
            const range = maxRank - minRank + 1;
            
            // Show last 14 days max for mini chart
            const chartData = dailyData.slice(-14);
            const barWidth = Math.max(3, Math.floor(50 / chartData.length));
            
            const bars = chartData.map(d => {
                // Invert so rank 1 is tallest, higher rank is shorter
                const normalizedHeight = (maxRank - d.rank + 1) / range;
                const height = Math.max(2, normalizedHeight * 18);
                // Color based on rank - green for top 5, yellow for 6-15, red for 16+
                let barColor = '#10b981'; // Green for rank 1-5
                if (d.rank > 15) barColor = '#ef4444'; // Red for rank 16+
                else if (d.rank > 5) barColor = '#f59e0b'; // Yellow for rank 6-15
                return '<div style="width:' + barWidth + 'px;height:' + height + 'px;background:' + barColor + ';border-radius:1px;"></div>';
            }).join('');
            
            return '<div class="sqp-rank-chart-cell" onclick="openSpRankModal(\'' + escapeHtml(searchTerm) + '\', ' + idx + ')" style="cursor:pointer;display:flex;align-items:center;gap:4px;" title="Click for details">' +
                '<div style="display:flex;align-items:flex-end;gap:1px;height:18px;">' + bars + '</div>' +
                '<span style="color:' + trendColor + ';font-weight:700;font-size:0.75rem;">' + trendIcon + '</span>' +
            '</div>';
        }
        
        function openSpRankModal(searchTerm, idx) {
            const spRankStats = getSpRankStats(searchTerm, currentSqpEndDate);
            
            if (!spRankStats.dailyData || spRankStats.dailyData.length === 0) {
                return;
            }
            
            const dailyData = spRankStats.dailyData;
            const trend = spRankStats.trend;
            
            // Calculate stats
            const ranks = dailyData.map(d => d.rank);
            const avg = ranks.reduce((a, b) => a + b, 0) / ranks.length;
            const best = Math.min(...ranks);
            const worst = Math.max(...ranks);
            
            // Calculate change
            let changeValue = 0;
            if (dailyData.length >= 2) {
                const halfPoint = Math.floor(dailyData.length / 2);
                const firstHalf = dailyData.slice(0, halfPoint);
                const secondHalf = dailyData.slice(halfPoint);
                const firstAvg = firstHalf.reduce((s, d) => s + d.rank, 0) / firstHalf.length;
                const secondAvg = secondHalf.reduce((s, d) => s + d.rank, 0) / secondHalf.length;
                changeValue = secondAvg - firstAvg;
            }
            
            let trendClass = 'stable';
            let trendArrow = '';
            // For rank, negative change = improvement
            if (trend === 'improving') {
                trendClass = 'up';
                trendArrow = '';
            } else if (trend === 'declining') {
                trendClass = 'down';
                trendArrow = '';
            }
            
            // Use existing chart modal
            const modal = document.getElementById('chartModal');
            const titleEl = document.getElementById('chartModalTitle');
            const subtitleEl = document.getElementById('chartModalSubtitle');
            const statsEl = document.getElementById('chartModalStats');
            
            titleEl.textContent = ' SP Impression Rank';
            subtitleEl.textContent = searchTerm;
            
            statsEl.innerHTML = 
                '<div class="chart-modal-stat">' +
                    '<span class="chart-modal-stat-label">Average Rank</span>' +
                    '<span class="chart-modal-stat-value" style="color:#0891b2">' + avg.toFixed(1) + '</span>' +
                '</div>' +
                '<div class="chart-modal-stat">' +
                    '<span class="chart-modal-stat-label">Best Rank</span>' +
                    '<span class="chart-modal-stat-value" style="color:#10b981">' + best + '</span>' +
                '</div>' +
                '<div class="chart-modal-stat">' +
                    '<span class="chart-modal-stat-label">Worst Rank</span>' +
                    '<span class="chart-modal-stat-value" style="color:#ef4444">' + worst + '</span>' +
                '</div>' +
                '<div class="chart-modal-stat">' +
                    '<span class="chart-modal-stat-label">Trend</span>' +
                    '<span class="chart-modal-stat-value">' +
                        '<span class="chart-modal-stat-trend ' + trendClass + '">' + trendArrow + ' ' + (changeValue <= 0 ? '' : '+') + changeValue.toFixed(1) + '</span>' +
                    '</span>' +
                '</div>' +
                '<div class="chart-modal-stat">' +
                    '<span class="chart-modal-stat-label">Days</span>' +
                    '<span class="chart-modal-stat-value">' + dailyData.length + ' days</span>' +
                '</div>';
            
            // Render chart
            renderSpRankDetailChart(dailyData);
            
            // Show modal
            modal.classList.add('show');
            document.addEventListener('keydown', handleModalEscape);
            modal.addEventListener('click', handleModalOverlayClick);
        }
        
        function renderSpRankDetailChart(dailyData) {
            const canvas = document.getElementById('chartModalCanvas');
            const ctx = canvas.getContext('2d');
            
            if (chartModalInstance) {
                chartModalInstance.destroy();
            }
            
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const labels = dailyData.map(d => {
                const date = d.date;
                return months[date.getMonth()] + ' ' + date.getDate();
            });
            const values = dailyData.map(d => d.rank);
            
            // For rank, lower is better, so we'll use a reversed y-axis
            chartModalInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Rank',
                        data: values,
                        borderColor: '#0891b2',
                        backgroundColor: 'rgba(8, 145, 178, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: values.map(v => {
                            if (v <= 5) return '#10b981';
                            if (v <= 15) return '#f59e0b';
                            return '#ef4444';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            reverse: true, // Lower rank = better = higher on chart
                            beginAtZero: false,
                            min: 1,
                            title: {
                                display: true,
                                text: 'Rank (lower is better)'
                            },
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return '#' + value;
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Rank: #' + context.raw;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Expose rank functions globally
        window.openSpRankModal = openSpRankModal;
        window.renderSpRankChart = renderSpRankChart;
        
        function populateSqpFilters() {
            const asins = Array.from(sqpAllAsins).sort();
            
            // Initialize selected ASINs (all selected by default)
            sqpSelectedAsins = new Set(asins);
            
            // Populate ASIN filter options
            const asinOptionsContainer = document.getElementById('sqpAsinFilterOptions');
            asinOptionsContainer.innerHTML = asins.map(asin => `
                <label class="sqp-asin-option" data-asin="${asin}">
                    <input type="checkbox" value="${asin}" checked onchange="toggleSqpAsin('${asin}')">
                    <span>${asin}</span>
                </label>
            `).join('');
            
            updateAsinFilterLabel();
            
            // Setup ASIN dropdown toggle
            const asinTrigger = document.getElementById('sqpAsinFilterTrigger');
            const asinWrapper = document.getElementById('sqpAsinFilterWrapper');
            
            asinTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                asinWrapper.classList.toggle('open');
                // Close week filter if open
                document.querySelector('.sqp-week-filter-wrapper')?.classList.remove('open');
            });
            
            // Setup ASIN search
            const asinSearch = document.getElementById('sqpAsinFilterSearch');
            asinSearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#sqpAsinFilterOptions .sqp-asin-option').forEach(opt => {
                    const asin = opt.dataset.asin.toLowerCase();
                    opt.classList.toggle('hidden', !asin.includes(searchTerm));
                });
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!asinWrapper.contains(e.target)) {
                    asinWrapper.classList.remove('open');
                }
            });
                
            // Add event listeners for other filters
            document.getElementById('sqpMinVolume').addEventListener('input', debounce(renderSqpTable, 300));
            document.getElementById('sqpMinSpend').addEventListener('input', debounce(renderSqpTable, 300));
            document.getElementById('sqpConvDeltaFilter').addEventListener('change', renderSqpTable);
        }
        
        // ASIN filter state
        let sqpSelectedAsins = new Set();
        
        function toggleSqpAsin(asin) {
            if (sqpSelectedAsins.has(asin)) {
                sqpSelectedAsins.delete(asin);
            } else {
                sqpSelectedAsins.add(asin);
            }
            updateAsinFilterLabel();
            renderSqpTable();
        }
        
        function sqpSelectAllAsins() {
            const visibleAsins = [];
            document.querySelectorAll('#sqpAsinFilterOptions .sqp-asin-option:not(.hidden)').forEach(opt => {
                const asin = opt.dataset.asin;
                visibleAsins.push(asin);
                sqpSelectedAsins.add(asin);
                opt.querySelector('input').checked = true;
            });
            updateAsinFilterLabel();
            renderSqpTable();
        }
        
        function sqpDeselectAllAsins() {
            document.querySelectorAll('#sqpAsinFilterOptions .sqp-asin-option:not(.hidden)').forEach(opt => {
                const asin = opt.dataset.asin;
                sqpSelectedAsins.delete(asin);
                opt.querySelector('input').checked = false;
            });
            updateAsinFilterLabel();
            renderSqpTable();
        }
        
        function updateAsinFilterLabel() {
            const label = document.getElementById('sqpAsinFilterLabel');
            const total = sqpAllAsins.size;
            const selected = sqpSelectedAsins.size;
            
            if (selected === 0) {
                label.textContent = 'No ASINs selected';
            } else if (selected === total) {
                label.textContent = `All ASINs (${total})`;
            } else if (selected <= 2) {
                label.textContent = Array.from(sqpSelectedAsins).slice(0, 2).join(', ');
            } else {
                label.textContent = `${selected} of ${total} ASINs`;
            }
        }
        
        function renderSqpTable() {
            // Rebuild SP rank mapping if impression share data exists but mapping is empty
            if (spRankMapping.size === 0 && parsedData.impressionShare && parsedData.impressionShare.length > 0) {
                buildSpRankMapping();
            }
            
            const minVolume = parseFloat(document.getElementById('sqpMinVolume').value) || 0;
            const minSpend = parseFloat(document.getElementById('sqpMinSpend').value) || 0;
            const convDeltaFilter = document.getElementById('sqpConvDeltaFilter').value;
            
            // Filter data using multi-select ASIN filter
            let filtered = sqpCombinedData.filter(row => {
                // ASIN filter: if no ASINs selected or ASIN is in selected set
                if (sqpSelectedAsins.size > 0 && !sqpSelectedAsins.has(row.asin)) return false;
                if (row.queryVolume < minVolume) return false;
                if (row.spend < minSpend) return false;
                if (convDeltaFilter === 'positive' && (row.convDelta === null || row.convDelta <= 0)) return false;
                if (convDeltaFilter === 'negative' && (row.convDelta === null || row.convDelta >= 0)) return false;
                return true;
            });
            
            // Sort
            filtered = sortSqpData(filtered);
            
            // Summary stats
            const totalRows = filtered.length;
            const totalSpend = filtered.reduce((s, r) => s + r.spend, 0);
            const totalSales = filtered.reduce((s, r) => s + r.sales, 0);
            const positiveConvDelta = filtered.filter(r => r.convDelta !== null && r.convDelta > 0).length;
            const negativeConvDelta = filtered.filter(r => r.convDelta !== null && r.convDelta < 0).length;
            
            // Get selected week range for display
            let weekRangeDisplay = '';
            let sqpEndDate = new Date(); // Default to today
            if (sqpSelectedWeeks.size > 0 && sqpAllWeeks.length > 0) {
                const selectedWeeksList = sqpAllWeeks.filter(w => sqpSelectedWeeks.has(w.date));
                if (selectedWeeksList.length > 0) {
                    const sortedWeeks = [...selectedWeeksList].sort((a, b) => new Date(a.date) - new Date(b.date));
                    const firstWeek = sortedWeeks[0];
                    const lastWeek = sortedWeeks[sortedWeeks.length - 1];
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    weekRangeDisplay = `${months[firstWeek.startDate.getMonth()]} ${firstWeek.startDate.getDate()} - ${months[lastWeek.endDate.getMonth()]} ${lastWeek.endDate.getDate()}, ${lastWeek.endDate.getFullYear()}`;
                    // Set sqpEndDate to the end of the last selected week
                    sqpEndDate = new Date(lastWeek.endDate);
                }
            }
            
            // Update global for sorting
            currentSqpEndDate = sqpEndDate;
            
            document.getElementById('sqpSummaryBar').innerHTML = `
                <div class="is-summary-item">
                    <span class="is-summary-label"> SQP Data Range:</span>
                    <span class="is-summary-value">${weekRangeDisplay || 'No weeks selected'} (${sqpSelectedWeeks.size} weeks)</span>
                </div>
                <div class="is-summary-item">
                    <span class="is-summary-label">Search Terms:</span>
                    <span class="is-summary-value">${formatNumber(totalRows)}</span>
                </div>
                <div class="is-summary-item">
                    <span class="is-summary-label"> Above Market:</span>
                    <span class="is-summary-value" style="color:#4ade80">${formatNumber(positiveConvDelta)}</span>
                </div>
                <div class="is-summary-item">
                    <span class="is-summary-label"> Below Market:</span>
                    <span class="is-summary-value" style="color:#f87171">${formatNumber(negativeConvDelta)}</span>
                </div>
                <div class="is-summary-item">
                    <span class="is-summary-label">Total Spend:</span>
                    <span class="is-summary-value">${formatCurrencyDecimal(totalSpend)}</span>
                </div>
                <div class="is-summary-item">
                    <span class="is-summary-label">Total Sales:</span>
                    <span class="is-summary-value">${formatCurrencyDecimal(totalSales)}</span>
                </div>
                <div class="is-summary-item">
                    <span class="is-summary-label">Total Query Volume:</span>
                    <span class="is-summary-value">${formatNumber(Math.round(filtered.reduce((s, r) => s + r.queryVolume, 0)))}</span>
                </div>
                <div class="is-summary-item">
                    <span class="is-summary-label"> SP Rank Data:</span>
                    <span class="is-summary-value">${spRankMapping.size > 0 
                        ? '<span style="color:#4ade80"> ' + spRankMapping.size + ' terms</span> <a href="#" onclick="buildSpRankMapping();renderSqpTable();return false;" style="color:#60a5fa;font-size:0.7rem;margin-left:0.5rem;">(refresh)</a>' 
                        : (parsedData.impressionShare && parsedData.impressionShare.length > 0 
                            ? '<a href="#" onclick="buildSpRankMapping();renderSqpTable();return false;" style="color:#60a5fa;text-decoration:underline;">Click to load ' + parsedData.impressionShare.length + ' rows</a>' 
                            : '<span style="color:#f87171"> Upload Impression Share CSV first</span>')}</span>
                </div>
            `;
            
            // Build table
            const tableContainer = document.getElementById('sqpTableContainer');
            
            if (filtered.length === 0) {
                tableContainer.innerHTML = '<div class="insight-empty">No data matching the filters</div>';
                return;
            }
            
            tableContainer.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th colspan="3" class="sqp-header-group" style="border-right:2px solid rgba(255,255,255,0.3)">Search Term</th>
                            <th colspan="10" class="sqp-header-group" style="background:linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%)">SQP Aggregated Weekly Report</th>
                            <th colspan="5" class="sqp-header-group" style="background:linear-gradient(135deg, #0891b2 0%, #22d3ee 100%)">SP Impression Rank</th>
                            <th colspan="7" class="sqp-header-sp">Sponsored Products Search Term Stats</th>
                        </tr>
                        <tr>
                            <th class="sqp-sticky-col sortable-header" onclick="sortSqp('searchTerm')" style="min-width:180px">Keyword ${getSqpSortIcon('searchTerm')}</th>
                            <th class="sortable-header" onclick="sortSqp('asin')">ASIN ${getSqpSortIcon('asin')}</th>
                            <th class="sortable-header" onclick="sortSqp('sku')">SKU ${getSqpSortIcon('sku')}</th>
                            <th class="sortable-header" onclick="sortSqp('queryVolume')">Query Vol ${getSqpSortIcon('queryVolume')}</th>
                            <th class="sortable-header" onclick="sortSqp('marketConvRate')">Market Conv ${getSqpSortIcon('marketConvRate')}</th>
                            <th class="sortable-header" onclick="sortSqp('asinConvRate')">ASIN Conv ${getSqpSortIcon('asinConvRate')}</th>
                            <th class="sortable-header" onclick="sortSqp('convDelta')">Conv Delta ${getSqpSortIcon('convDelta')}</th>
                            <th class="sortable-header" onclick="sortSqp('asinCtr')">ASIN CTR ${getSqpSortIcon('asinCtr')}</th>
                            <th class="sortable-header" onclick="sortSqp('marketCtr')">Mkt CTR ${getSqpSortIcon('marketCtr')}</th>
                            <th class="sortable-header" onclick="sortSqp('ctrDelta')">CTR  ${getSqpSortIcon('ctrDelta')}</th>
                            <th class="sortable-header" onclick="sortSqp('clickPriceMarket')">Price (Mkt) ${getSqpSortIcon('clickPriceMarket')}</th>
                            <th class="sortable-header" onclick="sortSqp('clickPriceAsin')">Price (ASIN) ${getSqpSortIcon('clickPriceAsin')}</th>
                            <th class="sortable-header" onclick="sortSqp('impressionShareSqp')">Imp Share ${getSqpSortIcon('impressionShareSqp')}</th>
                            <th title="Rank Trend Chart (click for details)">Rank Trend</th>
                            <th class="sortable-header" onclick="sortSqp('spRank7d')" title="7 Day Average Rank">7d Avg ${getSqpSortIcon('spRank7d')}</th>
                            <th class="sortable-header" onclick="sortSqp('spRank14d')" title="14 Day Average Rank">14d Avg ${getSqpSortIcon('spRank14d')}</th>
                            <th class="sortable-header" onclick="sortSqp('spRank30d')" title="30 Day Average Rank">30d Avg ${getSqpSortIcon('spRank30d')}</th>
                            <th class="sortable-header" onclick="sortSqp('spRankBest')" title="Best Rank in 30 Days">Best ${getSqpSortIcon('spRankBest')}</th>
                            <th class="sortable-header" onclick="sortSqp('sales')">Sales ${getSqpSortIcon('sales')}</th>
                            <th class="sortable-header" onclick="sortSqp('acos')">ACOS ${getSqpSortIcon('acos')}</th>
                            <th class="sortable-header" onclick="sortSqp('spend')">Spend ${getSqpSortIcon('spend')}</th>
                            <th class="sortable-header" onclick="sortSqp('units')">Units ${getSqpSortIcon('units')}</th>
                            <th class="sortable-header" onclick="sortSqp('cvr')">CVR % ${getSqpSortIcon('cvr')}</th>
                            <th class="sortable-header" onclick="sortSqp('cpc')">CPC ${getSqpSortIcon('cpc')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.slice(0, 300).map((row, idx) => {
                            const convDeltaClass = row.convDelta !== null ? 
                                (row.convDelta > 0 ? 'conv-delta-positive' : (row.convDelta < 0 ? 'conv-delta-negative' : '')) : '';
                            const ctrDeltaClass = row.ctrDelta > 0 ? 'conv-delta-positive' : (row.ctrDelta < 0 ? 'conv-delta-negative' : '');
                            const marketplace = document.getElementById('marketplace')?.value || 'de';
                            const amazonUrl = 'https://www.amazon.' + marketplace + '/dp/' + row.asin;
                            const cvr = row.clicks > 0 ? (row.orders / row.clicks * 100) : 0;
                            const cvrClass = cvr >= 15 ? 'conv-delta-positive' : (cvr < 5 && cvr > 0 ? 'conv-delta-negative' : '');
                            
                            // Get SP rank stats based on SQP end date
                            const spRankStats = getSpRankStats(row.searchTerm, sqpEndDate);
                            const rankClass7d = spRankStats.avg7d !== null && spRankStats.avg7d <= 5 ? 'conv-delta-positive' : (spRankStats.avg7d !== null && spRankStats.avg7d > 20 ? 'conv-delta-negative' : '');
                            const rankClass14d = spRankStats.avg14d !== null && spRankStats.avg14d <= 5 ? 'conv-delta-positive' : (spRankStats.avg14d !== null && spRankStats.avg14d > 20 ? 'conv-delta-negative' : '');
                            const rankClass30d = spRankStats.avg30d !== null && spRankStats.avg30d <= 5 ? 'conv-delta-positive' : (spRankStats.avg30d !== null && spRankStats.avg30d > 20 ? 'conv-delta-negative' : '');
                            const rankClassBest = spRankStats.bestRank !== null && spRankStats.bestRank <= 3 ? 'conv-delta-positive' : '';
                            
                            return '<tr>' +
                                '<td class="sqp-sticky-col sqp-search-term-cell">' +
                                    '<span class="sqp-search-term-text" title="' + escapeHtml(row.searchTerm) + '">' + escapeHtml(row.searchTerm) + '</span>' +
                                '</td>' +
                                '<td><a href="' + amazonUrl + '" target="_blank" class="sqp-asin-link" title="View on Amazon">' + row.asin + '</a></td>' +
                                '<td class="sqp-sku-cell" title="' + escapeHtml(row.sku || '') + '">' + escapeHtml(row.sku || '-') + '</td>' +
                                '<td class="sqp-kpi-cell">' + formatNumber(Math.round(row.queryVolume)) + '</td>' +
                                '<td class="sqp-kpi-cell">' + row.marketConvRate.toFixed(2) + '%</td>' +
                                '<td class="sqp-kpi-cell">' + row.asinConvRate.toFixed(2) + '%</td>' +
                                '<td class="sqp-kpi-cell ' + convDeltaClass + '">' + (row.convDelta !== null ? (row.convDelta >= 0 ? '+' : '') + row.convDelta.toFixed(2) + '%' : '-') + '</td>' +
                                '<td class="sqp-kpi-cell">' + row.asinCtr.toFixed(2) + '%</td>' +
                                '<td class="sqp-kpi-cell">' + row.marketCtr.toFixed(2) + '%</td>' +
                                '<td class="sqp-kpi-cell ' + ctrDeltaClass + '">' + (row.ctrDelta >= 0 ? '+' : '') + row.ctrDelta.toFixed(2) + '%</td>' +
                                '<td class="sqp-kpi-cell">' + (row.clickPriceMarket > 0 ? formatCurrencyDecimal(row.clickPriceMarket) : '-') + '</td>' +
                                '<td class="sqp-kpi-cell">' + (row.clickPriceAsin > 0 ? formatCurrencyDecimal(row.clickPriceAsin) : '-') + '</td>' +
                                '<td class="sqp-kpi-cell">' + renderSqpImpShareChart(row, idx) + '</td>' +
                                '<td class="sqp-kpi-cell">' + renderSpRankChart(row.searchTerm, idx) + '</td>' +
                                '<td class="sqp-kpi-cell ' + rankClass7d + '">' + (spRankStats.avg7d !== null ? spRankStats.avg7d.toFixed(1) : '-') + '</td>' +
                                '<td class="sqp-kpi-cell ' + rankClass14d + '">' + (spRankStats.avg14d !== null ? spRankStats.avg14d.toFixed(1) : '-') + '</td>' +
                                '<td class="sqp-kpi-cell ' + rankClass30d + '">' + (spRankStats.avg30d !== null ? spRankStats.avg30d.toFixed(1) : '-') + '</td>' +
                                '<td class="sqp-kpi-cell ' + rankClassBest + '">' + (spRankStats.bestRank !== null ? spRankStats.bestRank : '-') + '</td>' +
                                '<td class="sqp-kpi-cell">' + formatCurrencyDecimal(row.sales) + '</td>' +
                                '<td class="sqp-kpi-cell ' + getAcosColorClass(row.acos) + '">' + (row.acos === Infinity ? '' : formatPercent(row.acos, 1)) + '</td>' +
                                '<td class="sqp-kpi-cell">' + formatCurrencyDecimal(row.spend) + '</td>' +
                                '<td class="sqp-kpi-cell">' + formatNumber(row.units) + '</td>' +
                                '<td class="sqp-kpi-cell ' + cvrClass + '">' + (cvr > 0 ? cvr.toFixed(1) + '%' : '-') + '</td>' +
                                '<td class="sqp-kpi-cell">' + formatCurrencyDecimal(row.cpc) + '</td>' +
                            '</tr>';
                        }).join('')}
                    </tbody>
                </table>
                ${filtered.length > 300 ? `<div style="padding:0.5rem;text-align:center;color:#666;font-size:0.75rem;">Showing top 300 of ${formatNumber(filtered.length)} results</div>` : ''}
            `;
        }
        
        function sortSqp(column) {
            if (sqpSortState.column === column) {
                sqpSortState.direction = sqpSortState.direction === 'desc' ? 'asc' : 'desc';
            } else {
                sqpSortState.column = column;
                sqpSortState.direction = 'desc';
            }
            renderSqpTable();
        }
        
        function getSqpSortIcon(column) {
            if (sqpSortState.column !== column) return '<span class="sort-icon"></span>';
            return sqpSortState.direction === 'desc' 
                ? '<span class="sort-icon active"></span>' 
                : '<span class="sort-icon active"></span>';
        }
        
        function sortSqpData(data) {
            const col = sqpSortState.column;
            const dir = sqpSortState.direction;
            
            return [...data].sort((a, b) => {
                let aVal, bVal;
                
                switch (col) {
                    case 'searchTerm':
                        aVal = a.searchTerm.toLowerCase();
                        bVal = b.searchTerm.toLowerCase();
                        break;
                    case 'asin':
                        aVal = a.asin;
                        bVal = b.asin;
                        break;
                    case 'sku':
                        aVal = (a.sku || '').toLowerCase();
                        bVal = (b.sku || '').toLowerCase();
                        break;
                    case 'queryVolume':
                        aVal = a.queryVolume || 0;
                        bVal = b.queryVolume || 0;
                        break;
                    case 'marketConvRate':
                        aVal = a.marketConvRate || 0;
                        bVal = b.marketConvRate || 0;
                        break;
                    case 'asinConvRate':
                        aVal = a.asinConvRate || 0;
                        bVal = b.asinConvRate || 0;
                        break;
                    case 'convDelta':
                        aVal = a.convDelta !== null ? a.convDelta : -999;
                        bVal = b.convDelta !== null ? b.convDelta : -999;
                        break;
                    case 'asinCtr':
                        aVal = a.asinCtr || 0;
                        bVal = b.asinCtr || 0;
                        break;
                    case 'marketCtr':
                        aVal = a.marketCtr || 0;
                        bVal = b.marketCtr || 0;
                        break;
                    case 'ctrDelta':
                        aVal = a.ctrDelta || 0;
                        bVal = b.ctrDelta || 0;
                        break;
                    case 'impressionShareSqp':
                        aVal = a.impressionShareSqp || 0;
                        bVal = b.impressionShareSqp || 0;
                        break;
                    case 'clickPriceAsin':
                        aVal = a.clickPriceAsin || 0;
                        bVal = b.clickPriceAsin || 0;
                        break;
                    case 'clickPriceMarket':
                        aVal = a.clickPriceMarket || 0;
                        bVal = b.clickPriceMarket || 0;
                        break;
                    case 'spend':
                        aVal = a.spend || 0;
                        bVal = b.spend || 0;
                        break;
                    case 'sales':
                        aVal = a.sales || 0;
                        bVal = b.sales || 0;
                        break;
                    case 'acos':
                        aVal = a.acos === Infinity ? 999999 : (a.acos || 0);
                        bVal = b.acos === Infinity ? 999999 : (b.acos || 0);
                        break;
                    case 'units':
                        aVal = a.units || 0;
                        bVal = b.units || 0;
                        break;
                    case 'cpc':
                        aVal = a.cpc || 0;
                        bVal = b.cpc || 0;
                        break;
                    case 'cvr':
                        aVal = a.clicks > 0 ? (a.orders / a.clicks) : 0;
                        bVal = b.clicks > 0 ? (b.orders / b.clicks) : 0;
                        break;
                    case 'spRank7d':
                        const aRank7d = getSpRankStats(a.searchTerm, currentSqpEndDate);
                        const bRank7d = getSpRankStats(b.searchTerm, currentSqpEndDate);
                        aVal = aRank7d.avg7d !== null ? aRank7d.avg7d : 9999;
                        bVal = bRank7d.avg7d !== null ? bRank7d.avg7d : 9999;
                        break;
                    case 'spRank14d':
                        const aRank14d = getSpRankStats(a.searchTerm, currentSqpEndDate);
                        const bRank14d = getSpRankStats(b.searchTerm, currentSqpEndDate);
                        aVal = aRank14d.avg14d !== null ? aRank14d.avg14d : 9999;
                        bVal = bRank14d.avg14d !== null ? bRank14d.avg14d : 9999;
                        break;
                    case 'spRank30d':
                        const aRank30d = getSpRankStats(a.searchTerm, currentSqpEndDate);
                        const bRank30d = getSpRankStats(b.searchTerm, currentSqpEndDate);
                        aVal = aRank30d.avg30d !== null ? aRank30d.avg30d : 9999;
                        bVal = bRank30d.avg30d !== null ? bRank30d.avg30d : 9999;
                        break;
                    case 'spRankBest':
                        const aRankBest = getSpRankStats(a.searchTerm, currentSqpEndDate);
                        const bRankBest = getSpRankStats(b.searchTerm, currentSqpEndDate);
                        aVal = aRankBest.bestRank !== null ? aRankBest.bestRank : 9999;
                        bVal = bRankBest.bestRank !== null ? bRankBest.bestRank : 9999;
                        break;
                    default:
                        aVal = a.spend || 0;
                        bVal = b.spend || 0;
                }
                
                if (typeof aVal === 'string') {
                    return dir === 'desc' ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
                }
                return dir === 'desc' ? bVal - aVal : aVal - bVal;
            });
        }
        
        // Make SQP functions global
        window.sortSqp = sortSqp;
        window.renderSqpTable = renderSqpTable;
        window.buildSpRankMapping = buildSpRankMapping;
        window.toggleSqpWeek = toggleSqpWeek;
        window.sqpSelectAllWeeks = sqpSelectAllWeeks;
        window.sqpDeselectAllWeeks = sqpDeselectAllWeeks;
        window.openSqpImpShareModal = openSqpImpShareModal;
        window.toggleSqpAsin = toggleSqpAsin;
        window.sqpSelectAllAsins = sqpSelectAllAsins;
        window.sqpDeselectAllAsins = sqpDeselectAllAsins;
        window.getSqpDataLoaded = function() { return sqpCombinedData && sqpCombinedData.length > 0; };
        
        // Store filtered data for modal access
        let sqpFilteredData = [];
        
        // Global variable for SQP end date (used by sorting)
        let currentSqpEndDate = new Date();
        
        function renderSqpImpShareChart(row, idx) {
            const weeklyData = row.weeklyImpShare || [];
            if (weeklyData.length === 0) {
                return `<span style="color:#999">${row.impressionShareSqp.toFixed(1)}%</span>`;
            }
            
            // Get trend
            const trend = row.impShareTrend || 'stable';
            let trendIcon = '';
            let trendColor = '#6b7280';
            if (trend === 'rising') {
                trendIcon = '';
                trendColor = '#10b981';
            } else if (trend === 'decreasing') {
                trendIcon = '';
                trendColor = '#ef4444';
            }
            
            // Build mini bar chart
            const maxShare = Math.max(...weeklyData.map(d => d.share), 1);
            const barWidth = Math.max(3, Math.floor(60 / weeklyData.length));
            
            const bars = weeklyData.map(d => {
                const height = Math.max(2, (d.share / maxShare) * 20);
                return `<div style="width:${barWidth}px;height:${height}px;background:#8b5cf6;border-radius:1px;"></div>`;
            }).join('');
            
            return `
                <div class="sqp-imp-share-cell" onclick="openSqpImpShareModal(${idx})" style="cursor:pointer;display:flex;align-items:center;gap:4px;">
                    <span style="font-weight:500">${row.impressionShareSqp.toFixed(1)}%</span>
                    <div style="display:flex;align-items:flex-end;gap:1px;height:20px;">${bars}</div>
                    <span style="color:${trendColor};font-weight:700;font-size:0.7rem;">${trendIcon}</span>
                </div>
            `;
        }
        
        function openSqpImpShareModal(idx) {
            // Get the row from current filtered data
            const minVolume = parseFloat(document.getElementById('sqpMinVolume').value) || 0;
            const minSpend = parseFloat(document.getElementById('sqpMinSpend').value) || 0;
            const convDeltaFilter = document.getElementById('sqpConvDeltaFilter').value;
            
            let filtered = sqpCombinedData.filter(row => {
                if (sqpSelectedAsins.size > 0 && !sqpSelectedAsins.has(row.asin)) return false;
                if (row.queryVolume < minVolume) return false;
                if (row.spend < minSpend) return false;
                if (convDeltaFilter === 'positive' && (row.convDelta === null || row.convDelta <= 0)) return false;
                if (convDeltaFilter === 'negative' && (row.convDelta === null || row.convDelta >= 0)) return false;
                return true;
            });
            filtered = sortSqpData(filtered);
            
            const row = filtered[idx];
            if (!row) return;
            
            const weeklyData = row.weeklyImpShare || [];
            const trend = row.impShareTrend || 'stable';
            
            // Calculate stats
            const shares = weeklyData.map(d => d.share);
            const avg = shares.length > 0 ? shares.reduce((a, b) => a + b, 0) / shares.length : 0;
            const max = shares.length > 0 ? Math.max(...shares) : 0;
            const min = shares.length > 0 ? Math.min(...shares) : 0;
            
            // Calculate change percentage
            let changePercent = 0;
            if (weeklyData.length >= 2) {
                const halfPoint = Math.floor(weeklyData.length / 2);
                const firstHalf = weeklyData.slice(0, halfPoint);
                const secondHalf = weeklyData.slice(halfPoint);
                const firstAvg = firstHalf.reduce((s, d) => s + d.share, 0) / firstHalf.length;
                const secondAvg = secondHalf.reduce((s, d) => s + d.share, 0) / secondHalf.length;
                changePercent = firstAvg > 0 ? ((secondAvg - firstAvg) / firstAvg) * 100 : 0;
            }
            
            let trendClass = 'stable';
            let trendArrow = '';
            if (trend === 'rising') {
                trendClass = 'up';
                trendArrow = '';
            } else if (trend === 'decreasing') {
                trendClass = 'down';
                trendArrow = '';
            }
            
            // Use existing chart modal
            const modal = document.getElementById('chartModal');
            const titleEl = document.getElementById('chartModalTitle');
            const subtitleEl = document.getElementById('chartModalSubtitle');
            const statsEl = document.getElementById('chartModalStats');
            
            titleEl.textContent = ' Impression Share';
            subtitleEl.textContent = `${row.searchTerm} | ${row.asin}`;
            
            statsEl.innerHTML = `
                <div class="chart-modal-stat">
                    <span class="chart-modal-stat-label">Average Imp Share</span>
                    <span class="chart-modal-stat-value" style="color:#8b5cf6">${avg.toFixed(2)}%</span>
                </div>
                <div class="chart-modal-stat">
                    <span class="chart-modal-stat-label">Maximum</span>
                    <span class="chart-modal-stat-value">${max.toFixed(2)}%</span>
                </div>
                <div class="chart-modal-stat">
                    <span class="chart-modal-stat-label">Minimum</span>
                    <span class="chart-modal-stat-value">${min.toFixed(2)}%</span>
                </div>
                <div class="chart-modal-stat">
                    <span class="chart-modal-stat-label">Trend</span>
                    <span class="chart-modal-stat-value">
                        <span class="chart-modal-stat-trend ${trendClass}">${trendArrow} ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%</span>
                    </span>
                </div>
                <div class="chart-modal-stat">
                    <span class="chart-modal-stat-label">Period</span>
                    <span class="chart-modal-stat-value">${weeklyData.length} weeks</span>
                </div>
            `;
            
            // Render chart
            renderSqpImpShareDetailChart(weeklyData);
            
            // Show modal
            modal.classList.add('show');
            document.addEventListener('keydown', handleModalEscape);
            modal.addEventListener('click', handleModalOverlayClick);
        }
        
        function renderSqpImpShareDetailChart(weeklyData) {
            const canvas = document.getElementById('chartModalCanvas');
            const ctx = canvas.getContext('2d');
            
            if (chartModalInstance) {
                chartModalInstance.destroy();
            }
            
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const labels = weeklyData.map(d => {
                const date = new Date(d.date);
                return `${months[date.getMonth()]} ${date.getDate()}`;
            });
            const values = weeklyData.map(d => d.share);
            
            chartModalInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Impression Share',
                        data: values,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: values.length > 10 ? 0 : 4,
                        pointBackgroundColor: '#8b5cf6',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            callbacks: {
                                label: function(context) {
                                    return `Imp Share: ${context.raw.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 } }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#e5e7eb' },
                            ticks: {
                                font: { size: 10 },
                                callback: function(value) {
                                    return value.toFixed(0) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
